# ä¼šå‘˜å¡å¯†ç æ”¯ä»˜å·®å¼‚åˆ†ææŠ¥å‘Š

## ğŸ“‹ åˆ†ææ¦‚è¿°

åŸºäºä¸¤ä¸ªHARæ–‡ä»¶çš„è¯¦ç»†åˆ†æï¼ŒæˆåŠŸè¯†åˆ«å‡ºä¸åŒå½±é™¢å¯¹ä¼šå‘˜å¡å¯†ç çš„ç­–ç•¥å·®å¼‚ï¼Œå¹¶åœ¨ `main_modular.py` ä¸­å®ç°äº†åŠ¨æ€å¯†ç ç­–ç•¥æ£€æµ‹å’Œä¼šå‘˜å¡æ”¯ä»˜åŠŸèƒ½ã€‚

## ğŸ” 1. å‚æ•°å¯¹æ¯”åˆ†æ

### 1.1 å…³é”®å·®å¼‚å­—æ®µ

| å½±é™¢ç±»å‹ | åŸŸå | enable_mempassword | å¯†ç è¦æ±‚ |
|---------|------|-------------------|----------|
| é»‘ç™½å½±ä¸š | www.heibaiyingye.cn | `"1"` | âœ… éœ€è¦å¯†ç  |
| åŸå¸‚å½±é™¢ | zcxzs7.cityfilms.cn | `"0"` | âŒ ä¸éœ€è¦å¯†ç  |

### 1.2 è®¢å•è¯¦æƒ…APIå“åº”å¯¹æ¯”

**éœ€è¦å¯†ç çš„å½±é™¢ (é»‘ç™½å½±ä¸š):**
```json
{
  "orderno": "202506041622286072385",
  "cinemaName": "åå¤ä¼˜åŠ èŸå¤§éƒ½èŸ",
  "orderPrice": "3390",
  "payAmount": "3390", 
  "mem_totalprice": "2500",
  "enable_mempassword": "1",  // å…³é”®å­—æ®µ
  "memPayONLY": "0"
}
```

**ä¸éœ€è¦å¯†ç çš„å½±é™¢ (åŸå¸‚å½±é™¢):**
```json
{
  "orderno": "202506041623130951917",
  "cinemaName": "æ·±åœ³ä¸‡å‹å½±åŸIBCMallåº—",
  "orderPrice": "4200",
  "payAmount": "4200",
  "mem_totalprice": "4000", 
  "enable_mempassword": "0",  // å…³é”®å­—æ®µ
  "memPayONLY": "0"
}
```

## ğŸ¯ 2. ä¼šå‘˜å¡æ”¯ä»˜ç±»å‹è¯†åˆ«

### 2.1 åˆ¤æ–­é€»è¾‘
```python
def detect_member_password_policy(order_detail: dict) -> bool:
    enable_mempassword = order_detail.get('enable_mempassword', '1')
    return enable_mempassword == '1'
```

### 2.2 è§¦å‘æ¡ä»¶
- **éœ€è¦å¯†ç **: `enable_mempassword == "1"`
- **ä¸éœ€è¦å¯†ç **: `enable_mempassword == "0"`
- **é»˜è®¤ç­–ç•¥**: å½“å­—æ®µç¼ºå¤±æ—¶ï¼Œé»˜è®¤éœ€è¦å¯†ç ï¼ˆå®‰å…¨è€ƒè™‘ï¼‰

## ğŸ› ï¸ 3. å®ç°æ–¹æ¡ˆ

### 3.1 æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 3.1.1 å¯†ç ç­–ç•¥æ£€æµ‹
```python
def detect_member_password_policy(self, order_detail: dict) -> bool:
    """æ£€æµ‹ä¼šå‘˜å¡å¯†ç ç­–ç•¥"""
    enable_mempassword = order_detail.get('enable_mempassword', '1')
    self.member_password_required = (enable_mempassword == '1')
    return self.member_password_required
```

#### 3.1.2 å¯†ç è¾“å…¥ç•Œé¢
```python
def get_member_password_input(self) -> str:
    """è·å–ä¼šå‘˜å¡å¯†ç è¾“å…¥"""
    password, ok = QInputDialog.getText(
        self, "ä¼šå‘˜å¡å¯†ç ", "è¯·è¾“å…¥ä¼šå‘˜å¡å¯†ç :", QLineEdit.Password
    )
    return password if ok and password else None
```

#### 3.1.3 æ”¯ä»˜å‚æ•°åŠ¨æ€æ„å»º
```python
# åŸºç¡€æ”¯ä»˜å‚æ•°
pay_params = {
    'orderno': order_id,
    'payprice': pay_amount,
    'userid': account['userid'],
    'token': account['token'],
    # ... å…¶ä»–å‚æ•°
}

# æ ¹æ®å¯†ç ç­–ç•¥æ·»åŠ å¯†ç å‚æ•°
if requires_password and member_password:
    pay_params['mempass'] = member_password
```

### 3.2 é›†æˆåˆ°ä¸€é”®æ”¯ä»˜æµç¨‹

#### 3.2.1 æ”¯ä»˜å‰æ£€æµ‹
```python
def on_one_click_pay(self):
    # 1. æ£€æµ‹å¯†ç ç­–ç•¥
    password_policy_result = self.validate_member_password_policy(order_id)
    requires_password = password_policy_result.get('requires_password', False)
    
    # 2. è·å–å¯†ç è¾“å…¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if requires_password:
        member_password = self.get_member_password_input()
        if not member_password:
            return  # ç”¨æˆ·å–æ¶ˆ
    
    # 3. æ„å»ºæ”¯ä»˜å‚æ•°
    pay_params = self._build_payment_params(requires_password, member_password)
    
    # 4. æ‰§è¡Œæ”¯ä»˜
    result = pay_order(pay_params)
```

## ğŸ§ª 4. æµ‹è¯•éªŒè¯

### 4.1 æµ‹è¯•ç»“æœ
```
âœ… å¯†ç ç­–ç•¥æ£€æµ‹åŠŸèƒ½æ­£å¸¸
  - é»‘ç™½å½±ä¸šæ­£ç¡®è¯†åˆ«ä¸ºéœ€è¦å¯†ç 
  - åŸå¸‚å½±é™¢æ­£ç¡®è¯†åˆ«ä¸ºä¸éœ€è¦å¯†ç 

âœ… æ”¯ä»˜å‚æ•°ç”Ÿæˆæ­£ç¡®
  - éœ€è¦å¯†ç çš„å‚æ•°åŒ…å«mempass: True
  - ä¸éœ€è¦å¯†ç çš„å‚æ•°åŒ…å«mempass: False

âœ… å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•é€šè¿‡
```

### 4.2 å…³é”®éªŒè¯ç‚¹
1. **å¯†ç ç­–ç•¥æ£€æµ‹**: åŸºäº `enable_mempassword` å­—æ®µå‡†ç¡®åˆ¤æ–­
2. **å‚æ•°åŠ¨æ€ç”Ÿæˆ**: æ ¹æ®ç­–ç•¥åŠ¨æ€æ·»åŠ /æ’é™¤ `mempass` å‚æ•°
3. **ç”¨æˆ·ä½“éªŒ**: åªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
4. **å®‰å…¨æ€§**: å¯†ç åœ¨æ—¥å¿—ä¸­è¢«éšè—ï¼Œé»˜è®¤ç­–ç•¥åå‘å®‰å…¨

## ğŸ“Š 5. å®ç°ç‰¹æ€§

### 5.1 æ ¸å¿ƒç‰¹æ€§
- âœ… **åŠ¨æ€æ£€æµ‹**: å®æ—¶ä»è®¢å•è¯¦æƒ…APIè·å–å¯†ç ç­–ç•¥
- âœ… **ç”¨æˆ·å‹å¥½**: åªåœ¨éœ€è¦æ—¶æ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
- âœ… **å®‰å…¨å¯é **: å¯†ç ä¸åœ¨æ—¥å¿—ä¸­è®°å½•ï¼Œé»˜è®¤éœ€è¦å¯†ç 
- âœ… **é”™è¯¯å¤„ç†**: å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·æç¤º
- âœ… **å‘åå…¼å®¹**: ä¸å½±å“ç°æœ‰æ”¯ä»˜æµç¨‹

### 5.2 æŠ€æœ¯äº®ç‚¹
1. **APIé©±åŠ¨**: åŸºäºçœŸå®APIå“åº”åŠ¨æ€å†³ç­–
2. **çŠ¶æ€ç®¡ç†**: å®Œæ•´çš„å¯†ç ç­–ç•¥çŠ¶æ€è·Ÿè¸ª
3. **äº‹ä»¶é›†æˆ**: ä¸ç°æœ‰äº‹ä»¶æ€»çº¿æ— ç¼é›†æˆ
4. **æ¨¡å—åŒ–è®¾è®¡**: ç‹¬ç«‹çš„å¯†ç ç­–ç•¥æ£€æµ‹æ¨¡å—

## ğŸ¯ 6. ä½¿ç”¨æŒ‡å—

### 6.1 å¼€å‘è€…ä½¿ç”¨
```python
# æ£€æµ‹å¯†ç ç­–ç•¥
policy_result = self.validate_member_password_policy(order_id)
requires_password = policy_result.get('requires_password', False)

# è·å–å¯†ç è¾“å…¥
if requires_password:
    password = self.get_member_password_input()

# æ„å»ºæ”¯ä»˜å‚æ•°
pay_params = self._build_payment_params(requires_password, password)
```

### 6.2 ç”¨æˆ·ä½“éªŒ
1. ç”¨æˆ·é€‰æ‹©å½±é™¢å’Œåœºæ¬¡
2. ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹è¯¥å½±é™¢çš„å¯†ç ç­–ç•¥
3. å¦‚éœ€å¯†ç ï¼Œåœ¨æ”¯ä»˜æ—¶å¼¹å‡ºå¯†ç è¾“å…¥æ¡†
4. å¦‚ä¸éœ€å¯†ç ï¼Œç›´æ¥è¿›è¡Œæ”¯ä»˜

## ğŸ“ˆ 7. æ‰©å±•æ€§

### 7.1 æ”¯æŒçš„æ‰©å±•
- å¯æ·»åŠ æ›´å¤šå¯†ç ç­–ç•¥å­—æ®µæ£€æµ‹
- å¯é›†æˆæŒ‡çº¹/é¢éƒ¨è¯†åˆ«ç­‰ç”Ÿç‰©è®¤è¯
- å¯æ·»åŠ å¯†ç å¼ºåº¦éªŒè¯
- å¯æ”¯æŒå¤šç§ä¼šå‘˜å¡ç±»å‹

### 7.2 é…ç½®åŒ–æ”¯æŒ
```python
# å¯é…ç½®çš„å¯†ç ç­–ç•¥
PASSWORD_POLICY_CONFIG = {
    'default_requires_password': True,
    'enable_biometric_auth': False,
    'password_min_length': 6,
    'max_retry_attempts': 3
}
```

## ğŸ”’ 8. å®‰å…¨è€ƒè™‘

1. **å¯†ç ä¿æŠ¤**: å¯†ç åœ¨å†…å­˜ä¸­ä¸é•¿æœŸä¿å­˜
2. **æ—¥å¿—å®‰å…¨**: å¯†ç åœ¨æ—¥å¿—ä¸­è¢«æ˜Ÿå·æ›¿æ¢
3. **é»˜è®¤å®‰å…¨**: æ£€æµ‹å¤±è´¥æ—¶é»˜è®¤éœ€è¦å¯†ç 
4. **è¾“å…¥éªŒè¯**: å¯†ç è¾“å…¥æ¡†ä½¿ç”¨å¯†ç æ¨¡å¼
5. **é”™è¯¯å¤„ç†**: å¯†ç é”™è¯¯æ—¶æä¾›æ˜ç¡®æç¤º

## ğŸ“ 9. æ€»ç»“

é€šè¿‡å¯¹ä¸¤ä¸ªHARæ–‡ä»¶çš„æ·±å…¥åˆ†æï¼ŒæˆåŠŸè¯†åˆ«å‡ºå½±é™¢é—´ä¼šå‘˜å¡å¯†ç ç­–ç•¥çš„å·®å¼‚ï¼Œå¹¶åœ¨ `main_modular.py` ä¸­å®ç°äº†å®Œæ•´çš„åŠ¨æ€å¯†ç ç­–ç•¥æ£€æµ‹å’Œä¼šå‘˜å¡æ”¯ä»˜åŠŸèƒ½ã€‚è¯¥å®ç°å…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

- **å‡†ç¡®æ€§**: åŸºäºçœŸå®APIæ•°æ®è¿›è¡Œç­–ç•¥åˆ¤æ–­
- **çµæ´»æ€§**: æ”¯æŒä¸åŒå½±é™¢çš„ä¸åŒç­–ç•¥
- **å®‰å…¨æ€§**: å®Œæ•´çš„å¯†ç ä¿æŠ¤å’Œé”™è¯¯å¤„ç†
- **ç”¨æˆ·ä½“éªŒ**: æ™ºèƒ½åŒ–çš„å¯†ç è¾“å…¥æµç¨‹
- **å¯ç»´æŠ¤æ€§**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤

è¯¥åŠŸèƒ½å·²é€šè¿‡å®Œæ•´çš„æµ‹è¯•éªŒè¯ï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚
