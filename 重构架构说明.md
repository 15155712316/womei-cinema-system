# 柴犬影院下单系统 - 重构版本 v2.0.0

## 🎯 重构目标

本次重构将原有的单体架构升级为**MVC架构 + 事件总线**的模块化系统，实现了：

- ✅ **业务逻辑与UI完全解耦**
- ✅ **组件间通过事件总线通信**
- ✅ **代码结构清晰，易于维护和扩展**
- ✅ **保持原有业务逻辑不变**

## 🏗️ 架构设计

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    主窗口 (MainWindow)                    │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │ 账号面板     │  │ 影院面板     │  │ 座位图面板   │      │
│  │ AccountPanel│  │ CinemaPanel │  │ SeatMapPanel│      │
│  └─────────────┘  └─────────────┘  └─────────────┘      │
├─────────────────────────────────────────────────────────┤
│                    事件总线 (EventBus)                   │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │ 账号控制器   │  │ 影院控制器   │  │ 订单控制器   │      │
│  │AccountCtrl  │  │ CinemaCtrl  │  │ OrderCtrl   │      │
│  └─────────────┘  └─────────────┘  └─────────────┘      │
├─────────────────────────────────────────────────────────┤
│                    服务层 (Services)                     │
│  账号API | 影院API | 订单API | 认证服务 | 会员服务        │
└─────────────────────────────────────────────────────────┘
```

### 目录结构

```
电影go/
├── main.py                     # 程序入口 (重构版)
├── controllers/                # 控制器层 (新增)
│   ├── __init__.py
│   ├── order_controller.py     # 订单控制器
│   ├── account_controller.py   # 账号控制器
│   └── cinema_controller.py    # 影院控制器
├── views/                      # 视图层 (新增)
│   ├── __init__.py
│   ├── main_window.py          # 主窗口
│   └── components/             # UI组件
│       ├── __init__.py
│       ├── seat_map_panel.py   # 座位图面板
│       ├── account_panel.py    # 账号面板
│       └── cinema_panel.py     # 影院面板
├── utils/
│   └── signals.py              # 事件总线 (增强版)
├── services/                   # 服务层 (保持不变)
├── ui/                         # 原有UI (保留)
└── 启动重构版系统.bat           # 启动脚本
```

## 🔧 核心组件

### 1. 事件总线 (EventBus)

**位置**: `utils/signals.py`

**功能**: 
- 组件间解耦通信
- 事件历史记录
- 组件状态管理
- 线程安全

**主要事件**:
```python
# 用户认证事件
user_login_success = pyqtSignal(dict)
user_logout = pyqtSignal()

# 账号管理事件
account_selected = pyqtSignal(dict)
account_login_success = pyqtSignal(dict)
account_list_updated = pyqtSignal(list)

# 影院管理事件
cinema_selected = pyqtSignal(dict)
movie_list_updated = pyqtSignal(list)
session_list_updated = pyqtSignal(list)

# 座位管理事件
seat_selected = pyqtSignal(list)
seat_map_loaded = pyqtSignal(dict)

# 订单管理事件
order_created = pyqtSignal(dict)
order_paid = pyqtSignal(str)
```

### 2. 控制器层 (Controllers)

#### 订单控制器 (OrderController)
- 处理订单创建、支付、取消
- 管理券绑定和使用
- 订单状态跟踪

#### 账号控制器 (AccountController)
- 账号登录、添加、删除
- 账号列表管理
- 会员信息获取

#### 影院控制器 (CinemaController)
- 影院列表加载
- 电影和场次管理
- 座位图数据处理

### 3. 视图层 (Views)

#### 主窗口 (MainWindow)
- 集成所有控制器和组件
- 处理用户认证流程
- 管理UI状态

#### UI组件 (Components)
- **座位图面板**: 座位选择和显示
- **账号面板**: 账号管理界面
- **影院面板**: 影院、电影、场次选择

## 🚀 启动方式

### 方式1: 命令行启动
```bash
python main.py
```

### 方式2: 批处理文件
```bash
双击 "启动重构版系统.bat"
```

### 方式3: 测试系统
```bash
python test_refactored_system.py
```

## 🔄 数据流程

### 1. 用户登录流程
```
用户输入 → LoginWindow → 认证成功 → 
event_bus.user_login_success → 各控制器初始化数据
```

### 2. 选择影院流程
```
用户选择影院 → CinemaPanel → cinema_selected事件 → 
CinemaController.select_cinema → 加载电影列表 → 
movie_list_updated事件 → CinemaPanel更新显示
```

### 3. 订单创建流程
```
选择座位 → SeatMapPanel → order_submitted事件 → 
OrderController.create_order → 调用API → 
order_created事件 → 更新UI显示
```

## 🎨 UI特性

### 响应式布局
- 三栏式布局：账号管理 | 影院选择+座位图 | 订单详情
- 自适应组件大小
- 统一的视觉风格

### 用户体验
- 实时状态反馈
- 错误信息提示
- 操作确认对话框
- 倒计时显示

## 🔧 技术特性

### 事件驱动架构
- 松耦合设计
- 异步事件处理
- 事件历史记录
- 组件状态管理

### 错误处理
- 统一错误处理机制
- 详细错误日志
- 用户友好的错误提示

### 扩展性
- 插件化组件设计
- 易于添加新功能
- 配置化参数管理

## 📊 性能优化

- 弱引用避免内存泄漏
- 线程安全的事件处理
- 延迟加载和按需更新
- 资源自动清理

## 🧪 测试覆盖

- 模块导入测试
- 事件总线功能测试
- 控制器功能测试
- UI组件测试
- 系统集成测试

## 📝 开发说明

### 添加新功能
1. 在相应控制器中添加业务逻辑
2. 在事件总线中定义新事件
3. 在UI组件中处理用户交互
4. 通过事件总线连接各组件

### 调试技巧
- 查看控制台日志输出
- 使用事件历史记录功能
- 检查组件状态管理器

## 🎉 重构成果

✅ **代码质量提升**: 从单体架构升级为MVC架构  
✅ **可维护性增强**: 模块化设计，职责清晰  
✅ **可扩展性提升**: 事件驱动，松耦合设计  
✅ **用户体验优化**: 响应式UI，实时反馈  
✅ **功能完整性**: 保持原有所有业务功能  

---

**重构版本**: v2.0.0  
**架构**: MVC + 事件总线  
**界面**: PyQt5  
**特性**: 模块化、解耦、可扩展
