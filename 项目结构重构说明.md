# 乐影票务系统 - 项目结构重构说明

## 重构目标

1. **统一弹窗管理**：所有弹窗都在窗口中心显示
2. **券列表状态管理**：只在提交订单后显示券列表
3. **消息提示优化**：只有登录成功需要弹窗提示，其他操作静默处理
4. **代码结构优化**：遵循高内聚低耦合原则，提高复用性

## 项目结构

```
乐影票务系统/
├── ui/                          # 用户界面层
│   ├── main_window.py          # 主窗口（已重构）
│   ├── login_window.py         # 登录窗口（已重构）
│   ├── cinema_select_panel.py  # 影院选择面板（已重构）
│   ├── seat_map_panel.py       # 座位图面板
│   ├── account_list_panel.py   # 账号列表面板
│   └── login_panel.py          # 登录面板
├── services/                    # 服务层
│   ├── ui_utils.py             # UI工具类（新增）
│   ├── auth_service.py         # 认证服务
│   ├── order_api.py            # 订单API
│   ├── cinema_manager.py       # 影院管理器
│   ├── film_service.py         # 影片服务
│   ├── member_service.py       # 会员服务
│   └── api_base.py             # API基础类
├── models/                      # 数据模型层
│   ├── account.py              # 账号模型
│   ├── cinema.py               # 影院模型
│   ├── movie.py                # 电影模型
│   └── order.py                # 订单模型
├── data/                        # 数据存储
│   ├── accounts.json           # 账号数据
│   ├── cinemas.json            # 影院数据
│   └── img/                    # 图片存储
└── copy/                        # 备份文件夹
```

## 重构内容

### 1. 新增UI工具类 (`services/ui_utils.py`)

#### MessageManager - 统一消息管理器
- `show_info()` - 显示信息弹窗
- `show_warning()` - 显示警告弹窗
- `show_error()` - 显示错误弹窗
- `show_question()` - 显示问题弹窗
- 支持Tkinter和PyQt5两种框架
- 所有弹窗自动在父窗口中心显示

#### CouponManager - 券管理器
- `should_show_coupons()` - 判断是否应该显示券列表
- `clear_coupons_if_needed()` - 根据状态决定是否清空券列表

#### UIConstants - UI常量定义
- `SHOW_SUCCESS_POPUP_OPERATIONS` - 需要显示成功弹窗的操作
- `SILENT_OPERATIONS` - 需要静默处理的操作
- `should_show_success_popup()` - 判断操作是否需要显示成功弹窗

### 2. 主窗口重构 (`ui/main_window.py`)

#### UI状态管理
- 新增 `ui_state` 状态跟踪：`initial` → `ordering` → `order_submitted` → `payment_success`
- 券列表只在 `order_submitted` 状态显示
- 选座操作不影响券列表状态

#### 消息提示优化
- 使用统一的 `MessageManager` 替换所有弹窗
- 移除不必要的成功提示：
  - 出票成功不弹窗
  - 支付成功不弹窗
  - 订单提交成功不弹窗
- 保留必要提示：
  - 登录成功弹窗
  - 错误和警告提示

#### 券列表逻辑修复
- `clear_coupons()` 根据UI状态决定是否清空
- 只在提交订单后才显示可用券
- 选座时不清空已选择的券

### 3. 登录窗口重构 (`ui/login_window.py`)

- 使用统一的 `MessageManager`
- 登录成功弹窗居中显示
- 错误提示居中显示

### 4. 影院选择面板重构 (`ui/cinema_select_panel.py`)

- 使用统一的 `MessageManager`
- 座位获取失败时的错误提示居中显示

## 功能验证

### 1. 券列表状态管理
- ✅ 初始状态：券列表为空
- ✅ 选座时：不清空券列表
- ✅ 提交订单后：显示可用券
- ✅ 支付成功后：保持券列表状态

### 2. 弹窗居中显示
- ✅ 登录成功弹窗居中
- ✅ 错误提示弹窗居中
- ✅ 警告提示弹窗居中
- ✅ 确认对话框居中

### 3. 消息提示优化
- ✅ 只有登录成功显示弹窗
- ✅ 出票成功静默处理
- ✅ 支付成功静默处理
- ✅ 订单提交成功静默处理

### 4. 代码结构优化
- ✅ 高内聚：相关功能集中在对应模块
- ✅ 低耦合：通过接口和工具类解耦
- ✅ 可复用：UI工具类可在多个模块使用

## 使用说明

### 1. 消息提示
```python
from services.ui_utils import MessageManager

# 显示信息
MessageManager.show_info(parent_widget, "标题", "消息内容")

# 显示警告
MessageManager.show_warning(parent_widget, "标题", "警告内容")

# 显示错误
MessageManager.show_error(parent_widget, "标题", "错误内容")

# 显示确认对话框
result = MessageManager.show_question(parent_widget, "标题", "确认内容")
```

### 2. 券列表管理
```python
from services.ui_utils import CouponManager

# 检查是否应该显示券
if CouponManager.should_show_coupons(self.ui_state):
    self.show_coupons()

# 根据状态清空券列表
CouponManager.clear_coupons_if_needed(self.ui_state, self.clear_coupons_impl)
```

### 3. UI常量使用
```python
from services.ui_utils import UIConstants

# 检查是否需要显示成功弹窗
if UIConstants.should_show_success_popup("login_success"):
    MessageManager.show_info(self, "成功", "操作成功")
```

## 后续优化建议

1. **状态机模式**：进一步完善UI状态管理
2. **事件总线**：实现组件间解耦通信
3. **配置管理**：统一管理UI配置和常量
4. **日志系统**：完善错误日志和操作日志
5. **单元测试**：为核心功能添加单元测试

## 兼容性说明

- 保持所有现有功能不变
- 向后兼容现有API接口
- 不影响用户操作流程
- 提升用户体验和代码质量 