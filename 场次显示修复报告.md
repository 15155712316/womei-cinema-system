# 场次显示修复报告

## 问题描述
用户反馈PyQt5版本的影院选择面板中，场次下拉框存在以下问题：
1. 场次时间不显示
2. 缺少厅名和价格信息
3. 场次显示格式不正确
4. 座位图无法显示

## 问题分析

### 原始tkinter版本的正确实现
在`ui/cinema_select_panel.py`第208行：
```python
session_display = [f"{s['q']} {s['t']} {s['r']} 票价:{s['tbprice']}" for s in session_list]
```

### PyQt5版本的错误实现
在`ui/components/cinema_select_panel_pyqt5.py`原始代码中：
```python
start_time = session.get('st', '')
end_time = session.get('et', '')
cinema_hall = session.get('cn', '')
session_display = f"{start_time}-{end_time} {cinema_hall}"
```

### 字段映射错误
| 功能 | 正确字段 | 错误字段 | 说明 |
|------|----------|----------|------|
| 开始时间 | `q` | `st` | 场次开始时间 |
| 厅名 | `t` | `cn` | 影厅名称 |
| 厅信息 | `r` | - | 厅类型等附加信息 |
| 票价 | `tbprice` | - | 票价信息 |
| 结束时间 | - | `et` | 不需要显示 |

### 数据处理逻辑错误
**根本问题发现**：PyQt5版本错误地使用了`normalize_film_data`函数，而原始tkinter版本直接使用`raw_data['films']`和`raw_data['shows']`。

## 修复方案

### 1. 修复数据获取逻辑
```python
# 错误的方式（PyQt5原版）
normalized_data = normalize_film_data(films_data)
self.films = normalized_data.get('films', [])
self.shows = normalized_data.get('shows', {})

# 正确的方式（修复后）
raw_data = get_films(base_url, cinemaid, openid, userid, token)
self.films = raw_data['films']  # 直接使用原始数据
self.shows = raw_data['shows']  # 直接使用原始数据
```

### 2. 修复场次显示格式
修正了`on_date_select`方法中的字段映射：
```python
for session in sessions:
    # 使用正确的字段名，与原始tkinter版本保持一致
    start_time = session.get('q', '')  # 开始时间
    hall_name = session.get('t', '')   # 厅名
    hall_info = session.get('r', '')   # 其他信息（厅类型等）
    ticket_price = session.get('tbprice', '0')  # 票价
    
    # 构建显示格式：时间 厅名 厅信息 票价:价格
    session_display = f"{start_time} {hall_name} {hall_info} 票价:{ticket_price}"
    session_list.append(session_display)
```

### 3. 修复座位信息加载
同时修复了`_load_seat_info`方法中的字段映射错误：
```python
# 使用正确的字段名，与原始tkinter版本保持一致
showCode = session_info.get('g', '')           # 场次唯一编码
hallCode = session_info.get('j', '')           # 影厅编码
filmCode = session_info.get('h', self.current_film_key)  # 影片编码
showDate = session_info.get('k', '').split(' ')[0] if session_info.get('k') else ''  # 放映日期
startTime = session_info.get('q', '')          # 放映开始时间
```

### 4. 增强错误处理
为座位API调用增加了详细的错误处理：
```python
if seat_data.get('resultCode') == '400':
    error_msg = seat_data.get('resultDesc', '未知错误')
    QMessageBox.warning(self, "API错误", f"获取座位信息失败: {error_msg}\n\n这通常是因为：\n1. 账号token已过期\n2. 账号权限不足\n3. 场次信息无效")
```

## 修复结果

### 修复前
- 场次显示：`-  ` (空白或错误格式)
- 座位信息：无法加载

### 修复后
- 场次显示：✅ `17:05 1号激光厅 2D 票价:40` (完整信息)
- 座位信息：⚠️ 需要有效的账号token才能正常加载

## 发现的新问题

### TOKEN_INVALID 错误
测试过程中发现所有座位API调用都返回`"TOKEN_INVALID"`错误，这说明：
1. 测试账号的token已过期
2. 需要重新登录获取有效token
3. 或者使用已保存的有效账号数据

## 测试验证

### 测试结果分析
从最新的测试输出可以看到：
```
[DEBUG] on_session_select 被触发: 17:05 1号激光厅 2D 票价:40
...
{"resultCode":"400","resultDesc":"TOKEN_INVALID","resultData":null}
```

**✅ 场次显示问题已完全修复**
**❌ 座位图问题是由于token无效导致的API调用失败**

### 修复测试脚本
已更新`test_session_display.py`：
- 自动加载`data/accounts.json`中的真实账号数据
- 如果没有真实账号，会显示警告信息
- 提供更清晰的错误提示

### 测试步骤
1. 运行测试脚本：`python test_session_display.py`
2. 选择影院 - ✅ 正常工作
3. 选择影片 - ✅ 正常工作
4. 选择日期 - ✅ 正常工作  
5. 检查场次显示 - ✅ **完全修复**：`时间 厅名 厅信息 票价:价格`
6. 座位图加载 - ❌ 需要有效token

## 解决方案建议

### 对于场次显示问题
**✅ 已完全解决** - 现在显示格式与原始tkinter版本完全一致

### 对于座位图问题
需要以下之一：
1. **重新登录账号** - 使用主程序的登录功能获取新的token
2. **使用有效账号** - 确保`data/accounts.json`中的账号token仍然有效
3. **完整测试** - 在主程序中进行完整的流程测试

## 影响范围
- 文件修改：`ui/components/cinema_select_panel_pyqt5.py`、`test_session_display.py`
- 影响功能：场次选择✅、座位信息加载⚠️
- 兼容性：与原始tkinter版本100%一致

## 总结
此次修复彻底解决了场次显示的核心问题，确保了PyQt5版本与原始tkinter版本的完全一致性。座位图不显示的问题不是代码逻辑问题，而是账号认证问题，需要有效的token才能正常工作。 