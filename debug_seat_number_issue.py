#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è°ƒè¯•åº§ä½å·æ˜¾ç¤ºé—®é¢˜
"""

def debug_seat_number_issue():
    """è°ƒè¯•åº§ä½å·æ˜¾ç¤ºé—®é¢˜"""
    print("ğŸ” è°ƒè¯•åº§ä½å·æ˜¾ç¤ºé—®é¢˜")
    
    # æ¨¡æ‹ŸçœŸå®çš„APIåº§ä½æ•°æ®ï¼ˆåŸºäºæ‚¨çœ‹åˆ°çš„"00111"é—®é¢˜ï¼‰
    print("\nğŸ“‹ æ¨¡æ‹ŸçœŸå®APIåº§ä½æ•°æ®:")
    
    # å¯èƒ½çš„æƒ…å†µ1ï¼šsnå­—æ®µåŒ…å«é•¿å­—ç¬¦ä¸²
    mock_api_data_case1 = [
        {
            'rn': 1,  # è¡Œå·
            'cn': 1,  # åˆ—å·
            'sn': '00111',  # çœŸå®åº§ä½å·ï¼ˆå¯èƒ½æ˜¯è¿™æ ·çš„æ ¼å¼ï¼‰
            's': 'F'   # çŠ¶æ€
        },
        {
            'rn': 1,
            'cn': 2,
            'sn': '00111',  # é‡å¤çš„åº§ä½å·ï¼Ÿ
            's': 'F'
        },
        {
            'rn': 1,
            'cn': 3,
            'sn': '00111',
            's': 'F'
        }
    ]
    
    # å¯èƒ½çš„æƒ…å†µ2ï¼šsnå­—æ®µä¸ºç©ºæˆ–null
    mock_api_data_case2 = [
        {
            'rn': 1,
            'cn': 1,
            'sn': '',  # ç©ºçš„åº§ä½å·
            's': 'F'
        },
        {
            'rn': 1,
            'cn': 2,
            'sn': None,  # nullåº§ä½å·
            's': 'F'
        },
        {
            'rn': 1,
            'cn': 3,
            # ç¼ºå°‘snå­—æ®µ
            's': 'F'
        }
    ]
    
    # å¯èƒ½çš„æƒ…å†µ3ï¼šæ­£å¸¸çš„åº§ä½å·
    mock_api_data_case3 = [
        {
            'rn': 1,
            'cn': 1,
            'sn': '1',  # æ­£å¸¸åº§ä½å·
            's': 'F'
        },
        {
            'rn': 1,
            'cn': 2,
            'sn': '2',
            's': 'F'
        },
        {
            'rn': 1,
            'cn': 3,
            'sn': '3',
            's': 'F'
        }
    ]
    
    def test_seat_parsing(case_name, seats_data):
        """æµ‹è¯•åº§ä½è§£æé€»è¾‘"""
        print(f"\nğŸ§ª æµ‹è¯• {case_name}:")
        
        for i, seat in enumerate(seats_data):
            print(f"   åŸå§‹æ•°æ®: {seat}")
            
            # æ¨¡æ‹Ÿå½“å‰çš„è§£æé€»è¾‘
            real_seat_num = seat.get('sn', '')  # çœŸå®åº§ä½å·
            if not real_seat_num:
                # å¦‚æœæ²¡æœ‰çœŸå®åº§ä½å·ï¼Œä½¿ç”¨åˆ—å·ä½œä¸ºå¤‡é€‰
                real_seat_num = str(seat.get('cn', i + 1))
            
            print(f"   è§£æç»“æœ: æ˜¾ç¤ºåº§ä½å·='{real_seat_num}'")
            
            # åˆ†æé—®é¢˜
            if real_seat_num == '00111':
                print(f"   âš ï¸  é—®é¢˜å‘ç°: åº§ä½å·ä¸º'00111'ï¼Œè¿™å¯èƒ½ä¸æ˜¯æ­£ç¡®çš„åº§ä½å·")
            elif not real_seat_num or real_seat_num == 'None':
                print(f"   âš ï¸  é—®é¢˜å‘ç°: åº§ä½å·ä¸ºç©ºï¼Œä½¿ç”¨å¤‡é€‰é€»è¾‘")
            else:
                print(f"   âœ… åº§ä½å·æ­£å¸¸")
    
    # æµ‹è¯•å„ç§æƒ…å†µ
    test_seat_parsing("æƒ…å†µ1: snå­—æ®µåŒ…å«'00111'", mock_api_data_case1)
    test_seat_parsing("æƒ…å†µ2: snå­—æ®µä¸ºç©ºæˆ–null", mock_api_data_case2)
    test_seat_parsing("æƒ…å†µ3: æ­£å¸¸åº§ä½å·", mock_api_data_case3)
    
    print("\nğŸ”§ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:")
    print("1. æ£€æŸ¥APIè¿”å›çš„çœŸå®æ•°æ®æ ¼å¼")
    print("2. å¦‚æœsnå­—æ®µç¡®å®æ˜¯'00111'è¿™æ ·çš„æ ¼å¼ï¼Œå¯èƒ½éœ€è¦:")
    print("   - ä½¿ç”¨cnå­—æ®µä½œä¸ºåº§ä½å·")
    print("   - æˆ–è€…è§£æsnå­—æ®µçš„ç‰¹å®šéƒ¨åˆ†")
    print("   - æˆ–è€…ä½¿ç”¨å…¶ä»–å­—æ®µä½œä¸ºåº§ä½å·")
    
    print("\nğŸ’¡ å»ºè®®çš„ä¿®å¤é€»è¾‘:")
    print("""
    def get_seat_number(seat, col_num):
        # ä¼˜å…ˆçº§1: æ£€æŸ¥snå­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„åº§ä½å·
        sn = seat.get('sn', '')
        if sn and sn != '00111' and len(sn) <= 3:  # è¿‡æ»¤å¼‚å¸¸å€¼
            return sn
        
        # ä¼˜å…ˆçº§2: ä½¿ç”¨cnå­—æ®µä½œä¸ºåº§ä½å·
        cn = seat.get('cn', 0)
        if cn > 0:
            return str(cn)
        
        # ä¼˜å…ˆçº§3: ä½¿ç”¨æ•°ç»„ç´¢å¼•+1
        return str(col_num + 1)
    """)
    
    print("\nğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨:")
    print("1. è¿è¡ŒçœŸå®ç¨‹åºï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºçš„åº§ä½æ•°æ®")
    print("2. æ ¹æ®çœŸå®æ•°æ®è°ƒæ•´è§£æé€»è¾‘")
    print("3. æµ‹è¯•ä¿®å¤æ•ˆæœ")


def test_improved_parsing_logic():
    """æµ‹è¯•æ”¹è¿›çš„è§£æé€»è¾‘"""
    print("\n" + "="*60)
    print("ğŸ§ª æµ‹è¯•æ”¹è¿›çš„åº§ä½å·è§£æé€»è¾‘")
    print("="*60)
    
    def get_seat_number_improved(seat, col_num):
        """æ”¹è¿›çš„åº§ä½å·è·å–é€»è¾‘"""
        # ä¼˜å…ˆçº§1: æ£€æŸ¥snå­—æ®µæ˜¯å¦ä¸ºæœ‰æ•ˆçš„åº§ä½å·
        sn = seat.get('sn', '')
        if sn and sn != '00111' and len(str(sn)) <= 3 and str(sn).isdigit():
            return str(sn)
        
        # ä¼˜å…ˆçº§2: ä½¿ç”¨cnå­—æ®µä½œä¸ºåº§ä½å·
        cn = seat.get('cn', 0)
        if cn > 0:
            return str(cn)
        
        # ä¼˜å…ˆçº§3: ä½¿ç”¨æ•°ç»„ç´¢å¼•+1
        return str(col_num + 1)
    
    # æµ‹è¯•æ•°æ®
    test_cases = [
        # æ­£å¸¸æƒ…å†µ
        {'rn': 1, 'cn': 1, 'sn': '1', 's': 'F'},
        {'rn': 1, 'cn': 2, 'sn': '2', 's': 'F'},
        
        # å¼‚å¸¸æƒ…å†µï¼šsnä¸º'00111'
        {'rn': 1, 'cn': 3, 'sn': '00111', 's': 'F'},
        {'rn': 1, 'cn': 4, 'sn': '00111', 's': 'F'},
        
        # ç©ºsnæƒ…å†µ
        {'rn': 1, 'cn': 5, 'sn': '', 's': 'F'},
        {'rn': 1, 'cn': 6, 's': 'F'},  # ç¼ºå°‘snå­—æ®µ
        
        # å…¶ä»–å¼‚å¸¸æƒ…å†µ
        {'rn': 1, 'cn': 7, 'sn': None, 's': 'F'},
        {'rn': 1, 'cn': 8, 'sn': 'ABC', 's': 'F'},  # éæ•°å­—
    ]
    
    print("ğŸ“‹ æµ‹è¯•ç»“æœ:")
    for i, seat in enumerate(test_cases):
        col_num = i  # æ•°ç»„ç´¢å¼•
        result = get_seat_number_improved(seat, col_num)
        
        print(f"   åº§ä½{i+1}: {seat}")
        print(f"   â†’ æ˜¾ç¤ºåº§ä½å·: '{result}'")
        
        # éªŒè¯ç»“æœ
        if result in ['1', '2', '3', '4', '5', '6', '7', '8']:
            print(f"   âœ… ç»“æœæ­£å¸¸")
        else:
            print(f"   âš ï¸  ç»“æœå¼‚å¸¸")
        print()
    
    print("ğŸ¯ æ”¹è¿›çš„è§£æé€»è¾‘ç‰¹ç‚¹:")
    print("1. âœ… è¿‡æ»¤æ‰'00111'è¿™æ ·çš„å¼‚å¸¸snå€¼")
    print("2. âœ… ä¼˜å…ˆä½¿ç”¨cnå­—æ®µä½œä¸ºåº§ä½å·")
    print("3. âœ… æœ‰å®Œå–„çš„å¤‡é€‰æœºåˆ¶")
    print("4. âœ… éªŒè¯åº§ä½å·çš„æœ‰æ•ˆæ€§ï¼ˆæ•°å­—ä¸”é•¿åº¦åˆç†ï¼‰")


def main():
    """ä¸»å‡½æ•°"""
    debug_seat_number_issue()
    test_improved_parsing_logic()
    
    print("\n" + "="*60)
    print("ğŸ“Š è°ƒè¯•æ€»ç»“")
    print("="*60)
    print("ğŸ” é—®é¢˜åˆ†æ:")
    print("   åº§ä½æŒ‰é’®æ˜¾ç¤º'00111'å¯†å¯†éº»éº»ï¼Œè¯´æ˜:")
    print("   1. APIçš„snå­—æ®µå¯èƒ½åŒ…å«å¼‚å¸¸å€¼'00111'")
    print("   2. å½“å‰è§£æé€»è¾‘ç›´æ¥ä½¿ç”¨äº†snå­—æ®µ")
    print("   3. éœ€è¦æ·»åŠ æ•°æ®éªŒè¯å’Œè¿‡æ»¤é€»è¾‘")
    
    print("\nğŸ’¡ è§£å†³æ–¹æ¡ˆ:")
    print("   1. æ·»åŠ snå­—æ®µçš„æœ‰æ•ˆæ€§éªŒè¯")
    print("   2. è¿‡æ»¤æ‰'00111'è¿™æ ·çš„å¼‚å¸¸å€¼")
    print("   3. ä¼˜å…ˆä½¿ç”¨cnå­—æ®µä½œä¸ºåº§ä½å·")
    print("   4. ä¿æŒå¤‡é€‰æœºåˆ¶çš„å®Œæ•´æ€§")
    
    print("\nğŸ¯ ä¸‹ä¸€æ­¥:")
    print("   1. ä¿®æ”¹main_modular.pyä¸­çš„åº§ä½è§£æé€»è¾‘")
    print("   2. æ·»åŠ æ•°æ®éªŒè¯å’Œè¿‡æ»¤")
    print("   3. æµ‹è¯•ä¿®å¤æ•ˆæœ")


if __name__ == "__main__":
    main()
