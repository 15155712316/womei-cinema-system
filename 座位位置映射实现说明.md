# 沃美影院座位位置映射实现说明

## 概述

在沃美影院座位图系统中，我们成功实现了两种不同座位位置概念的明确区分：

1. **实际位置（逻辑位置）**：用于提交订单时的座位标识
2. **物理位置（显示位置）**：用于在座位图UI中确定座位按钮的显示位置

## 核心实现

### 1. 数据结构设计

每个座位包含以下关键字段：

```python
seat = {
    'seat_no': 'A01',           # 座位唯一标识
    'row': 1,                   # 逻辑行号（用于订单）
    'col': 1,                   # 逻辑列号（用于订单）
    'x': 2,                     # 物理X坐标（用于显示）
    'y': 1,                     # 物理Y坐标（用于显示）
    'status': 'available',      # 座位状态
    'area_name': 'VIP区',       # 区域名称
    'area_price': 80,           # 区域价格
    'num': '1'                  # 显示编号
}
```

### 2. 座位图渲染逻辑

在 `ui/components/seat_map_panel_pyqt5.py` 的 `_draw_seats` 方法中：

```python
# 🔧 使用物理位置确定网格显示位置
grid_row = physical_y - 1  # 物理Y坐标转换为网格行
grid_col = physical_x      # 物理X坐标转换为网格列

# 添加到布局 - 使用物理位置确定网格位置
self.seat_layout.addWidget(seat_btn, grid_row, grid_col)
```

### 3. 座位按钮信息保存

每个座位按钮保存完整的位置信息：

```python
# 保存完整的座位信息到按钮
seat_btn.logical_row = logical_row      # 逻辑行号（用于订单）
seat_btn.logical_col = logical_col      # 逻辑列号（用于订单）
seat_btn.physical_x = physical_x        # 物理X坐标（用于显示）
seat_btn.physical_y = physical_y        # 物理Y坐标（用于显示）
```

### 4. 订单数据生成

在 `get_selected_seats_for_order` 方法中，明确使用逻辑位置：

```python
order_seat = {
    'seat_no': seat.get('seat_no', ''),
    'row': logical_row,      # 逻辑行号（用于订单）
    'col': logical_col,      # 逻辑列号（用于订单）
    'area_name': seat.get('area_name', ''),
    'area_price': seat.get('area_price', 0),
    # ... 其他订单相关字段
}
```

## 关键特性

### 1. 自动位置映射

- **显示时**：系统自动使用物理坐标 (x, y) 确定座位按钮在网格中的位置
- **订单时**：系统自动使用逻辑坐标 (row, col) 标识座位用于后端处理

### 2. 空位处理

- 物理位置没有座位的地方会自动留空，准确还原影厅布局
- 不会因为数组索引的连续性影响实际的物理布局

### 3. 区域支持

- 支持多区域座位图显示
- 每个区域可以有不同的价格和样式
- 区域边框颜色自动区分

### 4. 兼容性保证

- 保持与现有代码的兼容性
- 数组索引仍然用作内部键值
- 向后兼容原有的座位选择逻辑

## 使用示例

### 1. 运行演示程序

```bash
python demo_position_mapping.py
```

这个演示程序展示了：
- 逻辑位置和物理位置的区别
- 座位图的真实布局还原
- 订单数据的正确生成

### 2. 测试位置映射

```bash
python test_seat_position_mapping.py
```

这个测试程序可以：
- 加载真实的座位数据
- 分析位置映射的一致性
- 验证订单数据的正确性

## 技术优势

### 1. 准确的布局还原

- 使用物理坐标确保座位图与实际影厅布局一致
- 支持不规则的座位排列和空隙

### 2. 正确的订单处理

- 使用逻辑坐标确保后端系统能正确识别座位
- 避免因显示位置变化影响订单处理

### 3. 灵活的扩展性

- 支持复杂的影厅布局
- 可以轻松适配不同的座位排列方式

### 4. 用户友好的界面

- 座位按钮显示逻辑座位号（如"1排3座"）
- 提交按钮显示选中的逻辑座位信息
- 区域颜色区分提升用户体验

## 实现验证

通过演示程序可以观察到：

1. **显示正确性**：座位按钮根据物理坐标正确排列，有空隙的地方确实留空
2. **标识正确性**：座位按钮显示逻辑座位号，用户容易理解
3. **订单正确性**：选中座位后，订单数据使用逻辑位置，符合后端要求
4. **映射正确性**：系统能正确处理逻辑位置和物理位置的转换

## 总结

这个实现成功解决了沃美影院系统中座位位置映射的核心问题：

- ✅ **显示位置**：使用物理坐标 (x, y) 准确还原影厅布局
- ✅ **订单位置**：使用逻辑坐标 (row, col) 确保后端正确处理
- ✅ **自动转换**：系统自动处理两套坐标系统的映射
- ✅ **用户体验**：界面友好，信息清晰，操作直观

这为沃美影院系统提供了一个稳定、准确、用户友好的座位选择解决方案。
