# PyQt5ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿ - ç”¨æˆ·ç®¡ç†å’Œè®¾å¤‡ç»‘å®šå®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ **æ–¹æ¡ˆæ¦‚è§ˆ**

**ç›®æ ‡ç”¨æˆ·è§„æ¨¡**ï¼š50-100ä¸ªç”¨æˆ·
**æ ¸å¿ƒéœ€æ±‚**ï¼šè®¾å¤‡å”¯ä¸€ç»‘å®š + åœ¨çº¿ç®¡ç†åå° + å®¢æˆ·ç«¯åˆ†å‘
**æŠ€æœ¯æ¶æ„**ï¼šPyQt5å®¢æˆ·ç«¯ + Flask APIæœåŠ¡å™¨ + MongoDBæ•°æ®åº“ + Webç®¡ç†åå°
**å®‰å…¨æœºåˆ¶**ï¼šæ‰‹æœºå·+æœºå™¨ç åŒé‡éªŒè¯ï¼Œç¡®ä¿ä¸€è´¦å·ä¸€è®¾å¤‡

---

## ğŸ—ï¸ **1. ç³»ç»Ÿæ¶æ„è®¾è®¡**

### **1.1 æ•´ä½“æ¶æ„å›¾**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   PyQt5å®¢æˆ·ç«¯    â”‚    â”‚   Flask API     â”‚    â”‚   MongoDBæ•°æ®åº“  â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ ç™»å½•ç•Œé¢      â”‚â—„â”€â”€â–ºâ”‚ â€¢ ç”¨æˆ·è®¤è¯      â”‚â—„â”€â”€â–ºâ”‚ â€¢ ç”¨æˆ·æ•°æ®      â”‚
â”‚ â€¢ æœºå™¨ç è·å–    â”‚    â”‚ â€¢ è®¾å¤‡ç»‘å®š      â”‚    â”‚ â€¢ è®¾å¤‡ç»‘å®š      â”‚
â”‚ â€¢ ä¸šåŠ¡åŠŸèƒ½      â”‚    â”‚ â€¢ æƒé™éªŒè¯      â”‚    â”‚ â€¢ ç™»å½•æ—¥å¿—      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Webç®¡ç†åå°    â”‚
                       â”‚                 â”‚
                       â”‚ â€¢ ç”¨æˆ·ç®¡ç†      â”‚
                       â”‚ â€¢ è®¾å¤‡ç®¡ç†      â”‚
                       â”‚ â€¢ ç§¯åˆ†ç®¡ç†      â”‚
                       â”‚ â€¢ ç»Ÿè®¡åˆ†æ      â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **1.2 æ ¸å¿ƒç»„ä»¶èŒè´£**

#### **PyQt5å®¢æˆ·ç«¯**
- **ç™»å½•éªŒè¯**ï¼šæ‰‹æœºå·è¾“å…¥ + è‡ªåŠ¨æœºå™¨ç è·å–
- **è®¾å¤‡ç»‘å®š**ï¼šé¦–æ¬¡ç™»å½•è‡ªåŠ¨ç»‘å®šå½“å‰è®¾å¤‡
- **ä¸šåŠ¡åŠŸèƒ½**ï¼šç”µå½±ç¥¨åŠ¡ç®¡ç†æ ¸å¿ƒåŠŸèƒ½
- **ç¦»çº¿ç¼“å­˜**ï¼šç”¨æˆ·ä¿¡æ¯æœ¬åœ°ç¼“å­˜æœºåˆ¶

#### **Flask APIæœåŠ¡å™¨**
- **ç”¨æˆ·è®¤è¯**ï¼šæ‰‹æœºå·+æœºå™¨ç éªŒè¯
- **è®¾å¤‡ç®¡ç†**ï¼šè®¾å¤‡ç»‘å®šã€è§£ç»‘ã€é‡ç»‘
- **æƒé™æ§åˆ¶**ï¼šç”¨æˆ·çŠ¶æ€ã€ç§¯åˆ†ç®¡ç†
- **å®‰å…¨é˜²æŠ¤**ï¼šé˜²åˆ·æœºåˆ¶ã€å¼‚å¸¸æ£€æµ‹

#### **MongoDBæ•°æ®åº“**
- **ç”¨æˆ·æ•°æ®**ï¼šåŸºç¡€ä¿¡æ¯ã€çŠ¶æ€ã€ç§¯åˆ†
- **è®¾å¤‡ç»‘å®š**ï¼šæœºå™¨ç ã€ç»‘å®šæ—¶é—´ã€è®¾å¤‡ä¿¡æ¯
- **æ“ä½œæ—¥å¿—**ï¼šç™»å½•è®°å½•ã€æ“ä½œå®¡è®¡
- **ç³»ç»Ÿé…ç½®**ï¼šå…¨å±€è®¾ç½®ã€æƒé™é…ç½®

#### **Webç®¡ç†åå°**
- **ç”¨æˆ·ç®¡ç†**ï¼šCRUDæ“ä½œã€æ‰¹é‡ç®¡ç†
- **è®¾å¤‡ç®¡ç†**ï¼šç»‘å®šæŸ¥çœ‹ã€å¼ºåˆ¶è§£ç»‘
- **æ•°æ®ç»Ÿè®¡**ï¼šç”¨æˆ·æ´»è·ƒåº¦ã€è®¾å¤‡åˆ†å¸ƒ
- **ç³»ç»Ÿç›‘æ§**ï¼šAPIè°ƒç”¨ã€å¼‚å¸¸å‘Šè­¦

---

## ğŸ”§ **2. æ•°æ®åº“è®¾è®¡ä¼˜åŒ–**

### **2.1 ç”¨æˆ·æ•°æ®ç»“æ„è®¾è®¡**
```javascript
// MongoDBç”¨æˆ·é›†åˆç»“æ„
{
  "_id": ObjectId("..."),
  "userId": "user_15155712316",           // ç”¨æˆ·å”¯ä¸€æ ‡è¯†
  "phone": "15155712316",                 // æ‰‹æœºå·ï¼ˆç™»å½•å‡­è¯ï¼‰
  "profile": {
    "displayName": "ç”¨æˆ·15155712316",      // æ˜¾ç¤ºåç§°
    "nickname": null,                     // æ˜µç§°ï¼ˆå¯é€‰ï¼‰
    "avatar": null,                       // å¤´åƒURLï¼ˆå¯é€‰ï¼‰
    "email": null                         // é‚®ç®±ï¼ˆå¯é€‰ï¼‰
  },
  "account": {
    "points": 100,                        // ç§¯åˆ†ä½™é¢
    "level": "æ™®é€šç”¨æˆ·",                   // ç”¨æˆ·ç­‰çº§
    "status": {
      "code": 1,                          // çŠ¶æ€ç ï¼š1=æ­£å¸¸ï¼Œ0=ç¦ç”¨ï¼Œ-1=å†»ç»“
      "text": "æ­£å¸¸",                      // çŠ¶æ€æ–‡æœ¬
      "reason": null,                     // çŠ¶æ€å˜æ›´åŸå› 
      "updatedAt": ISODate("...")         // çŠ¶æ€æ›´æ–°æ—¶é—´
    },
    "permissions": ["login", "order", "payment"], // æƒé™åˆ—è¡¨
    "subscription": {
      "type": "basic",                    // è®¢é˜…ç±»å‹
      "expiresAt": null                   // è¿‡æœŸæ—¶é—´
    }
  },
  "device": {
    "machineCode": "9DC6B72833DBFDA6",    // ç»‘å®šçš„æœºå™¨ç 
    "deviceInfo": {
      "os": "Windows 10",                 // æ“ä½œç³»ç»Ÿ
      "hostname": "USER-PC",              // è®¡ç®—æœºå
      "cpu": "Intel Core i5",             // CPUä¿¡æ¯
      "memory": "8GB"                     // å†…å­˜ä¿¡æ¯
    },
    "bindTime": ISODate("..."),           // ç»‘å®šæ—¶é—´
    "lastLoginTime": ISODate("..."),      // æœ€åç™»å½•æ—¶é—´
    "loginCount": 25,                     // ç™»å½•æ¬¡æ•°
    "isOnline": false                     // æ˜¯å¦åœ¨çº¿
  },
  "security": {
    "loginAttempts": 0,                   // ç™»å½•å°è¯•æ¬¡æ•°
    "lastFailedLogin": null,              // æœ€åå¤±è´¥ç™»å½•æ—¶é—´
    "lockUntil": null,                    // é”å®šåˆ°æœŸæ—¶é—´
    "ipWhitelist": [],                    // IPç™½åå•
    "suspiciousActivity": []              // å¯ç–‘æ´»åŠ¨è®°å½•
  },
  "metadata": {
    "createdAt": ISODate("..."),          // åˆ›å»ºæ—¶é—´
    "updatedAt": ISODate("..."),          // æ›´æ–°æ—¶é—´
    "createdBy": "admin",                 // åˆ›å»ºè€…
    "source": "manual"                    // åˆ›å»ºæ¥æºï¼šmanual/import/api
  }
}
```

### **2.2 ç™»å½•æ—¥å¿—ç»“æ„è®¾è®¡**
```javascript
// ç™»å½•æ—¥å¿—é›†åˆ
{
  "_id": ObjectId("..."),
  "userId": "user_15155712316",
  "phone": "15155712316",
  "loginTime": ISODate("..."),
  "loginResult": "success",               // success/failed/blocked
  "machineCode": "9DC6B72833DBFDA6",
  "deviceInfo": {
    "os": "Windows 10",
    "ip": "192.168.1.100",
    "userAgent": "PyQt5 Client v1.0"
  },
  "failureReason": null,                  // å¤±è´¥åŸå› 
  "sessionDuration": 3600,                // ä¼šè¯æ—¶é•¿ï¼ˆç§’ï¼‰
  "logoutTime": ISODate("..."),           // ç™»å‡ºæ—¶é—´
  "logoutReason": "manual"                // ç™»å‡ºåŸå› 
}
```

### **2.3 æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**
```javascript
// å¿…éœ€ç´¢å¼•
db.users.createIndex({"phone": 1}, {"unique": true})
db.users.createIndex({"device.machineCode": 1})
db.users.createIndex({"account.status.code": 1})
db.users.createIndex({"device.lastLoginTime": -1})
db.users.createIndex({"metadata.createdAt": -1})

// å¤åˆç´¢å¼•
db.users.createIndex({"phone": 1, "account.status.code": 1})
db.users.createIndex({"device.machineCode": 1, "account.status.code": 1})

// ç™»å½•æ—¥å¿—ç´¢å¼•
db.loginLogs.createIndex({"userId": 1, "loginTime": -1})
db.loginLogs.createIndex({"phone": 1, "loginTime": -1})
db.loginLogs.createIndex({"machineCode": 1, "loginTime": -1})
db.loginLogs.createIndex({"loginTime": -1})
```

---

## ğŸš€ **3. APIæ¥å£ä¼˜åŒ–æ–¹æ¡ˆ**

### **3.1 ç™»å½•APIä¼˜åŒ–å®ç°**
```python
# api_v2.py - ä¼˜åŒ–åçš„ç™»å½•API
from flask import Flask, request, jsonify
from pymongo import MongoClient
from datetime import datetime, timedelta
import jwt
import hashlib
import platform
import socket
import time

class UserAuthAPI:
    def __init__(self):
        self.client = MongoClient("mongodb://userdb:userdb@127.0.0.1:27017/userdb")
        self.db = self.client["userdb"]
        self.users = self.db["users"]
        self.login_logs = self.db["loginLogs"]
        self.jwt_secret = "your-jwt-secret-key"

    def login(self, request_data):
        """ä¼˜åŒ–çš„ç™»å½•API"""
        try:
            # 1. å‚æ•°éªŒè¯
            phone = request_data.get("phone")
            machine_code = request_data.get("machineCode")
            device_info = request_data.get("deviceInfo", {})

            if not phone or not machine_code:
                return self._error_response("æ‰‹æœºå·å’Œæœºå™¨ç ä¸èƒ½ä¸ºç©º", 400)

            # 2. æ‰‹æœºå·æ ¼å¼éªŒè¯
            if not self._validate_phone(phone):
                return self._error_response("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®", 400)

            # 3. æŸ¥æ‰¾ç”¨æˆ·
            user = self.users.find_one({"phone": phone})
            if not user:
                self._log_login_attempt(phone, machine_code, "failed", "ç”¨æˆ·ä¸å­˜åœ¨")
                return self._error_response("æ‰‹æœºå·æœªæ³¨å†Œï¼Œè¯·è”ç³»ç®¡ç†å‘˜", 403)

            # 4. è´¦å·çŠ¶æ€æ£€æŸ¥
            if user.get("account", {}).get("status", {}).get("code", 1) != 1:
                status_reason = user.get("account", {}).get("status", {}).get("reason", "è´¦å·è¢«ç¦ç”¨")
                self._log_login_attempt(phone, machine_code, "blocked", status_reason)
                return self._error_response(f"è´¦å·å·²è¢«ç¦ç”¨ï¼š{status_reason}", 403)

            # 5. è®¾å¤‡ç»‘å®šéªŒè¯
            bind_result = self._verify_device_binding(user, machine_code, device_info)
            if not bind_result["success"]:
                self._log_login_attempt(phone, machine_code, "failed", bind_result["message"])
                return self._error_response(bind_result["message"], 403)

            # 6. æ›´æ–°ç”¨æˆ·ç™»å½•ä¿¡æ¯
            self._update_user_login_info(user["_id"], machine_code, device_info)

            # 7. ç”ŸæˆJWT Token
            token = self._generate_jwt_token(user)

            # 8. è®°å½•æˆåŠŸç™»å½•
            self._log_login_attempt(phone, machine_code, "success", "ç™»å½•æˆåŠŸ")

            # 9. æ„å»ºå“åº”æ•°æ®
            response_data = self._build_login_response(user, token)

            return self._success_response(response_data, "ç™»å½•æˆåŠŸ")

        except Exception as e:
            print(f"ç™»å½•APIå¼‚å¸¸: {e}")
            return self._error_response("æœåŠ¡å™¨å†…éƒ¨é”™è¯¯", 500)

    def _verify_device_binding(self, user, machine_code, device_info):
        """éªŒè¯è®¾å¤‡ç»‘å®š"""
        user_machine_code = user.get("device", {}).get("machineCode")

        if not user_machine_code:
            # é¦–æ¬¡ç™»å½•ï¼Œç»‘å®šè®¾å¤‡
            return {"success": True, "action": "bind"}
        elif user_machine_code == machine_code:
            # è®¾å¤‡åŒ¹é…
            return {"success": True, "action": "verify"}
        else:
            # è®¾å¤‡ä¸åŒ¹é…
            return {
                "success": False,
                "message": f"è®¾å¤‡æœªæˆæƒï¼Œå½“å‰è®¾å¤‡æœºå™¨ç ä¸ç»‘å®šè®¾å¤‡ä¸åŒ¹é…\nè¯·è”ç³»ç®¡ç†å‘˜é‡æ–°ç»‘å®šè®¾å¤‡"
            }

    def _update_user_login_info(self, user_id, machine_code, device_info):
        """æ›´æ–°ç”¨æˆ·ç™»å½•ä¿¡æ¯"""
        update_data = {
            "device.machineCode": machine_code,
            "device.lastLoginTime": datetime.now(),
            "device.isOnline": True,
            "metadata.updatedAt": datetime.now()
        }

        # æ›´æ–°è®¾å¤‡ä¿¡æ¯
        if device_info:
            update_data.update({
                "device.deviceInfo.os": device_info.get("os", "Unknown"),
                "device.deviceInfo.hostname": device_info.get("hostname", "Unknown"),
                "device.deviceInfo.ip": device_info.get("ip", "Unknown")
            })

        # å¢åŠ ç™»å½•æ¬¡æ•°
        self.users.update_one(
            {"_id": user_id},
            {
                "$set": update_data,
                "$inc": {"device.loginCount": 1}
            }
        )

    def _generate_jwt_token(self, user):
        """ç”ŸæˆJWT Token"""
        payload = {
            "userId": str(user["_id"]),
            "phone": user["phone"],
            "iat": int(time.time()),
            "exp": int(time.time()) + 86400  # 24å°æ—¶è¿‡æœŸ
        }
        return jwt.encode(payload, self.jwt_secret, algorithm="HS256")

    def _build_login_response(self, user, token):
        """æ„å»ºç™»å½•å“åº”æ•°æ®"""
        return {
            "userId": str(user["_id"]),
            "profile": {
                "phone": user["phone"],
                "displayName": user.get("profile", {}).get("displayName", f"ç”¨æˆ·{user['phone']}"),
                "nickname": user.get("profile", {}).get("nickname"),
                "avatar": user.get("profile", {}).get("avatar")
            },
            "account": {
                "points": user.get("account", {}).get("points", 0),
                "level": user.get("account", {}).get("level", "æ™®é€šç”¨æˆ·"),
                "status": user.get("account", {}).get("status", {"code": 1, "text": "æ­£å¸¸"}),
                "permissions": user.get("account", {}).get("permissions", ["login", "order"])
            },
            "device": {
                "machineCode": user.get("device", {}).get("machineCode"),
                "bindTime": user.get("device", {}).get("bindTime"),
                "lastLoginTime": user.get("device", {}).get("lastLoginTime"),
                "loginCount": user.get("device", {}).get("loginCount", 0)
            },
            "auth": {
                "token": token,
                "expiresIn": 86400,
                "tokenType": "Bearer"
            },
            # å…¼å®¹æ€§å­—æ®µï¼ˆä¿æŒç°æœ‰å®¢æˆ·ç«¯æ­£å¸¸å·¥ä½œï¼‰
            "phone": user["phone"],
            "username": user["phone"],
            "points": user.get("account", {}).get("points", 0),
            "status": user.get("account", {}).get("status", {}).get("code", 1),
            "machineCode": user.get("device", {}).get("machineCode")
        }

    def _log_login_attempt(self, phone, machine_code, result, reason):
        """è®°å½•ç™»å½•å°è¯•"""
        log_entry = {
            "phone": phone,
            "machineCode": machine_code,
            "loginTime": datetime.now(),
            "loginResult": result,
            "failureReason": reason if result != "success" else None,
            "deviceInfo": {
                "os": platform.system(),
                "ip": request.environ.get('HTTP_X_FORWARDED_FOR', request.environ.get('REMOTE_ADDR', 'Unknown'))
            }
        }
        self.login_logs.insert_one(log_entry)

    def _validate_phone(self, phone):
        """éªŒè¯æ‰‹æœºå·æ ¼å¼"""
        import re
        pattern = r'^1[3-9]\d{9}$'
        return re.match(pattern, phone) is not None

    def _success_response(self, data, message="æ“ä½œæˆåŠŸ"):
        """æˆåŠŸå“åº”æ ¼å¼"""
        return {
            "success": True,
            "message": message,
            "data": data,
            "timestamp": datetime.now().isoformat()
        }

    def _error_response(self, message, code=400):
        """é”™è¯¯å“åº”æ ¼å¼"""
        return {
            "success": False,
            "message": message,
            "error_code": code,
            "timestamp": datetime.now().isoformat()
        }

# Flaskè·¯ç”±é›†æˆ
app = Flask(__name__)
auth_api = UserAuthAPI()

@app.route("/api/v2/login", methods=["POST"])
def login_v2():
    """æ–°ç‰ˆæœ¬ç™»å½•API"""
    return jsonify(auth_api.login(request.json))
```

### **3.2 è®¾å¤‡ç®¡ç†API**
```python
class DeviceManagementAPI:
    def __init__(self, db):
        self.users = db["users"]
        self.login_logs = db["loginLogs"]

    def unbind_device(self, phone, admin_reason="ç®¡ç†å‘˜æ“ä½œ"):
        """è§£ç»‘ç”¨æˆ·è®¾å¤‡"""
        try:
            user = self.users.find_one({"phone": phone})
            if not user:
                return {"success": False, "message": "ç”¨æˆ·ä¸å­˜åœ¨"}

            # è§£ç»‘è®¾å¤‡
            self.users.update_one(
                {"phone": phone},
                {
                    "$unset": {"device.machineCode": ""},
                    "$set": {
                        "device.unbindTime": datetime.now(),
                        "device.unbindReason": admin_reason,
                        "device.isOnline": False,
                        "metadata.updatedAt": datetime.now()
                    }
                }
            )

            return {"success": True, "message": "è®¾å¤‡è§£ç»‘æˆåŠŸ"}

        except Exception as e:
            return {"success": False, "message": f"è§£ç»‘å¤±è´¥: {str(e)}"}

    def rebind_device(self, phone, new_machine_code, admin_reason="ç®¡ç†å‘˜é‡æ–°ç»‘å®š"):
        """é‡æ–°ç»‘å®šç”¨æˆ·è®¾å¤‡"""
        try:
            user = self.users.find_one({"phone": phone})
            if not user:
                return {"success": False, "message": "ç”¨æˆ·ä¸å­˜åœ¨"}

            # é‡æ–°ç»‘å®šè®¾å¤‡
            self.users.update_one(
                {"phone": phone},
                {
                    "$set": {
                        "device.machineCode": new_machine_code,
                        "device.bindTime": datetime.now(),
                        "device.rebindReason": admin_reason,
                        "device.isOnline": False,
                        "metadata.updatedAt": datetime.now()
                    }
                }
            )

            return {"success": True, "message": "è®¾å¤‡é‡æ–°ç»‘å®šæˆåŠŸ"}

        except Exception as e:
            return {"success": False, "message": f"é‡æ–°ç»‘å®šå¤±è´¥: {str(e)}"}

    def get_device_info(self, phone):
        """è·å–ç”¨æˆ·è®¾å¤‡ä¿¡æ¯"""
        try:
            user = self.users.find_one({"phone": phone})
            if not user:
                return {"success": False, "message": "ç”¨æˆ·ä¸å­˜åœ¨"}

            device_info = user.get("device", {})
            return {
                "success": True,
                "data": {
                    "machineCode": device_info.get("machineCode"),
                    "deviceInfo": device_info.get("deviceInfo", {}),
                    "bindTime": device_info.get("bindTime"),
                    "lastLoginTime": device_info.get("lastLoginTime"),
                    "loginCount": device_info.get("loginCount", 0),
                    "isOnline": device_info.get("isOnline", False)
                }
            }

        except Exception as e:
            return {"success": False, "message": f"è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥: {str(e)}"}

# Flaskè·¯ç”±
device_api = DeviceManagementAPI(auth_api.db)

@app.route("/api/v2/admin/device/unbind", methods=["POST"])
def unbind_device():
    """è§£ç»‘è®¾å¤‡API"""
    data = request.json
    phone = data.get("phone")
    reason = data.get("reason", "ç®¡ç†å‘˜æ“ä½œ")
    return jsonify(device_api.unbind_device(phone, reason))

@app.route("/api/v2/admin/device/rebind", methods=["POST"])
def rebind_device():
    """é‡æ–°ç»‘å®šè®¾å¤‡API"""
    data = request.json
    phone = data.get("phone")
    machine_code = data.get("machineCode")
    reason = data.get("reason", "ç®¡ç†å‘˜é‡æ–°ç»‘å®š")
    return jsonify(device_api.rebind_device(phone, machine_code, reason))
```

---

## ğŸ–¥ï¸ **4. å®¢æˆ·ç«¯é€‚é…ä¼˜åŒ–**

### **4.1 å¢å¼ºçš„æœºå™¨ç è·å–**
```python
# utils/machine_code_enhanced.py
import platform
import subprocess
import hashlib
import socket
import uuid
import psutil
from typing import Dict, Optional

class EnhancedMachineCodeGenerator:
    """å¢å¼ºçš„æœºå™¨ç ç”Ÿæˆå™¨"""

    def __init__(self):
        self.cache_file = "machine_info.cache"
        self._cached_info = None

    def get_machine_code(self) -> str:
        """è·å–æœºå™¨ç ï¼ˆä¸»æ–¹æ³•ï¼‰"""
        try:
            # å°è¯•ä»ç¼“å­˜è·å–
            if self._cached_info:
                return self._cached_info["machineCode"]

            # ç”Ÿæˆæ–°çš„æœºå™¨ç 
            machine_info = self._collect_machine_info()
            machine_code = self._generate_machine_code(machine_info)

            # ç¼“å­˜æœºå™¨ä¿¡æ¯
            self._cached_info = {
                "machineCode": machine_code,
                "machineInfo": machine_info,
                "generatedAt": datetime.now().isoformat()
            }

            self._save_cache()
            return machine_code

        except Exception as e:
            print(f"è·å–æœºå™¨ç å¤±è´¥: {e}")
            # è¿”å›å¤‡ç”¨æœºå™¨ç 
            return self._get_fallback_machine_code()

    def get_device_info(self) -> Dict:
        """è·å–è¯¦ç»†è®¾å¤‡ä¿¡æ¯"""
        try:
            return {
                "os": f"{platform.system()} {platform.release()}",
                "hostname": socket.gethostname(),
                "cpu": self._get_cpu_info(),
                "memory": self._get_memory_info(),
                "disk": self._get_disk_info(),
                "network": self._get_network_info(),
                "machineCode": self.get_machine_code()
            }
        except Exception as e:
            print(f"è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥: {e}")
            return {
                "os": "Unknown",
                "hostname": "Unknown",
                "machineCode": self.get_machine_code()
            }

    def _collect_machine_info(self) -> Dict:
        """æ”¶é›†æœºå™¨ä¿¡æ¯"""
        info = {}

        try:
            # åŸºç¡€ç³»ç»Ÿä¿¡æ¯
            info["platform"] = platform.platform()
            info["machine"] = platform.machine()
            info["processor"] = platform.processor()
            info["hostname"] = socket.gethostname()

            # MACåœ°å€
            info["mac"] = ':'.join(['{:02x}'.format((uuid.getnode() >> elements) & 0xff)
                                   for elements in range(0,2*6,2)][::-1])

            # CPUä¿¡æ¯
            if hasattr(psutil, 'cpu_count'):
                info["cpu_count"] = psutil.cpu_count()

            # å†…å­˜ä¿¡æ¯
            if hasattr(psutil, 'virtual_memory'):
                memory = psutil.virtual_memory()
                info["memory_total"] = memory.total

            # ç£ç›˜åºåˆ—å·ï¼ˆWindowsï¼‰
            if platform.system() == "Windows":
                try:
                    result = subprocess.run(
                        ["wmic", "diskdrive", "get", "serialnumber"],
                        capture_output=True, text=True, timeout=5
                    )
                    if result.returncode == 0:
                        lines = result.stdout.strip().split('\n')
                        for line in lines[1:]:  # è·³è¿‡æ ‡é¢˜è¡Œ
                            serial = line.strip()
                            if serial and serial != "SerialNumber":
                                info["disk_serial"] = serial
                                break
                except Exception:
                    pass

            # ä¸»æ¿åºåˆ—å·ï¼ˆWindowsï¼‰
            if platform.system() == "Windows":
                try:
                    result = subprocess.run(
                        ["wmic", "baseboard", "get", "serialnumber"],
                        capture_output=True, text=True, timeout=5
                    )
                    if result.returncode == 0:
                        lines = result.stdout.strip().split('\n')
                        for line in lines[1:]:
                            serial = line.strip()
                            if serial and serial != "SerialNumber":
                                info["motherboard_serial"] = serial
                                break
                except Exception:
                    pass

        except Exception as e:
            print(f"æ”¶é›†æœºå™¨ä¿¡æ¯å¤±è´¥: {e}")

        return info

    def _generate_machine_code(self, machine_info: Dict) -> str:
        """ç”Ÿæˆæœºå™¨ç """
        # é€‰æ‹©æœ€ç¨³å®šçš„ç¡¬ä»¶æ ‡è¯†ç¬¦
        identifiers = []

        # ä¼˜å…ˆçº§é¡ºåºï¼šä¸»æ¿åºåˆ—å· > ç£ç›˜åºåˆ—å· > MACåœ°å€ > ä¸»æœºå
        if "motherboard_serial" in machine_info:
            identifiers.append(machine_info["motherboard_serial"])

        if "disk_serial" in machine_info:
            identifiers.append(machine_info["disk_serial"])

        if "mac" in machine_info:
            identifiers.append(machine_info["mac"])

        if "hostname" in machine_info:
            identifiers.append(machine_info["hostname"])

        # æ·»åŠ ç³»ç»Ÿä¿¡æ¯ä½œä¸ºè¾…åŠ©æ ‡è¯†
        identifiers.extend([
            machine_info.get("platform", ""),
            machine_info.get("processor", ""),
            str(machine_info.get("memory_total", ""))
        ])

        # ç”Ÿæˆå“ˆå¸Œ
        combined = "|".join(filter(None, identifiers))
        hash_obj = hashlib.sha256(combined.encode('utf-8'))

        # è¿”å›16ä½å¤§å†™åå…­è¿›åˆ¶
        return hash_obj.hexdigest()[:16].upper()

    def _get_fallback_machine_code(self) -> str:
        """è·å–å¤‡ç”¨æœºå™¨ç """
        try:
            # ä½¿ç”¨MACåœ°å€ä½œä¸ºå¤‡ç”¨
            mac = uuid.getnode()
            return f"{mac:012X}"[:16]
        except:
            # æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ
            return "DEFAULT12345678"

    def _get_cpu_info(self) -> str:
        """è·å–CPUä¿¡æ¯"""
        try:
            if platform.system() == "Windows":
                result = subprocess.run(
                    ["wmic", "cpu", "get", "name"],
                    capture_output=True, text=True, timeout=5
                )
                if result.returncode == 0:
                    lines = result.stdout.strip().split('\n')
                    for line in lines[1:]:
                        cpu_name = line.strip()
                        if cpu_name and cpu_name != "Name":
                            return cpu_name
            return platform.processor() or "Unknown CPU"
        except:
            return "Unknown CPU"

    def _get_memory_info(self) -> str:
        """è·å–å†…å­˜ä¿¡æ¯"""
        try:
            if hasattr(psutil, 'virtual_memory'):
                memory = psutil.virtual_memory()
                gb = memory.total / (1024**3)
                return f"{gb:.1f}GB"
            return "Unknown"
        except:
            return "Unknown"

    def _get_disk_info(self) -> str:
        """è·å–ç£ç›˜ä¿¡æ¯"""
        try:
            if hasattr(psutil, 'disk_usage'):
                disk = psutil.disk_usage('/')
                gb = disk.total / (1024**3)
                return f"{gb:.1f}GB"
            return "Unknown"
        except:
            return "Unknown"

    def _get_network_info(self) -> str:
        """è·å–ç½‘ç»œä¿¡æ¯"""
        try:
            hostname = socket.gethostname()
            ip = socket.gethostbyname(hostname)
            return f"{hostname} ({ip})"
        except:
            return "Unknown"

    def _save_cache(self):
        """ä¿å­˜ç¼“å­˜"""
        try:
            import json
            with open(self.cache_file, 'w', encoding='utf-8') as f:
                json.dump(self._cached_info, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"ä¿å­˜æœºå™¨ç ç¼“å­˜å¤±è´¥: {e}")

    def _load_cache(self):
        """åŠ è½½ç¼“å­˜"""
        try:
            import json
            with open(self.cache_file, 'r', encoding='utf-8') as f:
                self._cached_info = json.load(f)
        except:
            self._cached_info = None

# å…¨å±€å®ä¾‹
enhanced_machine_code = EnhancedMachineCodeGenerator()
```

### **4.2 ä¼˜åŒ–çš„è®¤è¯æœåŠ¡**
```python
# services/auth_service_enhanced.py
import requests
import json
import time
from typing import Tuple, Optional, Dict
from utils.machine_code_enhanced import enhanced_machine_code

class EnhancedAuthService:
    """å¢å¼ºçš„è®¤è¯æœåŠ¡"""

    def __init__(self, api_base_url: str = "http://your-server:5000"):
        self.api_base_url = api_base_url.rstrip('/')
        self.current_user = None
        self.session_token = None
        self.token_expires_at = 0
        self.machine_code_generator = enhanced_machine_code

    def login(self, phone: str) -> Tuple[bool, str, Optional[Dict]]:
        """å¢å¼ºçš„ç™»å½•æ–¹æ³•"""
        try:
            # 1. éªŒè¯æ‰‹æœºå·æ ¼å¼
            if not self._validate_phone(phone):
                return False, "è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ", None

            # 2. è·å–æœºå™¨ç å’Œè®¾å¤‡ä¿¡æ¯
            machine_code = self.machine_code_generator.get_machine_code()
            device_info = self.machine_code_generator.get_device_info()

            print(f"[ç™»å½•] æ‰‹æœºå·: {phone}")
            print(f"[ç™»å½•] æœºå™¨ç : {machine_code}")
            print(f"[ç™»å½•] è®¾å¤‡ä¿¡æ¯: {device_info['os']} - {device_info['hostname']}")

            # 3. æ„å»ºç™»å½•è¯·æ±‚
            login_data = {
                "phone": phone,
                "machineCode": machine_code,
                "deviceInfo": {
                    "os": device_info["os"],
                    "hostname": device_info["hostname"],
                    "ip": self._get_local_ip(),
                    "userAgent": "PyQt5 Client v2.0"
                },
                "timestamp": int(time.time())
            }

            # 4. å‘é€ç™»å½•è¯·æ±‚
            response = self._call_api("/api/v2/login", login_data, method="POST")

            if response.get("success"):
                user_info = response.get("data", {})

                # 5. ä¿å­˜è®¤è¯ä¿¡æ¯
                self.current_user = user_info
                self.session_token = user_info.get("auth", {}).get("token")
                self.token_expires_at = int(time.time()) + user_info.get("auth", {}).get("expiresIn", 86400)

                # 6. ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                self._save_user_cache(user_info)

                print(f"[ç™»å½•] ç™»å½•æˆåŠŸ")
                print(f"[ç™»å½•] ç”¨æˆ·: {user_info.get('profile', {}).get('displayName')}")
                print(f"[ç™»å½•] ç§¯åˆ†: {user_info.get('account', {}).get('points')}")
                print(f"[ç™»å½•] çŠ¶æ€: {user_info.get('account', {}).get('status', {}).get('text')}")

                return True, "ç™»å½•æˆåŠŸ", user_info
            else:
                error_msg = response.get("message", "ç™»å½•å¤±è´¥")
                print(f"[ç™»å½•] ç™»å½•å¤±è´¥: {error_msg}")
                return False, error_msg, None

        except requests.exceptions.ConnectionError:
            return False, "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥", None
        except requests.exceptions.Timeout:
            return False, "è¿æ¥è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•", None
        except Exception as e:
            print(f"[ç™»å½•] ç™»å½•å¼‚å¸¸: {e}")
            return False, f"ç™»å½•å¼‚å¸¸: {str(e)}", None

    def check_auth(self) -> Tuple[bool, str, Optional[Dict]]:
        """æ£€æŸ¥è®¤è¯çŠ¶æ€"""
        try:
            # 1. æ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€
            if not self.current_user or not self.session_token:
                return False, "æœªç™»å½•", None

            # 2. æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
            if int(time.time()) >= self.token_expires_at:
                print("[è®¤è¯] Tokenå·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•")
                return False, "ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•", None

            # 3. éªŒè¯Tokenæœ‰æ•ˆæ€§ï¼ˆå¯é€‰ï¼Œå‡å°‘æœåŠ¡å™¨å‹åŠ›ï¼‰
            # è¿™é‡Œå¯ä»¥æ·»åŠ TokenéªŒè¯é€»è¾‘

            return True, "è®¤è¯æœ‰æ•ˆ", self.current_user

        except Exception as e:
            print(f"[è®¤è¯] è®¤è¯æ£€æŸ¥å¼‚å¸¸: {e}")
            return False, f"è®¤è¯æ£€æŸ¥å¤±è´¥: {str(e)}", None

    def logout(self):
        """ç™»å‡º"""
        try:
            # æ¸…é™¤æœ¬åœ°çŠ¶æ€
            self.current_user = None
            self.session_token = None
            self.token_expires_at = 0

            # æ¸…é™¤æœ¬åœ°ç¼“å­˜
            self._clear_user_cache()

            print("[ç™»å‡º] ç”¨æˆ·å·²ç™»å‡º")

        except Exception as e:
            print(f"[ç™»å‡º] ç™»å‡ºå¼‚å¸¸: {e}")

    def _call_api(self, endpoint: str, data: Dict, method: str = "GET") -> Dict:
        """è°ƒç”¨API"""
        url = f"{self.api_base_url}{endpoint}"
        headers = {
            "Content-Type": "application/json",
            "User-Agent": "PyQt5 Client v2.0"
        }

        # æ·»åŠ è®¤è¯å¤´
        if self.session_token:
            headers["Authorization"] = f"Bearer {self.session_token}"

        try:
            if method == "POST":
                response = requests.post(url, json=data, headers=headers, timeout=10)
            else:
                response = requests.get(url, params=data, headers=headers, timeout=10)

            response.raise_for_status()
            return response.json()

        except requests.exceptions.RequestException as e:
            print(f"APIè°ƒç”¨å¤±è´¥: {e}")
            raise

    def _validate_phone(self, phone: str) -> bool:
        """éªŒè¯æ‰‹æœºå·æ ¼å¼"""
        import re
        pattern = r'^1[3-9]\d{9}$'
        return re.match(pattern, phone) is not None

    def _get_local_ip(self) -> str:
        """è·å–æœ¬åœ°IPåœ°å€"""
        try:
            import socket
            s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
            s.connect(("8.8.8.8", 80))
            ip = s.getsockname()[0]
            s.close()
            return ip
        except:
            return "Unknown"

    def _save_user_cache(self, user_info: Dict):
        """ä¿å­˜ç”¨æˆ·ç¼“å­˜"""
        try:
            cache_data = {
                "user_info": user_info,
                "session_token": self.session_token,
                "token_expires_at": self.token_expires_at,
                "cached_at": int(time.time())
            }

            with open("user_cache.json", "w", encoding="utf-8") as f:
                json.dump(cache_data, f, ensure_ascii=False, indent=2)

        except Exception as e:
            print(f"ä¿å­˜ç”¨æˆ·ç¼“å­˜å¤±è´¥: {e}")

    def _clear_user_cache(self):
        """æ¸…é™¤ç”¨æˆ·ç¼“å­˜"""
        try:
            import os
            if os.path.exists("user_cache.json"):
                os.remove("user_cache.json")
        except Exception as e:
            print(f"æ¸…é™¤ç”¨æˆ·ç¼“å­˜å¤±è´¥: {e}")

# å…¨å±€å®ä¾‹
enhanced_auth_service = EnhancedAuthService()
```
```