# 乐影系统 API 功能升级部署指导

## 📋 升级概览

本次升级为线上API服务器（http://43.142.19.28:5000）添加了以下功能：

### ✅ 新增API端点
- `POST /update_machine_code` - 更新用户机器码
- `POST /update_user_points` - 更新用户积分
- `POST /toggle_user_status` - 切换用户状态

### 🎨 界面优化
- 美化的管理后台界面
- 当前设备机器码显示：`9DC6B72833DBFDA6`
- 一键填入机器码功能

---

## 🚀 部署步骤

### 1. 备份现有代码
```bash
# 在服务器上备份当前代码
cp your_current_api.py your_current_api.py.backup.$(date +%Y%m%d_%H%M%S)
```

### 2. 替换API代码
将 `完整线上API代码.py` 的内容完全替换线上服务器的Python文件。

### 3. 重启API服务
```bash
# 停止现有服务
pkill -f "python.*api"

# 启动新的API服务
python3 完整线上API代码.py
```

### 4. 验证服务状态
```bash
# 检查服务是否正常运行
curl http://43.142.19.28:5000/
curl http://43.142.19.28:5000/health
```

---

## 🔧 关键功能测试

### 1. 更新机器码测试
```bash
curl -X POST http://43.142.19.28:5000/update_machine_code \
  -H "Content-Type: application/json" \
  -d '{"phone": "15155712316", "machineCode": "9DC6B72833DBFDA6"}'
```

预期响应：
```json
{
  "success": true,
  "message": "机器码更新成功",
  "data": {
    "phone": "15155712316",
    "machineCode": "9DC6B72833DBFDA6",
    "updateTime": "2025-01-28 xx:xx:xx"
  }
}
```

### 2. 客户端登录测试
更新机器码后，客户端应该能够使用新机器码正常登录：
```bash
curl -X POST http://43.142.19.28:5000/login \
  -H "Content-Type: application/json" \
  -d '{"phone": "15155712316", "machineCode": "9DC6B72833DBFDA6"}'
```

### 3. 管理后台访问
访问 http://43.142.19.28:5000/admin 查看美化的管理界面。

---

## 📱 客户端集成

客户端代码已经修改为使用真实机器码，启动时会显示：
```
[机器码生成] 生成的机器码: 9DC6B72833DBFDA6
```

### 机器码同步流程：
1. 客户端启动时自动生成真实机器码
2. 管理员通过后台将用户的机器码更新为 `9DC6B72833DBFDA6`
3. 客户端即可正常登录和使用

---

## 🔍 故障排除

### 问题1：API端点返回404
**原因：** 新功能尚未部署到线上服务器
**解决：** 按照部署步骤替换完整代码并重启服务

### 问题2：机器码更新失败
**原因：** 
- 用户不存在
- 数据库连接问题
**解决：** 检查用户是否存在，验证数据库连接

### 问题3：客户端无法登录
**原因：** 机器码不匹配
**解决：** 通过管理后台更新用户机器码为 `9DC6B72833DBFDA6`

---

## 📊 API完整端点列表

| 方法 | 端点 | 功能 | 状态 |
|------|------|------|------|
| GET | `/` | 服务状态 | ✅ 原有 |
| GET | `/health` | 健康检查 | ✅ 原有 |
| POST | `/login` | 用户登录 | ✅ 原有 |
| POST | `/set_points` | 设置积分 | ✅ 原有 |
| POST | `/set_status` | 设置状态 | ✅ 原有 |
| GET | `/admin` | 管理后台 | ✅ 原有 |
| POST | `/update_machine_code` | 更新机器码 | 🆕 新增 |
| POST | `/update_user_points` | 更新积分 | 🆕 新增 |
| POST | `/toggle_user_status` | 切换状态 | 🆕 新增 |

---

## 🎯 重要提醒

1. **机器码同步**：部署后立即通过管理后台将手机号 `15155712316` 的机器码更新为 `9DC6B72833DBFDA6`

2. **客户端测试**：确保客户端能够正常登录和使用所有功能

3. **备份重要**：部署前务必备份现有代码，以防出现问题时可以快速回滚

4. **监控日志**：部署后监控服务器日志，确认所有功能正常工作

---

## ✅ 部署完成检查清单

- [ ] 备份现有代码
- [ ] 替换API代码文件
- [ ] 重启API服务
- [ ] 验证基本API功能
- [ ] 测试新增的机器码管理功能
- [ ] 访问管理后台界面
- [ ] 更新测试用户机器码
- [ ] 验证客户端登录功能
- [ ] 监控系统日志

---

**部署完成后，所有测试失败的API功能将变为可用状态！** 🎉 