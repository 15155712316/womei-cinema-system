# ğŸ¯ PyQt5æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦è§£ - ç¬¬äºŒéƒ¨åˆ†ï¼šåˆ¸ç®¡ç†å’Œåº§ä½é€‰æ‹©

## ğŸ« 4. å…‘æ¢åˆ¸Tabå®ç°è¯¦è§£

### 4.1 å…‘æ¢åˆ¸ç•Œé¢å¸ƒå±€
```
å…‘æ¢åˆ¸Tabé¡µé¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½“å‰è´¦å·ï¼š15155712316 @ ä¸‡å‹å½±åŸ (ä½™é¢:Â¥400.0 ç§¯åˆ†:3833)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [åˆ·æ–°åˆ¸åˆ—è¡¨]    åˆ¸ç±»å‹: [å…¨éƒ¨ â–¼]    çŠ¶æ€: [å¯ç”¨ â–¼]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    å¯å…‘æ¢åˆ¸åˆ—è¡¨                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   åˆ¸åç§°    â”‚    åˆ¸ç       â”‚ é¢å€¼   â”‚  çŠ¶æ€   â”‚  æ“ä½œ   â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ 10å…ƒä»£é‡‘åˆ¸  â”‚ A1234567890  â”‚ Â¥10.0  â”‚ å¯å…‘æ¢  â”‚ [å…‘æ¢]  â”‚ â”‚
â”‚ â”‚ 5å…ƒä¼˜æƒ åˆ¸   â”‚ B2345678901  â”‚ Â¥5.0   â”‚ å¯å…‘æ¢  â”‚ [å…‘æ¢]  â”‚ â”‚
â”‚ â”‚ å…è´¹è§‚å½±åˆ¸  â”‚ C3456789012  â”‚ Â¥35.0  â”‚ å·²å…‘æ¢  â”‚   --    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å…‘æ¢è®°å½•ï¼š                                                   â”‚
â”‚ â€¢ 2024-12-29 14:30 - å…‘æ¢ 10å…ƒä»£é‡‘åˆ¸ æˆåŠŸ                   â”‚
â”‚ â€¢ 2024-12-29 14:25 - å…‘æ¢ 5å…ƒä¼˜æƒ åˆ¸ æˆåŠŸ                    â”‚
â”‚ â€¢ 2024-12-29 14:20 - å…‘æ¢ å…è´¹è§‚å½±åˆ¸ å¤±è´¥ï¼šç§¯åˆ†ä¸è¶³         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å…‘æ¢åˆ¸Tabå®ç°ä»£ç 
```python
def build_coupon_exchange_tab(self, tab):
    """æ„å»ºå…‘æ¢åˆ¸Tab - åŸºäºç°æœ‰é€»è¾‘"""
    layout = QVBoxLayout(tab)
    
    # è´¦å·ä¿¡æ¯æ˜¾ç¤ºåŒº
    account_info_frame = QFrame()
    account_info_frame.setStyleSheet("QFrame { background-color: #f0f8ff; padding: 10px; border: 1px solid #ddd; }")
    account_info_layout = QHBoxLayout(account_info_frame)
    
    self.exchange_account_info = QLabel("å½“å‰è´¦å·ï¼šæœªé€‰æ‹©")
    self.exchange_account_info.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
    account_info_layout.addWidget(self.exchange_account_info)
    layout.addWidget(account_info_frame)
    
    # æ§åˆ¶æŒ‰é’®åŒº
    control_frame = QFrame()
    control_layout = QHBoxLayout(control_frame)
    
    refresh_btn = QPushButton("åˆ·æ–°åˆ¸åˆ—è¡¨")
    refresh_btn.clicked.connect(self.refresh_coupon_exchange_list)
    control_layout.addWidget(refresh_btn)
    
    # åˆ¸ç±»å‹ç­›é€‰
    control_layout.addWidget(QLabel("åˆ¸ç±»å‹:"))
    self.coupon_type_combo = QComboBox()
    self.coupon_type_combo.addItems(["å…¨éƒ¨", "ä»£é‡‘åˆ¸", "ä¼˜æƒ åˆ¸", "å…è´¹åˆ¸"])
    self.coupon_type_combo.currentTextChanged.connect(self.filter_exchange_coupons)
    control_layout.addWidget(self.coupon_type_combo)
    
    # çŠ¶æ€ç­›é€‰
    control_layout.addWidget(QLabel("çŠ¶æ€:"))
    self.coupon_status_combo = QComboBox()
    self.coupon_status_combo.addItems(["å…¨éƒ¨", "å¯å…‘æ¢", "å·²å…‘æ¢", "å·²è¿‡æœŸ"])
    self.coupon_status_combo.currentTextChanged.connect(self.filter_exchange_coupons)
    control_layout.addWidget(self.coupon_status_combo)
    
    control_layout.addStretch()
    layout.addWidget(control_frame)
    
    # å¯å…‘æ¢åˆ¸åˆ—è¡¨è¡¨æ ¼
    self.exchange_coupon_table = QTableWidget()
    self.exchange_coupon_table.setColumnCount(5)
    self.exchange_coupon_table.setHorizontalHeaderLabels(["åˆ¸åç§°", "åˆ¸ç ", "é¢å€¼", "çŠ¶æ€", "æ“ä½œ"])
    
    # è®¾ç½®åˆ—å®½
    header = self.exchange_coupon_table.horizontalHeader()
    header.resizeSection(0, 150)  # åˆ¸åç§°
    header.resizeSection(1, 120)  # åˆ¸ç 
    header.resizeSection(2, 80)   # é¢å€¼
    header.resizeSection(3, 80)   # çŠ¶æ€
    header.resizeSection(4, 80)   # æ“ä½œ
    
    layout.addWidget(self.exchange_coupon_table)
    
    # å…‘æ¢è®°å½•åŒº
    record_frame = QFrame()
    record_layout = QVBoxLayout(record_frame)
    record_layout.addWidget(QLabel("å…‘æ¢è®°å½•:"))
    
    self.exchange_record_text = QTextEdit()
    self.exchange_record_text.setMaximumHeight(100)
    self.exchange_record_text.setReadOnly(True)
    record_layout.addWidget(self.exchange_record_text)
    
    layout.addWidget(record_frame)
    
    # åˆå§‹åŒ–æ•°æ®
    self.exchange_coupon_data = []

def refresh_coupon_exchange_list(self):
    """åˆ·æ–°å¯å…‘æ¢åˆ¸åˆ—è¡¨"""
    account = getattr(self, 'current_account', None)
    if not account:
        QMessageBox.warning(self, "æœªé€‰æ‹©è´¦å·", "è¯·å…ˆé€‰æ‹©è´¦å·ï¼")
        return
    
    try:
        # è¿™é‡Œè°ƒç”¨ç§¯åˆ†å…‘æ¢API (å¦‚æœæœ‰çš„è¯)
        # ç›®å‰åŸºäºç°æœ‰æ•°æ®ç»“æ„æ¨¡æ‹Ÿ
        self.load_exchange_coupon_data(account)
        
    except Exception as e:
        QMessageBox.critical(self, "é”™è¯¯", f"åˆ·æ–°åˆ¸åˆ—è¡¨æ—¶å‡ºé”™ï¼š{str(e)}")

def load_exchange_coupon_data(self, account):
    """åŠ è½½å…‘æ¢åˆ¸æ•°æ® - åŸºäºç°æœ‰ç§¯åˆ†ç³»ç»Ÿ"""
    # æ¨¡æ‹Ÿå¯å…‘æ¢åˆ¸æ•°æ® (å®é™…åº”è¯¥ä»APIè·å–)
    sample_coupons = [
        {
            "couponName": "10å…ƒä»£é‡‘åˆ¸",
            "couponCode": "CASH10_" + str(int(time.time())),
            "faceValue": 10.0,
            "requiredPoints": 100,
            "status": "available",
            "couponType": "ä»£é‡‘åˆ¸"
        },
        {
            "couponName": "5å…ƒä¼˜æƒ åˆ¸", 
            "couponCode": "DISC5_" + str(int(time.time())),
            "faceValue": 5.0,
            "requiredPoints": 50,
            "status": "available",
            "couponType": "ä¼˜æƒ åˆ¸"
        },
        {
            "couponName": "å…è´¹è§‚å½±åˆ¸",
            "couponCode": "FREE_" + str(int(time.time())),
            "faceValue": 35.0,
            "requiredPoints": 350,
            "status": "available", 
            "couponType": "å…è´¹åˆ¸"
        }
    ]
    
    self.exchange_coupon_data = sample_coupons
    self.update_exchange_coupon_table(sample_coupons)

def update_exchange_coupon_table(self, coupons):
    """æ›´æ–°å…‘æ¢åˆ¸è¡¨æ ¼"""
    self.exchange_coupon_table.setRowCount(len(coupons))
    
    for row, coupon in enumerate(coupons):
        # åˆ¸åç§°
        self.exchange_coupon_table.setItem(row, 0, QTableWidgetItem(coupon['couponName']))
        
        # åˆ¸ç 
        self.exchange_coupon_table.setItem(row, 1, QTableWidgetItem(coupon['couponCode']))
        
        # é¢å€¼
        face_value = f"Â¥{coupon['faceValue']:.1f}"
        self.exchange_coupon_table.setItem(row, 2, QTableWidgetItem(face_value))
        
        # çŠ¶æ€
        status_text = "å¯å…‘æ¢" if coupon['status'] == 'available' else "å·²å…‘æ¢"
        status_item = QTableWidgetItem(status_text)
        if coupon['status'] == 'available':
            status_item.setBackground(QColor('#d4edda'))  # ç»¿è‰²
        else:
            status_item.setBackground(QColor('#f8d7da'))  # çº¢è‰²
        self.exchange_coupon_table.setItem(row, 3, status_item)
        
        # æ“ä½œæŒ‰é’®
        if coupon['status'] == 'available':
            exchange_btn = QPushButton("å…‘æ¢")
            exchange_btn.setStyleSheet("QPushButton { background-color: #007bff; color: white; }")
            exchange_btn.clicked.connect(lambda checked, idx=row: self.exchange_coupon(idx))
            self.exchange_coupon_table.setCellWidget(row, 4, exchange_btn)
        else:
            disabled_label = QLabel("--")
            disabled_label.setAlignment(Qt.AlignCenter)
            self.exchange_coupon_table.setCellWidget(row, 4, disabled_label)

def exchange_coupon(self, row_index):
    """å…‘æ¢åˆ¸åŠŸèƒ½"""
    if row_index >= len(self.exchange_coupon_data):
        return
        
    coupon = self.exchange_coupon_data[row_index]
    account = self.current_account
    
    # æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
    current_points = account.get('score', 0)
    required_points = coupon.get('requiredPoints', 0)
    
    if current_points < required_points:
        QMessageBox.warning(
            self, "ç§¯åˆ†ä¸è¶³", 
            f"å…‘æ¢ {coupon['couponName']} éœ€è¦ {required_points} ç§¯åˆ†ï¼Œå½“å‰åªæœ‰ {current_points} ç§¯åˆ†ï¼"
        )
        return
    
    # ç¡®è®¤å…‘æ¢
    reply = QMessageBox.question(
        self, "ç¡®è®¤å…‘æ¢",
        f"ç¡®å®šè¦ç”¨ {required_points} ç§¯åˆ†å…‘æ¢ {coupon['couponName']} å—ï¼Ÿ\n"
        f"å…‘æ¢åç§¯åˆ†ä½™é¢ï¼š{current_points - required_points}",
        QMessageBox.Yes | QMessageBox.No
    )
    
    if reply == QMessageBox.Yes:
        self.perform_coupon_exchange(coupon, required_points)

def perform_coupon_exchange(self, coupon, required_points):
    """æ‰§è¡Œå…‘æ¢æ“ä½œ"""
    try:
        # è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„å…‘æ¢API
        # ç›®å‰æ¨¡æ‹Ÿå…‘æ¢è¿‡ç¨‹
        
        account = self.current_account
        
        # æ›´æ–°ç§¯åˆ†
        account['score'] = account.get('score', 0) - required_points
        
        # ä¿å­˜è´¦å·æ•°æ®
        self.save_account_points_update(account)
        
        # æ·»åŠ å…‘æ¢è®°å½•
        self.add_exchange_record(coupon, True)
        
        # æ›´æ–°UI
        self.update_exchange_account_info()
        coupon['status'] = 'exchanged'
        self.update_exchange_coupon_table(self.exchange_coupon_data)
        
        QMessageBox.information(
            self, "å…‘æ¢æˆåŠŸ", 
            f"æˆåŠŸå…‘æ¢ {coupon['couponName']}ï¼\nåˆ¸ç ï¼š{coupon['couponCode']}"
        )
        
    except Exception as e:
        self.add_exchange_record(coupon, False, str(e))
        QMessageBox.critical(self, "å…‘æ¢å¤±è´¥", f"å…‘æ¢æ—¶å‘ç”Ÿé”™è¯¯ï¼š{str(e)}")

def add_exchange_record(self, coupon, success, error_msg=""):
    """æ·»åŠ å…‘æ¢è®°å½•"""
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M")
    if success:
        record = f"â€¢ {timestamp} - å…‘æ¢ {coupon['couponName']} æˆåŠŸ"
    else:
        record = f"â€¢ {timestamp} - å…‘æ¢ {coupon['couponName']} å¤±è´¥ï¼š{error_msg}"
    
    current_text = self.exchange_record_text.toPlainText()
    new_text = record + "\n" + current_text
    self.exchange_record_text.setPlainText(new_text)
```

---

## ğŸŸï¸ 5. ç»‘åˆ¸TabåŠŸèƒ½å®ç°è¯¦è§£

### 5.1 ç»‘åˆ¸Tabç•Œé¢å¸ƒå±€
```
ç»‘åˆ¸Tabé¡µé¢ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å½“å‰è´¦å·ï¼š15155712316 @ ä¸‡å‹å½±åŸ                            â”‚
â”‚ ä½™é¢ï¼šÂ¥400.0  ç§¯åˆ†ï¼š3833                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ¸å·è¾“å…¥åŒºåŸŸ     â”‚              ç»‘å®šæ—¥å¿—                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚æ¯è¡Œä¸€ä¸ªåˆ¸å·ï¼š â”‚ â”‚ â”‚ç»‘å®šæ—¥å¿—ï¼š                           â”‚ â”‚
â”‚ â”‚             â”‚ â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚AB1234567890 â”‚ â”‚ â”‚=== ç»‘å®šå®Œæˆ ===                    â”‚ â”‚
â”‚ â”‚CD2345678901 â”‚ â”‚ â”‚å…±2å¼ åˆ¸ï¼Œç»‘å®šæˆåŠŸ1ï¼Œå¤±è´¥1              â”‚ â”‚
â”‚ â”‚EF3456789012 â”‚ â”‚ â”‚åˆ¸AB1234567890 ç»‘å®šæˆåŠŸ              â”‚ â”‚
â”‚ â”‚             â”‚ â”‚ â”‚åˆ¸CD2345678901 ç»‘å®šå¤±è´¥ï¼šåˆ¸å·æ— æ•ˆ    â”‚ â”‚
â”‚ â”‚             â”‚ â”‚ â”‚                                     â”‚ â”‚
â”‚ â”‚             â”‚ â”‚ â”‚*** å»ºè®® ***                        â”‚ â”‚
â”‚ â”‚             â”‚ â”‚ â”‚å¦‚æœé¢‘ç¹å¤±è´¥è¯·æ£€æŸ¥ï¼š                  â”‚ â”‚
â”‚ â”‚             â”‚ â”‚ â”‚1. åˆ¸å·æ ¼å¼æ˜¯å¦æ­£ç¡®                  â”‚ â”‚
â”‚ â”‚             â”‚ â”‚ â”‚2. è´¦å·Tokenæ˜¯å¦æœ‰æ•ˆ                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ [ç»‘å®šå½“å‰è´¦å·]   â”‚ [å¤åˆ¶æ—¥å¿—]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 ç»‘åˆ¸Tabå®ç°ä»£ç 
```python
def build_bind_coupon_tab(self, tab):
    """æ„å»ºç»‘åˆ¸Tab - ç›´æ¥ä»æºä»£ç å¤åˆ¶å¹¶é€‚é…PyQt5"""
    main_layout = QHBoxLayout(tab)
    
    # å·¦ä¾§è¾“å…¥åŒº
    input_frame = QFrame()
    input_layout = QVBoxLayout(input_frame)
    
    # å½“å‰è´¦å·ä¿¡æ¯æ˜¾ç¤º
    self.bind_account_info = QLabel("å½“å‰è´¦å·ï¼šæœªé€‰æ‹©")
    self.bind_account_info.setFont(QFont("Microsoft YaHei", 10, QFont.Bold))
    self.bind_account_info.setStyleSheet("QLabel { color: red; background-color: #fff; padding: 10px; border: 1px solid #ddd; }")
    self.bind_account_info.setWordWrap(True)
    input_layout.addWidget(self.bind_account_info)
    
    # æç¤ºæ ‡ç­¾
    input_layout.addWidget(QLabel("æ¯è¡Œä¸€ä¸ªåˆ¸å·ï¼š"))
    
    # åˆ¸å·è¾“å…¥æ¡†
    self.coupon_text = QTextEdit()
    self.coupon_text.setFixedHeight(200)
    self.coupon_text.setPlaceholderText("è¯·åœ¨æ­¤è¾“å…¥åˆ¸å·ï¼Œæ¯è¡Œä¸€ä¸ª\nä¾‹å¦‚ï¼š\nAB1234567890\nCD2345678901\nEF3456789012")
    input_layout.addWidget(self.coupon_text)
    
    # ç»‘å®šæŒ‰é’®
    bind_btn = QPushButton("ç»‘å®šå½“å‰è´¦å·")
    bind_btn.setStyleSheet("""
        QPushButton {
            background-color: #4caf50;
            color: white;
            font: bold 11px "Microsoft YaHei";
            padding: 10px;
            border: none;
            border-radius: 5px;
        }
        QPushButton:hover {
            background-color: #45a049;
        }
    """)
    bind_btn.clicked.connect(self.on_bind_coupons)
    input_layout.addWidget(bind_btn)
    
    main_layout.addWidget(input_frame)
    
    # å³ä¾§æ—¥å¿—åŒº
    log_frame = QFrame()
    log_layout = QVBoxLayout(log_frame)
    
    log_layout.addWidget(QLabel("ç»‘å®šæ—¥å¿—ï¼š"))
    
    self.bind_log_text = QTextEdit()
    self.bind_log_text.setReadOnly(True)
    self.bind_log_text.setStyleSheet("QTextEdit { background-color: #f8f9fa; }")
    log_layout.addWidget(self.bind_log_text)
    
    copy_log_btn = QPushButton("å¤åˆ¶æ—¥å¿—")
    copy_log_btn.clicked.connect(self.copy_bind_log)
    log_layout.addWidget(copy_log_btn)
    
    main_layout.addWidget(log_frame)
    
    # è®¾ç½®å·¦å³åŒºåŸŸæ¯”ä¾‹
    main_layout.setStretch(0, 1)  # å·¦ä¾§å 1ä»½
    main_layout.setStretch(1, 1)  # å³ä¾§å 1ä»½

def on_bind_coupons(self):
    """ç»‘åˆ¸åŠŸèƒ½ - ç›´æ¥ä»æºä»£ç å¤åˆ¶æ ¸å¿ƒé€»è¾‘"""
    account = getattr(self, 'current_account', None)
    if not account:
        QMessageBox.warning(self, "æœªé€‰ä¸­è´¦å·", "è¯·å…ˆåœ¨å·¦ä¾§è´¦å·åˆ—è¡¨é€‰æ‹©è¦ç»‘å®šçš„è´¦å·ï¼")
        return
    
    # éªŒè¯è´¦å·ä¿¡æ¯å®Œæ•´æ€§
    required_fields = ['cinemaid', 'userid', 'openid', 'token']
    for field in required_fields:
        if not account.get(field):
            QMessageBox.warning(self, "è´¦å·ä¿¡æ¯ä¸å®Œæ•´", f"å½“å‰è´¦å·ç¼ºå°‘{field}å­—æ®µï¼Œè¯·é‡æ–°ç™»å½•ï¼")
            return
    
    print(f"[åˆ¸ç»‘å®š] ä½¿ç”¨è´¦å·: {account.get('userid')} @ {account.get('cinemaid')}")
    print(f"[åˆ¸ç»‘å®š] Token: {account.get('token', '')[:10]}...")
    
    coupon_codes = self.coupon_text.toPlainText().strip().split('\n')
    coupon_codes = [c.strip() for c in coupon_codes if c.strip()]
    if not coupon_codes:
        QMessageBox.warning(self, "æ— åˆ¸å·", "è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªåˆ¸å·ï¼")
        return
    
    # æ·»åŠ è¿›åº¦æç¤º
    QMessageBox.information(self, "å¼€å§‹ç»‘å®š", f"å³å°†ç»‘å®š{len(coupon_codes)}å¼ åˆ¸ï¼Œæ¯å¼ åˆ¸é—´éš”0.2ç§’ï¼Œè¯·ç¨å€™...")
    
    # æ‰§è¡Œç»‘å®š
    self.perform_batch_bind(account, coupon_codes)

def perform_batch_bind(self, account, coupon_codes):
    """æ‰§è¡Œæ‰¹é‡ç»‘åˆ¸ - åŸºäºç°æœ‰API"""
    log_lines = []
    success, fail = 0, 0
    fail_codes = []
    
    # å¯¼å…¥ç°æœ‰çš„ç»‘åˆ¸API
    from services.order_api import bind_coupon
    
    for i, code in enumerate(coupon_codes, 1):
        params = {
            'couponcode': code,
            'cinemaid': account['cinemaid'],
            'userid': account['userid'],
            'openid': account['openid'],
            'token': account['token'],
            'CVersion': '3.9.12',
            'OS': 'Windows',
            'source': '2',
            'groupid': '',
            'cardno': account.get('cardno', '')
        }
        
        print(f"[åˆ¸ç»‘å®š] æ­£åœ¨ç»‘å®šç¬¬{i}/{len(coupon_codes)}å¼ åˆ¸: {code}")
        
        try:
            res = bind_coupon(params)
            print(f"[åˆ¸ç»‘å®š] åˆ¸{code}ç»‘å®šç»“æœ: {res}")
            
            if res.get('resultCode') == '0':
                log_lines.append(f"åˆ¸{code} ç»‘å®šæˆåŠŸ")
                success += 1
            else:
                error_desc = res.get('resultDesc', 'æœªçŸ¥é”™è¯¯')
                log_lines.append(f"åˆ¸{code} ç»‘å®šå¤±è´¥ï¼š{error_desc}")
                fail += 1
                fail_codes.append(code)
                
                # ç‰¹æ®Šå¤„ç†tokenå¤±æ•ˆé—®é¢˜
                if 'TOKEN_INVALID' in error_desc:
                    log_lines.append(f"  -> Tokenå¯èƒ½å·²å¤±æ•ˆï¼Œå»ºè®®é‡æ–°ç™»å½•è´¦å·")
                    
        except Exception as e:
            error_msg = str(e)
            log_lines.append(f"åˆ¸{code} ç»‘å®šå¤±è´¥ï¼š{error_msg}")
            fail += 1
            fail_codes.append(code)
            print(f"[åˆ¸ç»‘å®š] åˆ¸{code}ç»‘å®šå¼‚å¸¸: {e}")
        
        # æ·»åŠ 0.2ç§’å»¶è¿Ÿï¼ˆé™¤äº†æœ€åä¸€å¼ åˆ¸ï¼‰
        if i < len(coupon_codes):
            print(f"[åˆ¸ç»‘å®š] ç­‰å¾…0.2ç§’åç»‘å®šä¸‹ä¸€å¼ åˆ¸...")
            QApplication.processEvents()  # å¤„ç†ç•Œé¢äº‹ä»¶
            time.sleep(0.2)
    
    # æ›´æ–°UIå¹¶æ˜¾ç¤ºæ€»ç»“
    self.update_bind_log(log_lines, success, fail, fail_codes, len(coupon_codes))

def update_bind_log(self, log_lines, success, fail, fail_codes, total):
    """æ›´æ–°ç»‘å®šæ—¥å¿—æ˜¾ç¤º"""
    log_lines.append(f"\n=== ç»‘å®šå®Œæˆ ===")
    log_lines.append(f"å…±{total}å¼ åˆ¸ï¼Œç»‘å®šæˆåŠŸ{success}ï¼Œå¤±è´¥{fail}")
    if fail_codes:
        log_lines.append(f"å¤±è´¥åˆ¸å·ï¼š{', '.join(fail_codes)}")
    
    # å¦‚æœå…¨éƒ¨å¤±è´¥ä¸”éƒ½æ˜¯TOKEN_INVALIDï¼Œç»™å‡ºå»ºè®®
    if fail == total and all('TOKEN_INVALID' in line for line in log_lines if 'ç»‘å®šå¤±è´¥' in line):
        log_lines.append(f"\n*** å»ºè®® ***")
        log_lines.append(f"æ‰€æœ‰åˆ¸éƒ½æ˜¾ç¤ºTOKEN_INVALIDé”™è¯¯")
        log_lines.append(f"è¯·å°è¯•ï¼š")
        log_lines.append(f"1. é‡æ–°ç™»å½•å½“å‰è´¦å·")
        log_lines.append(f"2. æ£€æŸ¥è´¦å·æ˜¯å¦åœ¨å¯¹åº”å½±é™¢æœ‰æ•ˆ")
        log_lines.append(f"3. ç¡®è®¤åˆ¸å·æ ¼å¼æ˜¯å¦æ­£ç¡®")
    
    self.bind_log_text.setPlainText("\n".join(log_lines))
    
    # å®Œæˆæç¤º
    if success > 0:
        QMessageBox.information(self, "ç»‘å®šå®Œæˆ", f"æˆåŠŸç»‘å®š{success}å¼ åˆ¸ï¼Œå¤±è´¥{fail}å¼ åˆ¸")
    else:
        QMessageBox.warning(self, "ç»‘å®šå¤±è´¥", f"æ‰€æœ‰{fail}å¼ åˆ¸ç»‘å®šå¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·çŠ¶æ€å’Œåˆ¸å·")

def copy_bind_log(self):
    """å¤åˆ¶ç»‘å®šæ—¥å¿—"""
    log = self.bind_log_text.toPlainText().strip()
    clipboard = QApplication.clipboard()
    clipboard.setText(log)
    QMessageBox.information(self, "å¤åˆ¶æˆåŠŸ", "æ—¥å¿—å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼")

def update_bind_account_info(self):
    """æ›´æ–°åˆ¸ç»‘å®šç•Œé¢çš„è´¦å·ä¿¡æ¯æ˜¾ç¤º"""
    account = getattr(self, 'current_account', None)
    if hasattr(self, 'bind_account_info'):
        if account:
            # è·å–å½±é™¢åç§°
            cinema_name = "æœªçŸ¥å½±é™¢"
            try:
                from services.cinema_manager import cinema_manager
                cinemas = cinema_manager.load_cinema_list()
                for cinema in cinemas:
                    if cinema.get('cinemaid') == account.get('cinemaid'):
                        cinema_name = cinema.get('cinemaShortName', 'æœªçŸ¥å½±é™¢')
                        break
            except:
                pass
            
            info_text = (f"å½“å‰è´¦å·ï¼š{account['userid']}\n"
                       f"å½±é™¢ï¼š{cinema_name}\n"
                       f"ä½™é¢ï¼š{account.get('balance', 0)}  ç§¯åˆ†ï¼š{account.get('score', 0)}")
            self.bind_account_info.setText(info_text)
            self.bind_account_info.setStyleSheet("QLabel { color: blue; background-color: #fff; padding: 10px; border: 1px solid #ddd; }")
        else:
            self.bind_account_info.setText("è¯·å…ˆé€‰æ‹©è´¦å·å’Œå½±é™¢")
            self.bind_account_info.setStyleSheet("QLabel { color: red; background-color: #fff; padding: 10px; border: 1px solid #ddd; }")
```

---

è¿™æ˜¯ç¬¬äºŒéƒ¨åˆ†ï¼ŒåŒ…å«äº†å…‘æ¢åˆ¸Tabå’Œç»‘åˆ¸Tabçš„è¯¦ç»†å®ç°ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šåˆ›å»ºç¬¬ä¸‰éƒ¨åˆ†ï¼ŒåŒ…å«åº§ä½å›¾ã€è´¦å·ç™»å½•å’Œè´¦å·åˆ—è¡¨çš„å®ç°ã€‚ 