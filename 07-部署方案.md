# PyQt5电影票务管理系统 - 部署方案

## 📋 **部署概览**

**目标**：支持50-100用户的生产环境部署  
**架构**：服务器端API + 客户端分发 + 数据库集群  
**重点**：高可用性、安全性、可扩展性、运维便利性

---

## 🚀 **7. 部署方案**

### **7.1 服务器端部署**

#### **生产环境架构**
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   负载均衡器     │    │   应用服务器     │    │   数据库集群     │
│   (Nginx)       │    │   (Flask+uWSGI) │    │   (MongoDB)     │
│                 │    │                 │    │                 │
│ • SSL终端       │◄──►│ • API服务       │◄──►│ • 主从复制      │
│ • 静态文件      │    │ • Web管理后台   │    │ • 自动备份      │
│ • 反向代理      │    │ • 日志记录      │    │ • 监控告警      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

#### **Docker容器化部署**
```yaml
# docker-compose.yml
version: '3.8'

services:
  # MongoDB数据库
  mongodb:
    image: mongo:5.0
    container_name: movie_ticket_db
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: userdb
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d
    ports:
      - "27017:27017"
    networks:
      - movie_ticket_network

  # Redis缓存
  redis:
    image: redis:6.2-alpine
    container_name: movie_ticket_redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - movie_ticket_network

  # Flask API应用
  api_server:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: movie_ticket_api
    restart: always
    environment:
      - FLASK_ENV=production
      - MONGO_URI=mongodb://userdb:${MONGO_PASSWORD}@mongodb:27017/userdb
      - REDIS_URI=redis://:${REDIS_PASSWORD}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - API_SECRET_KEY=${API_SECRET_KEY}
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - mongodb
      - redis
    networks:
      - movie_ticket_network

  # Nginx反向代理
  nginx:
    image: nginx:alpine
    container_name: movie_ticket_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./static:/var/www/static
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - api_server
    networks:
      - movie_ticket_network

volumes:
  mongodb_data:
  redis_data:

networks:
  movie_ticket_network:
    driver: bridge
```

#### **Flask应用Dockerfile**
```dockerfile
# Dockerfile.api
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .

# 安装Python依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 创建日志目录
RUN mkdir -p logs

# 设置环境变量
ENV PYTHONPATH=/app
ENV FLASK_APP=app.py

# 暴露端口
EXPOSE 5000

# 启动命令
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "--workers", "4", "--timeout", "120", "app:app"]
```

#### **Nginx配置**
```nginx
# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream api_backend {
        server api_server:5000;
    }

    # 限制请求频率
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=1r/s;

    server {
        listen 80;
        server_name your-domain.com;
        
        # 重定向到HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name your-domain.com;

        # SSL配置
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;

        # 安全头
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        # 静态文件
        location /static/ {
            alias /var/www/static/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # API接口
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 登录接口特殊限制
        location /api/v2/login {
            limit_req zone=login_limit burst=5 nodelay;
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 管理后台
        location /admin/ {
            # IP白名单（可选）
            # allow 192.168.1.0/24;
            # deny all;
            
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```

### **7.2 数据库部署配置**

#### **MongoDB生产配置**
```javascript
// mongo-init/01-init-db.js
db = db.getSiblingDB('userdb');

// 创建用户
db.createUser({
  user: 'userdb',
  pwd: 'your_secure_password',
  roles: [
    {
      role: 'readWrite',
      db: 'userdb'
    }
  ]
});

// 创建索引
db.users.createIndex({"phone": 1}, {"unique": true});
db.users.createIndex({"device.machineCode": 1});
db.users.createIndex({"account.status.code": 1});
db.users.createIndex({"device.lastLoginTime": -1});
db.users.createIndex({"metadata.createdAt": -1});

// 复合索引
db.users.createIndex({"phone": 1, "account.status.code": 1});
db.users.createIndex({"device.machineCode": 1, "account.status.code": 1});

// 登录日志索引
db.loginLogs.createIndex({"phone": 1, "loginTime": -1});
db.loginLogs.createIndex({"loginTime": -1});
db.loginLogs.createIndex({"machineCode": 1, "loginTime": -1});

// TTL索引（自动清理旧日志）
db.loginLogs.createIndex({"loginTime": 1}, {"expireAfterSeconds": 7776000}); // 90天
db.securityLogs.createIndex({"timestamp": 1}, {"expireAfterSeconds": 15552000}); // 180天
```

#### **数据库备份脚本**
```bash
#!/bin/bash
# backup_mongodb.sh

# 配置
MONGO_HOST="localhost"
MONGO_PORT="27017"
MONGO_DB="userdb"
MONGO_USER="userdb"
MONGO_PASS="your_secure_password"
BACKUP_DIR="/backup/mongodb"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 执行备份
mongodump \
  --host $MONGO_HOST:$MONGO_PORT \
  --db $MONGO_DB \
  --username $MONGO_USER \
  --password $MONGO_PASS \
  --out $BACKUP_DIR/$DATE

# 压缩备份
tar -czf $BACKUP_DIR/backup_$DATE.tar.gz -C $BACKUP_DIR $DATE

# 删除原始备份目录
rm -rf $BACKUP_DIR/$DATE

# 清理7天前的备份
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +7 -delete

echo "备份完成: backup_$DATE.tar.gz"
```

### **7.3 客户端分发方案**

#### **客户端打包配置**
```python
# build_client.py - 客户端打包脚本
import os
import sys
import shutil
import subprocess
from pathlib import Path

class ClientBuilder:
    """客户端构建器"""
    
    def __init__(self):
        self.project_root = Path(__file__).parent
        self.build_dir = self.project_root / "build"
        self.dist_dir = self.project_root / "dist"
        self.client_dir = self.project_root / "client"
    
    def build_client(self, version="1.0.0"):
        """构建客户端"""
        print(f"开始构建客户端 v{version}")
        
        # 清理构建目录
        self._clean_build_dirs()
        
        # 更新版本信息
        self._update_version_info(version)
        
        # 使用PyInstaller打包
        self._build_with_pyinstaller()
        
        # 创建安装包
        self._create_installer(version)
        
        # 生成分发包
        self._create_distribution_package(version)
        
        print(f"客户端构建完成: v{version}")
    
    def _clean_build_dirs(self):
        """清理构建目录"""
        for dir_path in [self.build_dir, self.dist_dir]:
            if dir_path.exists():
                shutil.rmtree(dir_path)
            dir_path.mkdir(parents=True)
    
    def _update_version_info(self, version):
        """更新版本信息"""
        version_file = self.client_dir / "version.py"
        with open(version_file, "w", encoding="utf-8") as f:
            f.write(f'''
# 自动生成的版本信息
VERSION = "{version}"
BUILD_TIME = "{datetime.now().isoformat()}"
API_BASE_URL = "https://your-domain.com"
''')
    
    def _build_with_pyinstaller(self):
        """使用PyInstaller打包"""
        spec_content = '''
# movie_ticket_client.spec
import sys
from pathlib import Path

block_cipher = None

a = Analysis(
    ['main.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('ui/resources', 'ui/resources'),
        ('config', 'config'),
    ],
    hiddenimports=[
        'PyQt5.QtCore',
        'PyQt5.QtGui',
        'PyQt5.QtWidgets',
        'requests',
        'psutil',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='MovieTicketClient',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='ui/resources/icon.ico'
)
'''
        
        spec_file = self.project_root / "movie_ticket_client.spec"
        with open(spec_file, "w", encoding="utf-8") as f:
            f.write(spec_content)
        
        # 执行打包
        subprocess.run([
            sys.executable, "-m", "PyInstaller",
            "--clean",
            str(spec_file)
        ], check=True)
    
    def _create_installer(self, version):
        """创建安装包（使用NSIS）"""
        nsis_script = f'''
; 电影票务管理系统安装脚本
!define APP_NAME "电影票务管理系统"
!define APP_VERSION "{version}"
!define APP_PUBLISHER "Your Company"
!define APP_EXE "MovieTicketClient.exe"

Name "${{APP_NAME}}"
OutFile "MovieTicketClient_v{version}_Setup.exe"
InstallDir "$PROGRAMFILES\\${{APP_NAME}}"

Section "MainSection" SEC01
    SetOutPath "$INSTDIR"
    File /r "dist\\MovieTicketClient\\*"
    
    ; 创建桌面快捷方式
    CreateShortCut "$DESKTOP\\${{APP_NAME}}.lnk" "$INSTDIR\\${{APP_EXE}}"
    
    ; 创建开始菜单
    CreateDirectory "$SMPROGRAMS\\${{APP_NAME}}"
    CreateShortCut "$SMPROGRAMS\\${{APP_NAME}}\\${{APP_NAME}}.lnk" "$INSTDIR\\${{APP_EXE}}"
    CreateShortCut "$SMPROGRAMS\\${{APP_NAME}}\\卸载.lnk" "$INSTDIR\\uninstall.exe"
    
    ; 写入注册表
    WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${{APP_NAME}}" "DisplayName" "${{APP_NAME}}"
    WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${{APP_NAME}}" "UninstallString" "$INSTDIR\\uninstall.exe"
    
    ; 创建卸载程序
    WriteUninstaller "$INSTDIR\\uninstall.exe"
SectionEnd

Section "Uninstall"
    Delete "$INSTDIR\\*.*"
    RMDir /r "$INSTDIR"
    Delete "$DESKTOP\\${{APP_NAME}}.lnk"
    RMDir /r "$SMPROGRAMS\\${{APP_NAME}}"
    DeleteRegKey HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${{APP_NAME}}"
SectionEnd
'''
        
        nsis_file = self.build_dir / "installer.nsi"
        with open(nsis_file, "w", encoding="utf-8") as f:
            f.write(nsis_script)
        
        # 编译安装包（需要安装NSIS）
        try:
            subprocess.run([
                "makensis",
                str(nsis_file)
            ], check=True, cwd=self.build_dir)
        except FileNotFoundError:
            print("警告: 未找到NSIS，跳过安装包创建")
    
    def _create_distribution_package(self, version):
        """创建分发包"""
        # 创建分发目录结构
        dist_package = self.dist_dir / f"MovieTicketClient_v{version}"
        dist_package.mkdir(parents=True)
        
        # 复制可执行文件
        exe_source = self.dist_dir / "MovieTicketClient"
        exe_dest = dist_package / "程序文件"
        shutil.copytree(exe_source, exe_dest)
        
        # 创建用户手册
        user_manual = dist_package / "用户手册.txt"
        with open(user_manual, "w", encoding="utf-8") as f:
            f.write(f'''
电影票务管理系统 v{version} 用户手册

安装说明：
1. 运行 MovieTicketClient_v{version}_Setup.exe 进行安装
2. 或者直接运行 程序文件/MovieTicketClient.exe

使用说明：
1. 首次使用请联系管理员获取账号
2. 输入手机号登录，系统会自动绑定当前设备
3. 登录成功后即可使用电影票务功能

技术支持：
- 官网：https://your-domain.com
- 邮箱：support@your-company.com
- 电话：400-xxx-xxxx

版本信息：
- 版本号：{version}
- 构建时间：{datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
''')
        
        # 创建配置文件模板
        config_template = dist_package / "config_template.json"
        with open(config_template, "w", encoding="utf-8") as f:
            json.dump({
                "api_base_url": "https://your-domain.com",
                "app_name": "电影票务管理系统",
                "version": version,
                "auto_update": True,
                "log_level": "INFO"
            }, f, ensure_ascii=False, indent=2)
        
        # 打包为ZIP
        shutil.make_archive(
            str(dist_package),
            'zip',
            str(dist_package.parent),
            dist_package.name
        )
        
        print(f"分发包已创建: {dist_package}.zip")

if __name__ == "__main__":
    import sys
    version = sys.argv[1] if len(sys.argv) > 1 else "1.0.0"
    builder = ClientBuilder()
    builder.build_client(version)
```
