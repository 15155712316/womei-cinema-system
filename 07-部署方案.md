# PyQt5ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿ - éƒ¨ç½²æ–¹æ¡ˆ

## ğŸ“‹ **éƒ¨ç½²æ¦‚è§ˆ**

**ç›®æ ‡**ï¼šæ”¯æŒ50-100ç”¨æˆ·çš„ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²  
**æ¶æ„**ï¼šæœåŠ¡å™¨ç«¯API + å®¢æˆ·ç«¯åˆ†å‘ + æ•°æ®åº“é›†ç¾¤  
**é‡ç‚¹**ï¼šé«˜å¯ç”¨æ€§ã€å®‰å…¨æ€§ã€å¯æ‰©å±•æ€§ã€è¿ç»´ä¾¿åˆ©æ€§

---

## ğŸš€ **7. éƒ¨ç½²æ–¹æ¡ˆ**

### **7.1 æœåŠ¡å™¨ç«¯éƒ¨ç½²**

#### **ç”Ÿäº§ç¯å¢ƒæ¶æ„**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è´Ÿè½½å‡è¡¡å™¨     â”‚    â”‚   åº”ç”¨æœåŠ¡å™¨     â”‚    â”‚   æ•°æ®åº“é›†ç¾¤     â”‚
â”‚   (Nginx)       â”‚    â”‚   (Flask+uWSGI) â”‚    â”‚   (MongoDB)     â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â€¢ SSLç»ˆç«¯       â”‚â—„â”€â”€â–ºâ”‚ â€¢ APIæœåŠ¡       â”‚â—„â”€â”€â–ºâ”‚ â€¢ ä¸»ä»å¤åˆ¶      â”‚
â”‚ â€¢ é™æ€æ–‡ä»¶      â”‚    â”‚ â€¢ Webç®¡ç†åå°   â”‚    â”‚ â€¢ è‡ªåŠ¨å¤‡ä»½      â”‚
â”‚ â€¢ åå‘ä»£ç†      â”‚    â”‚ â€¢ æ—¥å¿—è®°å½•      â”‚    â”‚ â€¢ ç›‘æ§å‘Šè­¦      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **Dockerå®¹å™¨åŒ–éƒ¨ç½²**
```yaml
# docker-compose.yml
version: '3.8'

services:
  # MongoDBæ•°æ®åº“
  mongodb:
    image: mongo:5.0
    container_name: movie_ticket_db
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: userdb
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d
    ports:
      - "27017:27017"
    networks:
      - movie_ticket_network

  # Redisç¼“å­˜
  redis:
    image: redis:6.2-alpine
    container_name: movie_ticket_redis
    restart: always
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - movie_ticket_network

  # Flask APIåº”ç”¨
  api_server:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: movie_ticket_api
    restart: always
    environment:
      - FLASK_ENV=production
      - MONGO_URI=mongodb://userdb:${MONGO_PASSWORD}@mongodb:27017/userdb
      - REDIS_URI=redis://:${REDIS_PASSWORD}@redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - API_SECRET_KEY=${API_SECRET_KEY}
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - mongodb
      - redis
    networks:
      - movie_ticket_network

  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:alpine
    container_name: movie_ticket_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./static:/var/www/static
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - api_server
    networks:
      - movie_ticket_network

volumes:
  mongodb_data:
  redis_data:

networks:
  movie_ticket_network:
    driver: bridge
```

#### **Flaskåº”ç”¨Dockerfile**
```dockerfile
# Dockerfile.api
FROM python:3.9-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p logs

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV FLASK_APP=app.py

# æš´éœ²ç«¯å£
EXPOSE 5000

# å¯åŠ¨å‘½ä»¤
CMD ["gunicorn", "--bind", "0.0.0.0:5000", "--workers", "4", "--timeout", "120", "app:app"]
```

#### **Nginxé…ç½®**
```nginx
# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream api_backend {
        server api_server:5000;
    }

    # é™åˆ¶è¯·æ±‚é¢‘ç‡
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=1r/s;

    server {
        listen 80;
        server_name your-domain.com;
        
        # é‡å®šå‘åˆ°HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name your-domain.com;

        # SSLé…ç½®
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;

        # å®‰å…¨å¤´
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";

        # é™æ€æ–‡ä»¶
        location /static/ {
            alias /var/www/static/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # APIæ¥å£
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ç™»å½•æ¥å£ç‰¹æ®Šé™åˆ¶
        location /api/v2/login {
            limit_req zone=login_limit burst=5 nodelay;
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ç®¡ç†åå°
        location /admin/ {
            # IPç™½åå•ï¼ˆå¯é€‰ï¼‰
            # allow 192.168.1.0/24;
            # deny all;
            
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
```

### **7.2 æ•°æ®åº“éƒ¨ç½²é…ç½®**

#### **MongoDBç”Ÿäº§é…ç½®**
```javascript
// mongo-init/01-init-db.js
db = db.getSiblingDB('userdb');

// åˆ›å»ºç”¨æˆ·
db.createUser({
  user: 'userdb',
  pwd: 'your_secure_password',
  roles: [
    {
      role: 'readWrite',
      db: 'userdb'
    }
  ]
});

// åˆ›å»ºç´¢å¼•
db.users.createIndex({"phone": 1}, {"unique": true});
db.users.createIndex({"device.machineCode": 1});
db.users.createIndex({"account.status.code": 1});
db.users.createIndex({"device.lastLoginTime": -1});
db.users.createIndex({"metadata.createdAt": -1});

// å¤åˆç´¢å¼•
db.users.createIndex({"phone": 1, "account.status.code": 1});
db.users.createIndex({"device.machineCode": 1, "account.status.code": 1});

// ç™»å½•æ—¥å¿—ç´¢å¼•
db.loginLogs.createIndex({"phone": 1, "loginTime": -1});
db.loginLogs.createIndex({"loginTime": -1});
db.loginLogs.createIndex({"machineCode": 1, "loginTime": -1});

// TTLç´¢å¼•ï¼ˆè‡ªåŠ¨æ¸…ç†æ—§æ—¥å¿—ï¼‰
db.loginLogs.createIndex({"loginTime": 1}, {"expireAfterSeconds": 7776000}); // 90å¤©
db.securityLogs.createIndex({"timestamp": 1}, {"expireAfterSeconds": 15552000}); // 180å¤©
```

#### **æ•°æ®åº“å¤‡ä»½è„šæœ¬**
```bash
#!/bin/bash
# backup_mongodb.sh

# é…ç½®
MONGO_HOST="localhost"
MONGO_PORT="27017"
MONGO_DB="userdb"
MONGO_USER="userdb"
MONGO_PASS="your_secure_password"
BACKUP_DIR="/backup/mongodb"
DATE=$(date +%Y%m%d_%H%M%S)

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# æ‰§è¡Œå¤‡ä»½
mongodump \
  --host $MONGO_HOST:$MONGO_PORT \
  --db $MONGO_DB \
  --username $MONGO_USER \
  --password $MONGO_PASS \
  --out $BACKUP_DIR/$DATE

# å‹ç¼©å¤‡ä»½
tar -czf $BACKUP_DIR/backup_$DATE.tar.gz -C $BACKUP_DIR $DATE

# åˆ é™¤åŸå§‹å¤‡ä»½ç›®å½•
rm -rf $BACKUP_DIR/$DATE

# æ¸…ç†7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "backup_*.tar.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: backup_$DATE.tar.gz"
```

### **7.3 å®¢æˆ·ç«¯åˆ†å‘æ–¹æ¡ˆ**

#### **å®¢æˆ·ç«¯æ‰“åŒ…é…ç½®**
```python
# build_client.py - å®¢æˆ·ç«¯æ‰“åŒ…è„šæœ¬
import os
import sys
import shutil
import subprocess
from pathlib import Path

class ClientBuilder:
    """å®¢æˆ·ç«¯æ„å»ºå™¨"""
    
    def __init__(self):
        self.project_root = Path(__file__).parent
        self.build_dir = self.project_root / "build"
        self.dist_dir = self.project_root / "dist"
        self.client_dir = self.project_root / "client"
    
    def build_client(self, version="1.0.0"):
        """æ„å»ºå®¢æˆ·ç«¯"""
        print(f"å¼€å§‹æ„å»ºå®¢æˆ·ç«¯ v{version}")
        
        # æ¸…ç†æ„å»ºç›®å½•
        self._clean_build_dirs()
        
        # æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯
        self._update_version_info(version)
        
        # ä½¿ç”¨PyInstalleræ‰“åŒ…
        self._build_with_pyinstaller()
        
        # åˆ›å»ºå®‰è£…åŒ…
        self._create_installer(version)
        
        # ç”Ÿæˆåˆ†å‘åŒ…
        self._create_distribution_package(version)
        
        print(f"å®¢æˆ·ç«¯æ„å»ºå®Œæˆ: v{version}")
    
    def _clean_build_dirs(self):
        """æ¸…ç†æ„å»ºç›®å½•"""
        for dir_path in [self.build_dir, self.dist_dir]:
            if dir_path.exists():
                shutil.rmtree(dir_path)
            dir_path.mkdir(parents=True)
    
    def _update_version_info(self, version):
        """æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯"""
        version_file = self.client_dir / "version.py"
        with open(version_file, "w", encoding="utf-8") as f:
            f.write(f'''
# è‡ªåŠ¨ç”Ÿæˆçš„ç‰ˆæœ¬ä¿¡æ¯
VERSION = "{version}"
BUILD_TIME = "{datetime.now().isoformat()}"
API_BASE_URL = "https://your-domain.com"
''')
    
    def _build_with_pyinstaller(self):
        """ä½¿ç”¨PyInstalleræ‰“åŒ…"""
        spec_content = '''
# movie_ticket_client.spec
import sys
from pathlib import Path

block_cipher = None

a = Analysis(
    ['main.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('ui/resources', 'ui/resources'),
        ('config', 'config'),
    ],
    hiddenimports=[
        'PyQt5.QtCore',
        'PyQt5.QtGui',
        'PyQt5.QtWidgets',
        'requests',
        'psutil',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    a.binaries,
    a.zipfiles,
    a.datas,
    [],
    name='MovieTicketClient',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    upx_exclude=[],
    runtime_tmpdir=None,
    console=False,
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
    icon='ui/resources/icon.ico'
)
'''
        
        spec_file = self.project_root / "movie_ticket_client.spec"
        with open(spec_file, "w", encoding="utf-8") as f:
            f.write(spec_content)
        
        # æ‰§è¡Œæ‰“åŒ…
        subprocess.run([
            sys.executable, "-m", "PyInstaller",
            "--clean",
            str(spec_file)
        ], check=True)
    
    def _create_installer(self, version):
        """åˆ›å»ºå®‰è£…åŒ…ï¼ˆä½¿ç”¨NSISï¼‰"""
        nsis_script = f'''
; ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿå®‰è£…è„šæœ¬
!define APP_NAME "ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿ"
!define APP_VERSION "{version}"
!define APP_PUBLISHER "Your Company"
!define APP_EXE "MovieTicketClient.exe"

Name "${{APP_NAME}}"
OutFile "MovieTicketClient_v{version}_Setup.exe"
InstallDir "$PROGRAMFILES\\${{APP_NAME}}"

Section "MainSection" SEC01
    SetOutPath "$INSTDIR"
    File /r "dist\\MovieTicketClient\\*"
    
    ; åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
    CreateShortCut "$DESKTOP\\${{APP_NAME}}.lnk" "$INSTDIR\\${{APP_EXE}}"
    
    ; åˆ›å»ºå¼€å§‹èœå•
    CreateDirectory "$SMPROGRAMS\\${{APP_NAME}}"
    CreateShortCut "$SMPROGRAMS\\${{APP_NAME}}\\${{APP_NAME}}.lnk" "$INSTDIR\\${{APP_EXE}}"
    CreateShortCut "$SMPROGRAMS\\${{APP_NAME}}\\å¸è½½.lnk" "$INSTDIR\\uninstall.exe"
    
    ; å†™å…¥æ³¨å†Œè¡¨
    WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${{APP_NAME}}" "DisplayName" "${{APP_NAME}}"
    WriteRegStr HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${{APP_NAME}}" "UninstallString" "$INSTDIR\\uninstall.exe"
    
    ; åˆ›å»ºå¸è½½ç¨‹åº
    WriteUninstaller "$INSTDIR\\uninstall.exe"
SectionEnd

Section "Uninstall"
    Delete "$INSTDIR\\*.*"
    RMDir /r "$INSTDIR"
    Delete "$DESKTOP\\${{APP_NAME}}.lnk"
    RMDir /r "$SMPROGRAMS\\${{APP_NAME}}"
    DeleteRegKey HKLM "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\${{APP_NAME}}"
SectionEnd
'''
        
        nsis_file = self.build_dir / "installer.nsi"
        with open(nsis_file, "w", encoding="utf-8") as f:
            f.write(nsis_script)
        
        # ç¼–è¯‘å®‰è£…åŒ…ï¼ˆéœ€è¦å®‰è£…NSISï¼‰
        try:
            subprocess.run([
                "makensis",
                str(nsis_file)
            ], check=True, cwd=self.build_dir)
        except FileNotFoundError:
            print("è­¦å‘Š: æœªæ‰¾åˆ°NSISï¼Œè·³è¿‡å®‰è£…åŒ…åˆ›å»º")
    
    def _create_distribution_package(self, version):
        """åˆ›å»ºåˆ†å‘åŒ…"""
        # åˆ›å»ºåˆ†å‘ç›®å½•ç»“æ„
        dist_package = self.dist_dir / f"MovieTicketClient_v{version}"
        dist_package.mkdir(parents=True)
        
        # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
        exe_source = self.dist_dir / "MovieTicketClient"
        exe_dest = dist_package / "ç¨‹åºæ–‡ä»¶"
        shutil.copytree(exe_source, exe_dest)
        
        # åˆ›å»ºç”¨æˆ·æ‰‹å†Œ
        user_manual = dist_package / "ç”¨æˆ·æ‰‹å†Œ.txt"
        with open(user_manual, "w", encoding="utf-8") as f:
            f.write(f'''
ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿ v{version} ç”¨æˆ·æ‰‹å†Œ

å®‰è£…è¯´æ˜ï¼š
1. è¿è¡Œ MovieTicketClient_v{version}_Setup.exe è¿›è¡Œå®‰è£…
2. æˆ–è€…ç›´æ¥è¿è¡Œ ç¨‹åºæ–‡ä»¶/MovieTicketClient.exe

ä½¿ç”¨è¯´æ˜ï¼š
1. é¦–æ¬¡ä½¿ç”¨è¯·è”ç³»ç®¡ç†å‘˜è·å–è´¦å·
2. è¾“å…¥æ‰‹æœºå·ç™»å½•ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç»‘å®šå½“å‰è®¾å¤‡
3. ç™»å½•æˆåŠŸåå³å¯ä½¿ç”¨ç”µå½±ç¥¨åŠ¡åŠŸèƒ½

æŠ€æœ¯æ”¯æŒï¼š
- å®˜ç½‘ï¼šhttps://your-domain.com
- é‚®ç®±ï¼šsupport@your-company.com
- ç”µè¯ï¼š400-xxx-xxxx

ç‰ˆæœ¬ä¿¡æ¯ï¼š
- ç‰ˆæœ¬å·ï¼š{version}
- æ„å»ºæ—¶é—´ï¼š{datetime.now().strftime("%Y-%m-%d %H:%M:%S")}
''')
        
        # åˆ›å»ºé…ç½®æ–‡ä»¶æ¨¡æ¿
        config_template = dist_package / "config_template.json"
        with open(config_template, "w", encoding="utf-8") as f:
            json.dump({
                "api_base_url": "https://your-domain.com",
                "app_name": "ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿ",
                "version": version,
                "auto_update": True,
                "log_level": "INFO"
            }, f, ensure_ascii=False, indent=2)
        
        # æ‰“åŒ…ä¸ºZIP
        shutil.make_archive(
            str(dist_package),
            'zip',
            str(dist_package.parent),
            dist_package.name
        )
        
        print(f"åˆ†å‘åŒ…å·²åˆ›å»º: {dist_package}.zip")

if __name__ == "__main__":
    import sys
    version = sys.argv[1] if len(sys.argv) > 1 else "1.0.0"
    builder = ClientBuilder()
    builder.build_client(version)
```
