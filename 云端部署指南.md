# 用户认证系统 - 云端部署指南

## 📋 概述

本指南将帮助你将用户认证系统部署到腾讯云开发，实现零服务器运维的轻量级解决方案。

## 🎯 技术架构

```
客户端软件 ←→ 腾讯云函数 ←→ 腾讯云数据库
    ↓
机器码验证 + 登录认证 + 积分管理
```

## 📝 部署步骤

### 第一步：注册腾讯云开发

1. 访问 [腾讯云开发控制台](https://console.cloud.tencent.com/tcb)
2. 注册腾讯云账号（如果没有）
3. 创建新的云开发环境
   - 环境名称：`leying-auth`
   - 套餐版本：免费版
   - 地域：选择离你最近的地域

### 第二步：创建云数据库

在云开发控制台中：

1. 进入"数据库"页面
2. 创建集合 `users`（用户表）
3. 创建集合 `point_logs`（积分记录表）

**用户表结构示例：**
```json
{
  "_id": "user_001",
  "username": "admin",
  "password_hash": "hashed_password",
  "machine_code": "machine_code_here",
  "status": 1,
  "points": 100,
  "created_at": "2024-01-01T00:00:00Z",
  "last_login": "2024-01-01T00:00:00Z"
}
```

### 第三步：创建云函数

#### 3.1 登录验证函数

创建云函数 `auth-login`：

```javascript
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const { username, password_hash, machine_code, timestamp } = event
  
  try {
    // 查找用户
    const userResult = await db.collection('users').where({
      username: username
    }).get()
    
    if (userResult.data.length === 0) {
      return {
        success: false,
        message: "用户不存在"
      }
    }
    
    const user = userResult.data[0]
    
    // 验证密码
    if (user.password_hash !== password_hash) {
      return {
        success: false,
        message: "密码错误"
      }
    }
    
    // 验证机器码
    if (user.machine_code !== machine_code) {
      return {
        success: false,
        message: "机器码不匹配，请联系管理员"
      }
    }
    
    // 检查账号状态
    if (user.status !== 1) {
      return {
        success: false,
        message: "账号已被禁用"
      }
    }
    
    // 生成token
    const token = require('crypto').createHash('md5')
      .update(`${username}${machine_code}${Date.now()}`)
      .digest('hex')
    
    // 更新最后登录时间
    await db.collection('users').doc(user._id).update({
      data: {
        last_login: new Date()
      }
    })
    
    return {
      success: true,
      message: "登录成功",
      data: {
        id: user._id,
        username: user.username,
        status: user.status,
        points: user.points,
        token: token
      }
    }
    
  } catch (error) {
    return {
      success: false,
      message: `登录异常: ${error.message}`
    }
  }
}
```

#### 3.2 权限验证函数

创建云函数 `auth-check`：

```javascript
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const { token, user_id, timestamp } = event
  
  try {
    // 查找用户
    const userResult = await db.collection('users').doc(user_id).get()
    
    if (!userResult.data) {
      return {
        success: false,
        message: "用户不存在"
      }
    }
    
    const user = userResult.data
    
    // 检查账号状态
    if (user.status !== 1) {
      return {
        success: false,
        message: "账号已被禁用"
      }
    }
    
    // 简单的token验证（生产环境需要更严格的验证）
    if (!token) {
      return {
        success: false,
        message: "Token无效"
      }
    }
    
    return {
      success: true,
      message: "认证有效",
      data: {
        id: user._id,
        username: user.username,
        status: user.status,
        points: user.points
      }
    }
    
  } catch (error) {
    return {
      success: false,
      message: `验证异常: ${error.message}`
    }
  }
}
```

#### 3.3 积分扣除函数

创建云函数 `auth-use-points`：

```javascript
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const { token, user_id, operation, points, timestamp } = event
  
  try {
    // 查找用户
    const userResult = await db.collection('users').doc(user_id).get()
    
    if (!userResult.data) {
      return {
        success: false,
        message: "用户不存在"
      }
    }
    
    const user = userResult.data
    
    // 检查积分是否充足
    if (user.points < points) {
      return {
        success: false,
        message: "积分不足"
      }
    }
    
    // 扣除积分
    const newPoints = user.points - points
    await db.collection('users').doc(user_id).update({
      data: {
        points: newPoints
      }
    })
    
    // 记录积分使用日志
    await db.collection('point_logs').add({
      data: {
        user_id: user_id,
        operation: operation,
        points_used: points,
        remaining_points: newPoints,
        created_at: new Date()
      }
    })
    
    return {
      success: true,
      message: "积分扣除成功",
      data: {
        remaining_points: newPoints,
        operation: operation
      }
    }
    
  } catch (error) {
    return {
      success: false,
      message: `积分扣除异常: ${error.message}`
    }
  }
}
```

### 第四步：配置HTTP API

1. 在云开发控制台的"云函数"页面
2. 为每个函数开启HTTP访问：
   - `auth-login` → 开启HTTP访问
   - `auth-check` → 开启HTTP访问  
   - `auth-use-points` → 开启HTTP访问

3. 记录每个函数的HTTP触发器地址，例如：
   - `https://your-env-id.service.tcloudbase.com/auth-login`
   - `https://your-env-id.service.tcloudbase.com/auth-check`
   - `https://your-env-id.service.tcloudbase.com/auth-use-points`

### 第五步：更新客户端配置

修改 `services/auth_service.py` 中的 `_call_api` 方法：

```python
def _call_api(self, endpoint: str, data: Dict) -> Dict:
    """
    调用云函数API
    """
    # 替换为你的实际云函数地址
    api_urls = {
        "login": "https://your-env-id.service.tcloudbase.com/auth-login",
        "check_auth": "https://your-env-id.service.tcloudbase.com/auth-check",
        "use_points": "https://your-env-id.service.tcloudbase.com/auth-use-points"
    }
    
    url = api_urls.get(endpoint)
    if not url:
        return {"success": False, "message": "未知API端点"}
    
    try:
        headers = {
            'Content-Type': 'application/json',
            'User-Agent': 'LeYing-Auth-Client/1.0'
        }
        
        response = requests.post(url, json=data, headers=headers, timeout=10)
        response.raise_for_status()
        
        return response.json()
        
    except Exception as e:
        print(f"[API调用] 异常: {e}")
        return {"success": False, "message": f"网络异常: {str(e)}"}
```

## 🛠 管理员操作

### 创建用户

在云开发控制台的数据库中手动添加用户：

```json
{
  "_id": "user_001",
  "username": "admin",
  "password_hash": "使用auth_service.hash_password('123456')生成的哈希",
  "machine_code": "用户的机器码",
  "status": 1,
  "points": 100,
  "created_at": "2024-01-01T00:00:00Z",
  "last_login": null
}
```

### 管理用户状态

- `status: 1` - 账号正常
- `status: 0` - 账号禁用

### 充值积分

直接在数据库中修改用户的 `points` 字段。

## 📊 监控与维护

### 查看使用情况

1. 云函数调用次数：云开发控制台 → 云函数 → 调用日志
2. 数据库使用量：云开发控制台 → 数据库 → 统计
3. 用户活动：查看 `point_logs` 集合的记录

### 免费额度

腾讯云开发免费版本包含：
- 云函数：5万次/月调用
- 数据库：1GB存储空间
- CDN：1GB/月流量

对于30-40个用户的场景，完全够用。

## 🔐 安全建议

1. **Token安全**：生产环境中应使用JWT等更安全的token机制
2. **HTTPS**: 确保所有API调用都是HTTPS
3. **访问控制**：在云函数中添加请求频率限制
4. **数据备份**：定期备份用户数据
5. **日志监控**：监控异常登录和大量积分消耗

## 🚀 扩展功能

### 后台管理界面

可以创建一个简单的Web管理界面：

1. 用户管理（增删改查）
2. 积分管理（充值/扣除）
3. 操作日志查看
4. 系统监控

### 高级功能

1. 邮件通知
2. 短信验证
3. 多级管理员权限
4. 自动积分任务

## ❓ 常见问题

**Q: 如何获取用户的机器码？**
A: 运行客户端程序，在测试脚本中会显示当前机器码。

**Q: 忘记密码怎么办？**
A: 管理员可以在数据库中直接修改用户的密码哈希。

**Q: 如何增加用户？**
A: 在云数据库中手动添加用户记录，或创建用户注册云函数。

**Q: 积分不够用怎么办？**
A: 管理员可以在数据库中直接修改用户的积分值。

## 📞 技术支持

如果遇到部署问题，可以：
1. 查看腾讯云开发官方文档
2. 查看云函数执行日志
3. 检查网络连接和API地址配置 