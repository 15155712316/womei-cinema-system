# ç”¨æˆ·è®¤è¯ç³»ç»Ÿ - äº‘ç«¯éƒ¨ç½²æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ å°†ç”¨æˆ·è®¤è¯ç³»ç»Ÿéƒ¨ç½²åˆ°è…¾è®¯äº‘å¼€å‘ï¼Œå®ç°é›¶æœåŠ¡å™¨è¿ç»´çš„è½»é‡çº§è§£å†³æ–¹æ¡ˆã€‚

## ğŸ¯ æŠ€æœ¯æ¶æ„

```
å®¢æˆ·ç«¯è½¯ä»¶ â†â†’ è…¾è®¯äº‘å‡½æ•° â†â†’ è…¾è®¯äº‘æ•°æ®åº“
    â†“
æœºå™¨ç éªŒè¯ + ç™»å½•è®¤è¯ + ç§¯åˆ†ç®¡ç†
```

## ğŸ“ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ³¨å†Œè…¾è®¯äº‘å¼€å‘

1. è®¿é—® [è…¾è®¯äº‘å¼€å‘æ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
2. æ³¨å†Œè…¾è®¯äº‘è´¦å·ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
3. åˆ›å»ºæ–°çš„äº‘å¼€å‘ç¯å¢ƒ
   - ç¯å¢ƒåç§°ï¼š`leying-auth`
   - å¥—é¤ç‰ˆæœ¬ï¼šå…è´¹ç‰ˆ
   - åœ°åŸŸï¼šé€‰æ‹©ç¦»ä½ æœ€è¿‘çš„åœ°åŸŸ

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºäº‘æ•°æ®åº“

åœ¨äº‘å¼€å‘æ§åˆ¶å°ä¸­ï¼š

1. è¿›å…¥"æ•°æ®åº“"é¡µé¢
2. åˆ›å»ºé›†åˆ `users`ï¼ˆç”¨æˆ·è¡¨ï¼‰
3. åˆ›å»ºé›†åˆ `point_logs`ï¼ˆç§¯åˆ†è®°å½•è¡¨ï¼‰

**ç”¨æˆ·è¡¨ç»“æ„ç¤ºä¾‹ï¼š**
```json
{
  "_id": "user_001",
  "username": "admin",
  "password_hash": "hashed_password",
  "machine_code": "machine_code_here",
  "status": 1,
  "points": 100,
  "created_at": "2024-01-01T00:00:00Z",
  "last_login": "2024-01-01T00:00:00Z"
}
```

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºäº‘å‡½æ•°

#### 3.1 ç™»å½•éªŒè¯å‡½æ•°

åˆ›å»ºäº‘å‡½æ•° `auth-login`ï¼š

```javascript
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const { username, password_hash, machine_code, timestamp } = event
  
  try {
    // æŸ¥æ‰¾ç”¨æˆ·
    const userResult = await db.collection('users').where({
      username: username
    }).get()
    
    if (userResult.data.length === 0) {
      return {
        success: false,
        message: "ç”¨æˆ·ä¸å­˜åœ¨"
      }
    }
    
    const user = userResult.data[0]
    
    // éªŒè¯å¯†ç 
    if (user.password_hash !== password_hash) {
      return {
        success: false,
        message: "å¯†ç é”™è¯¯"
      }
    }
    
    // éªŒè¯æœºå™¨ç 
    if (user.machine_code !== machine_code) {
      return {
        success: false,
        message: "æœºå™¨ç ä¸åŒ¹é…ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
      }
    }
    
    // æ£€æŸ¥è´¦å·çŠ¶æ€
    if (user.status !== 1) {
      return {
        success: false,
        message: "è´¦å·å·²è¢«ç¦ç”¨"
      }
    }
    
    // ç”Ÿæˆtoken
    const token = require('crypto').createHash('md5')
      .update(`${username}${machine_code}${Date.now()}`)
      .digest('hex')
    
    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
    await db.collection('users').doc(user._id).update({
      data: {
        last_login: new Date()
      }
    })
    
    return {
      success: true,
      message: "ç™»å½•æˆåŠŸ",
      data: {
        id: user._id,
        username: user.username,
        status: user.status,
        points: user.points,
        token: token
      }
    }
    
  } catch (error) {
    return {
      success: false,
      message: `ç™»å½•å¼‚å¸¸: ${error.message}`
    }
  }
}
```

#### 3.2 æƒé™éªŒè¯å‡½æ•°

åˆ›å»ºäº‘å‡½æ•° `auth-check`ï¼š

```javascript
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const { token, user_id, timestamp } = event
  
  try {
    // æŸ¥æ‰¾ç”¨æˆ·
    const userResult = await db.collection('users').doc(user_id).get()
    
    if (!userResult.data) {
      return {
        success: false,
        message: "ç”¨æˆ·ä¸å­˜åœ¨"
      }
    }
    
    const user = userResult.data
    
    // æ£€æŸ¥è´¦å·çŠ¶æ€
    if (user.status !== 1) {
      return {
        success: false,
        message: "è´¦å·å·²è¢«ç¦ç”¨"
      }
    }
    
    // ç®€å•çš„tokenéªŒè¯ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€è¦æ›´ä¸¥æ ¼çš„éªŒè¯ï¼‰
    if (!token) {
      return {
        success: false,
        message: "Tokenæ— æ•ˆ"
      }
    }
    
    return {
      success: true,
      message: "è®¤è¯æœ‰æ•ˆ",
      data: {
        id: user._id,
        username: user.username,
        status: user.status,
        points: user.points
      }
    }
    
  } catch (error) {
    return {
      success: false,
      message: `éªŒè¯å¼‚å¸¸: ${error.message}`
    }
  }
}
```

#### 3.3 ç§¯åˆ†æ‰£é™¤å‡½æ•°

åˆ›å»ºäº‘å‡½æ•° `auth-use-points`ï¼š

```javascript
const cloud = require('wx-server-sdk')
cloud.init()
const db = cloud.database()

exports.main = async (event, context) => {
  const { token, user_id, operation, points, timestamp } = event
  
  try {
    // æŸ¥æ‰¾ç”¨æˆ·
    const userResult = await db.collection('users').doc(user_id).get()
    
    if (!userResult.data) {
      return {
        success: false,
        message: "ç”¨æˆ·ä¸å­˜åœ¨"
      }
    }
    
    const user = userResult.data
    
    // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦å……è¶³
    if (user.points < points) {
      return {
        success: false,
        message: "ç§¯åˆ†ä¸è¶³"
      }
    }
    
    // æ‰£é™¤ç§¯åˆ†
    const newPoints = user.points - points
    await db.collection('users').doc(user_id).update({
      data: {
        points: newPoints
      }
    })
    
    // è®°å½•ç§¯åˆ†ä½¿ç”¨æ—¥å¿—
    await db.collection('point_logs').add({
      data: {
        user_id: user_id,
        operation: operation,
        points_used: points,
        remaining_points: newPoints,
        created_at: new Date()
      }
    })
    
    return {
      success: true,
      message: "ç§¯åˆ†æ‰£é™¤æˆåŠŸ",
      data: {
        remaining_points: newPoints,
        operation: operation
      }
    }
    
  } catch (error) {
    return {
      success: false,
      message: `ç§¯åˆ†æ‰£é™¤å¼‚å¸¸: ${error.message}`
    }
  }
}
```

### ç¬¬å››æ­¥ï¼šé…ç½®HTTP API

1. åœ¨äº‘å¼€å‘æ§åˆ¶å°çš„"äº‘å‡½æ•°"é¡µé¢
2. ä¸ºæ¯ä¸ªå‡½æ•°å¼€å¯HTTPè®¿é—®ï¼š
   - `auth-login` â†’ å¼€å¯HTTPè®¿é—®
   - `auth-check` â†’ å¼€å¯HTTPè®¿é—®  
   - `auth-use-points` â†’ å¼€å¯HTTPè®¿é—®

3. è®°å½•æ¯ä¸ªå‡½æ•°çš„HTTPè§¦å‘å™¨åœ°å€ï¼Œä¾‹å¦‚ï¼š
   - `https://your-env-id.service.tcloudbase.com/auth-login`
   - `https://your-env-id.service.tcloudbase.com/auth-check`
   - `https://your-env-id.service.tcloudbase.com/auth-use-points`

### ç¬¬äº”æ­¥ï¼šæ›´æ–°å®¢æˆ·ç«¯é…ç½®

ä¿®æ”¹ `services/auth_service.py` ä¸­çš„ `_call_api` æ–¹æ³•ï¼š

```python
def _call_api(self, endpoint: str, data: Dict) -> Dict:
    """
    è°ƒç”¨äº‘å‡½æ•°API
    """
    # æ›¿æ¢ä¸ºä½ çš„å®é™…äº‘å‡½æ•°åœ°å€
    api_urls = {
        "login": "https://your-env-id.service.tcloudbase.com/auth-login",
        "check_auth": "https://your-env-id.service.tcloudbase.com/auth-check",
        "use_points": "https://your-env-id.service.tcloudbase.com/auth-use-points"
    }
    
    url = api_urls.get(endpoint)
    if not url:
        return {"success": False, "message": "æœªçŸ¥APIç«¯ç‚¹"}
    
    try:
        headers = {
            'Content-Type': 'application/json',
            'User-Agent': 'LeYing-Auth-Client/1.0'
        }
        
        response = requests.post(url, json=data, headers=headers, timeout=10)
        response.raise_for_status()
        
        return response.json()
        
    except Exception as e:
        print(f"[APIè°ƒç”¨] å¼‚å¸¸: {e}")
        return {"success": False, "message": f"ç½‘ç»œå¼‚å¸¸: {str(e)}"}
```

## ğŸ›  ç®¡ç†å‘˜æ“ä½œ

### åˆ›å»ºç”¨æˆ·

åœ¨äº‘å¼€å‘æ§åˆ¶å°çš„æ•°æ®åº“ä¸­æ‰‹åŠ¨æ·»åŠ ç”¨æˆ·ï¼š

```json
{
  "_id": "user_001",
  "username": "admin",
  "password_hash": "ä½¿ç”¨auth_service.hash_password('123456')ç”Ÿæˆçš„å“ˆå¸Œ",
  "machine_code": "ç”¨æˆ·çš„æœºå™¨ç ",
  "status": 1,
  "points": 100,
  "created_at": "2024-01-01T00:00:00Z",
  "last_login": null
}
```

### ç®¡ç†ç”¨æˆ·çŠ¶æ€

- `status: 1` - è´¦å·æ­£å¸¸
- `status: 0` - è´¦å·ç¦ç”¨

### å……å€¼ç§¯åˆ†

ç›´æ¥åœ¨æ•°æ®åº“ä¸­ä¿®æ”¹ç”¨æˆ·çš„ `points` å­—æ®µã€‚

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### æŸ¥çœ‹ä½¿ç”¨æƒ…å†µ

1. äº‘å‡½æ•°è°ƒç”¨æ¬¡æ•°ï¼šäº‘å¼€å‘æ§åˆ¶å° â†’ äº‘å‡½æ•° â†’ è°ƒç”¨æ—¥å¿—
2. æ•°æ®åº“ä½¿ç”¨é‡ï¼šäº‘å¼€å‘æ§åˆ¶å° â†’ æ•°æ®åº“ â†’ ç»Ÿè®¡
3. ç”¨æˆ·æ´»åŠ¨ï¼šæŸ¥çœ‹ `point_logs` é›†åˆçš„è®°å½•

### å…è´¹é¢åº¦

è…¾è®¯äº‘å¼€å‘å…è´¹ç‰ˆæœ¬åŒ…å«ï¼š
- äº‘å‡½æ•°ï¼š5ä¸‡æ¬¡/æœˆè°ƒç”¨
- æ•°æ®åº“ï¼š1GBå­˜å‚¨ç©ºé—´
- CDNï¼š1GB/æœˆæµé‡

å¯¹äº30-40ä¸ªç”¨æˆ·çš„åœºæ™¯ï¼Œå®Œå…¨å¤Ÿç”¨ã€‚

## ğŸ” å®‰å…¨å»ºè®®

1. **Tokenå®‰å…¨**ï¼šç”Ÿäº§ç¯å¢ƒä¸­åº”ä½¿ç”¨JWTç­‰æ›´å®‰å…¨çš„tokenæœºåˆ¶
2. **HTTPS**: ç¡®ä¿æ‰€æœ‰APIè°ƒç”¨éƒ½æ˜¯HTTPS
3. **è®¿é—®æ§åˆ¶**ï¼šåœ¨äº‘å‡½æ•°ä¸­æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶
4. **æ•°æ®å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½ç”¨æˆ·æ•°æ®
5. **æ—¥å¿—ç›‘æ§**ï¼šç›‘æ§å¼‚å¸¸ç™»å½•å’Œå¤§é‡ç§¯åˆ†æ¶ˆè€—

## ğŸš€ æ‰©å±•åŠŸèƒ½

### åå°ç®¡ç†ç•Œé¢

å¯ä»¥åˆ›å»ºä¸€ä¸ªç®€å•çš„Webç®¡ç†ç•Œé¢ï¼š

1. ç”¨æˆ·ç®¡ç†ï¼ˆå¢åˆ æ”¹æŸ¥ï¼‰
2. ç§¯åˆ†ç®¡ç†ï¼ˆå……å€¼/æ‰£é™¤ï¼‰
3. æ“ä½œæ—¥å¿—æŸ¥çœ‹
4. ç³»ç»Ÿç›‘æ§

### é«˜çº§åŠŸèƒ½

1. é‚®ä»¶é€šçŸ¥
2. çŸ­ä¿¡éªŒè¯
3. å¤šçº§ç®¡ç†å‘˜æƒé™
4. è‡ªåŠ¨ç§¯åˆ†ä»»åŠ¡

## â“ å¸¸è§é—®é¢˜

**Q: å¦‚ä½•è·å–ç”¨æˆ·çš„æœºå™¨ç ï¼Ÿ**
A: è¿è¡Œå®¢æˆ·ç«¯ç¨‹åºï¼Œåœ¨æµ‹è¯•è„šæœ¬ä¸­ä¼šæ˜¾ç¤ºå½“å‰æœºå™¨ç ã€‚

**Q: å¿˜è®°å¯†ç æ€ä¹ˆåŠï¼Ÿ**
A: ç®¡ç†å‘˜å¯ä»¥åœ¨æ•°æ®åº“ä¸­ç›´æ¥ä¿®æ”¹ç”¨æˆ·çš„å¯†ç å“ˆå¸Œã€‚

**Q: å¦‚ä½•å¢åŠ ç”¨æˆ·ï¼Ÿ**
A: åœ¨äº‘æ•°æ®åº“ä¸­æ‰‹åŠ¨æ·»åŠ ç”¨æˆ·è®°å½•ï¼Œæˆ–åˆ›å»ºç”¨æˆ·æ³¨å†Œäº‘å‡½æ•°ã€‚

**Q: ç§¯åˆ†ä¸å¤Ÿç”¨æ€ä¹ˆåŠï¼Ÿ**
A: ç®¡ç†å‘˜å¯ä»¥åœ¨æ•°æ®åº“ä¸­ç›´æ¥ä¿®æ”¹ç”¨æˆ·çš„ç§¯åˆ†å€¼ã€‚

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹è…¾è®¯äº‘å¼€å‘å®˜æ–¹æ–‡æ¡£
2. æŸ¥çœ‹äº‘å‡½æ•°æ‰§è¡Œæ—¥å¿—
3. æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIåœ°å€é…ç½® 