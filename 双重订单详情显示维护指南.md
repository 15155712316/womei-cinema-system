# PyQt5电影票务管理系统 - 双重订单详情显示维护指南

## ⚠️ 【重要】双重显示系统架构说明

### 🏗️ **系统架构概述**

PyQt5电影票务管理系统采用双重订单详情显示架构：

#### **主系统：OrderDetailManager**
- **位置**：`modules/order_display/order_detail_manager.py`
- **职责**：统一的订单详情显示管理
- **调用场景**：订单创建、订单查看、常规显示更新

#### **辅助系统：_update_order_detail_with_coupon_info**
- **位置**：`main_modular.py`
- **职责**：券相关操作的实时UI响应
- **调用场景**：券选择、券取消、支付成功、实时更新

---

## 🔄 **双重维护要求**

### **核心原则：任何订单详情显示相关的修改都必须在两个位置同步进行**

#### **必须同步维护的关键位置**

##### **1. 状态映射逻辑**
- **主系统位置**：`modules/order_display/order_detail_manager.py` 第234行
- **辅助系统位置**：`main_modular.py` 第1465行
- **同步内容**：状态映射字典、中文状态名称

##### **2. 券优惠计算逻辑**
- **主系统位置**：`modules/order_display/order_detail_manager.py` 第342行
- **辅助系统位置**：`main_modular.py` 第1521行
- **同步内容**：券信息获取、优惠计算、显示格式

##### **3. 价格显示格式**
- **主系统位置**：`modules/order_display/order_detail_manager.py` 第380行
- **辅助系统位置**：`main_modular.py` 第1540行
- **同步内容**：价格格式、会员价处理、实付金额计算

##### **4. 字段显示顺序**
- **主系统位置**：`modules/order_display/order_detail_manager.py` 第174行
- **辅助系统位置**：`main_modular.py` 第1430行
- **同步内容**：字段顺序、显示格式、标签名称

---

## 📋 **维护检查清单**

### **修改订单详情显示时必须检查的位置**

#### **✅ 基础信息显示**
- [ ] OrderDetailManager._build_basic_info() 方法
- [ ] _legacy_order_detail_display() 方法
- [ ] 字段名称映射逻辑
- [ ] 显示顺序和格式

#### **✅ 状态显示**
- [ ] OrderDetailManager 第234行状态映射
- [ ] main_modular.py 第1465行状态映射
- [ ] 状态映射字典的一致性
- [ ] 中文状态名称的统一

#### **✅ 券优惠显示**
- [ ] OrderDetailManager 第342行券信息获取
- [ ] main_modular.py 第1521行券信息获取
- [ ] 券优惠计算逻辑
- [ ] 券数量显示格式

#### **✅ 价格计算**
- [ ] 原价显示逻辑
- [ ] 会员价计算逻辑
- [ ] 券优惠计算逻辑
- [ ] 最终实付金额计算

#### **✅ UI组件更新**
- [ ] OrderDetailManager的UI更新方式
- [ ] 降级显示的UI更新方式
- [ ] 错误处理和降级机制

---

## 🚨 **防遗忘机制**

### **代码标记系统**

#### **同步维护标记**
```python
# ⚠️ 【同步维护点X】描述 - 必须与另一位置保持一致
# TODO: 修改此逻辑时，必须同步更新另一位置
```

#### **标记位置**
1. **状态映射**：`【同步维护点1】`
2. **券优惠计算**：`【同步维护点2】`
3. **价格显示**：`【同步维护点3】`
4. **字段顺序**：`【同步维护点4】`

### **开发流程嵌入**

#### **修改前检查**
1. 确认修改涉及的显示逻辑类型
2. 查找对应的同步维护点
3. 准备同时修改两个位置

#### **修改中执行**
1. 在主系统中进行修改
2. 立即在辅助系统中进行相同修改
3. 确保逻辑、格式、命名的一致性

#### **修改后验证**
1. 测试主系统的显示效果
2. 测试辅助系统的显示效果
3. 对比两个系统的输出一致性
4. 验证降级机制的正常工作

---

## 🔧 **代码审查机制**

### **审查要点**

#### **一致性检查**
- [ ] 状态映射字典是否完全一致
- [ ] 券优惠计算逻辑是否相同
- [ ] 价格显示格式是否统一
- [ ] 字段显示顺序是否一致

#### **功能完整性检查**
- [ ] 主系统功能是否完整
- [ ] 辅助系统功能是否完整
- [ ] 降级机制是否正常工作
- [ ] 错误处理是否完善

#### **性能影响检查**
- [ ] 是否引入不必要的重复计算
- [ ] 是否影响实时响应性能
- [ ] 是否增加内存使用

---

## 🎯 **最佳实践**

### **修改订单详情显示的标准流程**

#### **1. 需求分析**
- 明确修改的具体内容
- 确定影响的显示逻辑类型
- 评估对两个系统的影响

#### **2. 设计方案**
- 设计统一的显示逻辑
- 确保两个系统的一致性
- 考虑降级和错误处理

#### **3. 实施修改**
- 同时修改两个位置
- 保持代码风格一致
- 更新相关注释和文档

#### **4. 测试验证**
- 测试主系统功能
- 测试辅助系统功能
- 测试降级机制
- 验证一致性

#### **5. 文档更新**
- 更新维护指南
- 更新代码注释
- 记录修改历史

---

## 🚀 **未来优化方向**

### **架构演进建议**

#### **短期优化**
- 继续使用双重系统
- 加强同步维护机制
- 完善代码标记和文档

#### **中期优化**
- 考虑事件驱动架构
- 减少代码重复
- 提高维护效率

#### **长期优化**
- 完全整合到统一系统
- 使用设计模式优化
- 建立自动化测试

---

## 📞 **支持和联系**

### **遇到问题时**
1. 首先检查本维护指南
2. 查看代码中的同步维护标记
3. 对比两个系统的实现差异
4. 参考历史修改记录

### **改进建议**
- 如发现维护指南不完善，请及时更新
- 如发现新的同步维护点，请添加标记
- 如有更好的架构建议，请记录讨论

**记住：订单详情显示的一致性是用户体验的关键，双重维护虽然增加工作量，但确保了系统的稳定性和可靠性！**
