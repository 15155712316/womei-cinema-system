# PyQt5ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿ - æ”¯ä»˜æ–¹å¼é›†æˆå®æ–½æŒ‡å—

## ğŸ¯ å®æ–½æ¦‚è¿°

åŸºäºHARæ–‡ä»¶åˆ†æï¼Œæˆ‘ä»¬ä¸ºPyQt5ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿè¯†åˆ«å‡ºäº†3ç§æ–°çš„æ”¯ä»˜æ–¹å¼ï¼Œæœ¬æŒ‡å—æä¾›è¯¦ç»†çš„é›†æˆæ­¥éª¤å’Œä»£ç å®ç°ã€‚

### ğŸ“‹ æ–°å¢æ”¯ä»˜æ–¹å¼
1. **ğŸ’³ ä¼šå‘˜å¡æ”¯ä»˜** - ä½¿ç”¨ä¼šå‘˜å¡ä½™é¢ç›´æ¥æ”¯ä»˜
2. **ğŸ« æ··åˆæ”¯ä»˜** - åˆ¸æŠµæ‰£ + ä¼šå‘˜å¡ä½™é¢æ”¯ä»˜å‰©ä½™é‡‘é¢  
3. **ğŸ” é¢„æ”¯ä»˜éªŒè¯** - å®æ—¶è®¡ç®—åˆ¸æŠµæ‰£å’Œå®ä»˜é‡‘é¢

---

## ğŸ› ï¸ ç¬¬ä¸€æ­¥ï¼šæ‰©å±•APIå®¢æˆ·ç«¯

### 1.1 åœ¨ `services/api_base.py` ä¸­æ·»åŠ æ–°çš„APIæ–¹æ³•

```python
def get_member_info(self) -> Dict[str, Any]:
    """è·å–ä¼šå‘˜ä¿¡æ¯"""
    params = {
        'cinemaid': self.cinema_id,
        'userid': self.user_id, 
        'openid': self.openid,
        'token': self.token,
        'source': '2'
    }
    return self.get('/MiniTicket/index.php/MiniMember/getMemberInfo', params)

def validate_coupon_prepay(self, order_no: str, coupon_codes: str) -> Dict[str, Any]:
    """éªŒè¯åˆ¸é¢„æ”¯ä»˜"""
    params = {
        'orderno': order_no,
        'couponcode': coupon_codes,
        'cinemaid': self.cinema_id,
        'userid': self.user_id,
        'openid': self.openid, 
        'token': self.token,
        'source': '2'
    }
    return self.get('/MiniTicket/index.php/MiniOrder/ordercouponPrepay', params)

def process_member_card_payment(self, payment_data: Dict[str, Any]) -> Dict[str, Any]:
    """å¤„ç†ä¼šå‘˜å¡æ”¯ä»˜"""
    return self.post('/MiniTicket/index.php/MiniPay/memcardPay', payment_data)
```

### 1.2 åˆ›å»º `services/payment_service.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ”¯ä»˜æœåŠ¡æ¨¡å—
å¤„ç†å¤šç§æ”¯ä»˜æ–¹å¼çš„ä¸šåŠ¡é€»è¾‘
"""

import json
from typing import Dict, List, Any
from .api_base import APIClient

class PaymentService:
    """æ”¯ä»˜æœåŠ¡ç±»"""
    
    def __init__(self, api_client: APIClient):
        self.api_client = api_client
    
    def get_member_info(self) -> Dict[str, Any]:
        """è·å–ä¼šå‘˜ä¿¡æ¯"""
        try:
            response = self.api_client.get_member_info()
            if response.get('resultCode') == '0':
                member_data = response.get('resultData', {})
                return {
                    'success': True,
                    'is_member': True,
                    'cardno': member_data.get('cardno', ''),
                    'mobile': member_data.get('mobile', ''),
                    'memberId': member_data.get('memberId', ''),
                    'cardtype': member_data.get('cardtype', '0'),
                    'cardcinemaid': member_data.get('cardcinemaid', ''),
                    'balance': float(member_data.get('balance', 0)) * 100  # è½¬æ¢ä¸ºåˆ†
                }
            else:
                return {'success': False, 'is_member': False, 'error': response.get('resultDesc', 'è·å–ä¼šå‘˜ä¿¡æ¯å¤±è´¥')}
        except Exception as e:
            return {'success': False, 'is_member': False, 'error': str(e)}
    
    def validate_coupon_prepay(self, order_no: str, coupon_codes: str) -> Dict[str, Any]:
        """éªŒè¯åˆ¸é¢„æ”¯ä»˜"""
        try:
            response = self.api_client.validate_coupon_prepay(order_no, coupon_codes)
            if response.get('resultCode') == '0':
                result_data = response.get('resultData', {})
                return {
                    'success': True,
                    'payment_amount': int(result_data.get('paymentAmount', '0')),
                    'member_payment_amount': int(result_data.get('mempaymentAmount', '0')),
                    'discount_price': int(result_data.get('discountprice', '0')),
                    'discount_member_price': int(result_data.get('discountmemprice', '0')),
                    'total_price': int(result_data.get('totalprice', '0')),
                    'total_member_price': int(result_data.get('totalmemprice', '0')),
                    'coupon_codes': result_data.get('couponcodes', ''),
                    'bind_type': result_data.get('bindType', 0),
                    'coupon_count': result_data.get('couponcount', 0)
                }
            else:
                return {'success': False, 'error': response.get('resultDesc', 'åˆ¸éªŒè¯å¤±è´¥')}
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def process_member_card_payment(self, order_data: Dict[str, Any], member_info: Dict[str, Any], 
                                  member_password: str, coupon_codes: str = '') -> Dict[str, Any]:
        """å¤„ç†ä¼šå‘˜å¡æ”¯ä»˜"""
        try:
            # æ„å»ºä¼šå‘˜ä¿¡æ¯JSON
            member_info_json = json.dumps({
                'cardno': member_info.get('cardno', ''),
                'mobile': member_info.get('mobile', ''),
                'memberId': member_info.get('memberId', ''),
                'cardtype': '0',
                'cardcinemaid': member_info.get('cardcinemaid', ''),
                'balance': member_info.get('balance', 0) / 100  # è½¬æ¢ä¸ºå…ƒ
            })
            
            # æ„å»ºæ”¯ä»˜å‚æ•°
            payment_params = {
                'totalprice': str(order_data.get('total_price', 0)),
                'memberinfo': member_info_json,
                'mempass': member_password,
                'orderno': order_data.get('order_no', ''),
                'couponcodes': coupon_codes,
                'price': str(order_data.get('original_price', 0)),
                'discountprice': str(order_data.get('discount_price', 0)),
                'filmname': order_data.get('film_name', ''),
                'featureno': order_data.get('feature_no', ''),
                'ticketcount': str(order_data.get('ticket_count', 1)),
                'cinemaname': order_data.get('cinema_name', ''),
                'cinemaid': self.api_client.cinema_id,
                'userid': self.api_client.user_id,
                'openid': self.api_client.openid,
                'token': self.api_client.token,
                'source': '2'
            }
            
            response = self.api_client.process_member_card_payment(payment_params)
            
            if response.get('resultCode') == '0':
                return {'success': True, 'message': 'ä¼šå‘˜å¡æ”¯ä»˜æˆåŠŸ'}
            else:
                return {'success': False, 'error': response.get('resultDesc', 'æ”¯ä»˜å¤±è´¥')}
                
        except Exception as e:
            return {'success': False, 'error': str(e)}
```

---

## ğŸ¨ ç¬¬äºŒæ­¥ï¼šåˆ›å»ºæ”¯ä»˜æ–¹å¼é€‰æ‹©ç•Œé¢

### 2.1 åˆ›å»º `ui/dialogs/payment_method_dialog.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ”¯ä»˜æ–¹å¼é€‰æ‹©å¯¹è¯æ¡†
"""

from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QRadioButton, 
                            QButtonGroup, QPushButton, QLabel, QGroupBox,
                            QLineEdit, QMessageBox, QInputDialog)
from PyQt5.QtCore import Qt
from typing import Dict, Any

class PaymentMethodDialog(QDialog):
    """æ”¯ä»˜æ–¹å¼é€‰æ‹©å¯¹è¯æ¡†"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.order_data = {}
        self.member_info = {}
        self.selected_payment_method = 'coupon_only'
        self.setup_ui()
        self.setup_connections()
    
    def setup_ui(self):
        """è®¾ç½®UI"""
        self.setWindowTitle("é€‰æ‹©æ”¯ä»˜æ–¹å¼")
        self.setFixedSize(400, 500)
        
        layout = QVBoxLayout()
        
        # è®¢å•ä¿¡æ¯æ˜¾ç¤º
        self.create_order_info_group(layout)
        
        # æ”¯ä»˜æ–¹å¼é€‰æ‹©
        self.create_payment_method_group(layout)
        
        # ä¼šå‘˜ä¿¡æ¯æ˜¾ç¤º
        self.create_member_info_group(layout)
        
        # é‡‘é¢è®¡ç®—æ˜¾ç¤º
        self.create_amount_info_group(layout)
        
        # æŒ‰é’®åŒºåŸŸ
        self.create_button_group(layout)
        
        self.setLayout(layout)
    
    def create_order_info_group(self, parent_layout):
        """åˆ›å»ºè®¢å•ä¿¡æ¯ç»„"""
        group = QGroupBox("è®¢å•ä¿¡æ¯")
        layout = QVBoxLayout()
        
        self.order_info_label = QLabel()
        layout.addWidget(self.order_info_label)
        
        group.setLayout(layout)
        parent_layout.addWidget(group)
    
    def create_payment_method_group(self, parent_layout):
        """åˆ›å»ºæ”¯ä»˜æ–¹å¼é€‰æ‹©ç»„"""
        group = QGroupBox("æ”¯ä»˜æ–¹å¼")
        layout = QVBoxLayout()
        
        self.payment_group = QButtonGroup()
        
        self.coupon_only_radio = QRadioButton("çº¯åˆ¸æ”¯ä»˜")
        self.member_card_radio = QRadioButton("ä¼šå‘˜å¡æ”¯ä»˜")
        self.mixed_payment_radio = QRadioButton("æ··åˆæ”¯ä»˜ï¼ˆåˆ¸+ä¼šå‘˜å¡ï¼‰")
        
        self.coupon_only_radio.setChecked(True)
        
        self.payment_group.addButton(self.coupon_only_radio, 0)
        self.payment_group.addButton(self.member_card_radio, 1)
        self.payment_group.addButton(self.mixed_payment_radio, 2)
        
        layout.addWidget(self.coupon_only_radio)
        layout.addWidget(self.member_card_radio)
        layout.addWidget(self.mixed_payment_radio)
        
        group.setLayout(layout)
        parent_layout.addWidget(group)
    
    def create_member_info_group(self, parent_layout):
        """åˆ›å»ºä¼šå‘˜ä¿¡æ¯ç»„"""
        self.member_group = QGroupBox("ä¼šå‘˜ä¿¡æ¯")
        layout = QVBoxLayout()
        
        self.member_info_label = QLabel("æœªç™»å½•ä¼šå‘˜")
        layout.addWidget(self.member_info_label)
        
        self.member_group.setLayout(layout)
        parent_layout.addWidget(self.member_group)
    
    def create_amount_info_group(self, parent_layout):
        """åˆ›å»ºé‡‘é¢ä¿¡æ¯ç»„"""
        group = QGroupBox("é‡‘é¢ä¿¡æ¯")
        layout = QVBoxLayout()
        
        self.amount_info_label = QLabel()
        layout.addWidget(self.amount_info_label)
        
        group.setLayout(layout)
        parent_layout.addWidget(group)
    
    def create_button_group(self, parent_layout):
        """åˆ›å»ºæŒ‰é’®ç»„"""
        layout = QHBoxLayout()
        
        self.confirm_btn = QPushButton("ç¡®è®¤æ”¯ä»˜")
        self.cancel_btn = QPushButton("å–æ¶ˆ")
        
        layout.addWidget(self.confirm_btn)
        layout.addWidget(self.cancel_btn)
        
        parent_layout.addLayout(layout)
    
    def setup_connections(self):
        """è®¾ç½®ä¿¡å·è¿æ¥"""
        self.confirm_btn.clicked.connect(self.accept)
        self.cancel_btn.clicked.connect(self.reject)
        self.payment_group.buttonClicked.connect(self.on_payment_method_changed)
    
    def set_order_data(self, order_data: Dict[str, Any]):
        """è®¾ç½®è®¢å•æ•°æ®"""
        self.order_data = order_data
        self.update_order_info()
        self.update_amount_info()
    
    def set_member_info(self, member_info: Dict[str, Any]):
        """è®¾ç½®ä¼šå‘˜ä¿¡æ¯"""
        self.member_info = member_info
        self.update_member_info()
        self.update_payment_options()
    
    def update_order_info(self):
        """æ›´æ–°è®¢å•ä¿¡æ¯æ˜¾ç¤º"""
        if self.order_data:
            info_text = f"å½±ç‰‡: {self.order_data.get('movie', 'N/A')}\n"
            info_text += f"å½±é™¢: {self.order_data.get('cinema', 'N/A')}\n"
            info_text += f"åœºæ¬¡: {self.order_data.get('session', 'N/A')}\n"
            info_text += f"åº§ä½: {self.order_data.get('seats', 'N/A')}\n"
            info_text += f"ç¥¨æ•°: {len(self.order_data.get('seats', []))} å¼ "
            self.order_info_label.setText(info_text)
    
    def update_member_info(self):
        """æ›´æ–°ä¼šå‘˜ä¿¡æ¯æ˜¾ç¤º"""
        if self.member_info.get('is_member'):
            balance = self.member_info.get('balance', 0) / 100  # è½¬æ¢ä¸ºå…ƒ
            info_text = f"ä¼šå‘˜å¡å·: {self.member_info.get('cardno', 'N/A')}\n"
            info_text += f"æ‰‹æœºå·: {self.member_info.get('mobile', 'N/A')}\n"
            info_text += f"ä½™é¢: Â¥{balance:.2f}"
            self.member_info_label.setText(info_text)
        else:
            self.member_info_label.setText("æœªç™»å½•ä¼šå‘˜")
    
    def update_payment_options(self):
        """æ›´æ–°æ”¯ä»˜é€‰é¡¹å¯ç”¨æ€§"""
        is_member = self.member_info.get('is_member', False)
        
        # ä¼šå‘˜å¡æ”¯ä»˜å’Œæ··åˆæ”¯ä»˜éœ€è¦ä¼šå‘˜ç™»å½•
        self.member_card_radio.setEnabled(is_member)
        self.mixed_payment_radio.setEnabled(is_member)
        
        if not is_member and (self.member_card_radio.isChecked() or self.mixed_payment_radio.isChecked()):
            self.coupon_only_radio.setChecked(True)
    
    def update_amount_info(self):
        """æ›´æ–°é‡‘é¢ä¿¡æ¯æ˜¾ç¤º"""
        amount = self.order_data.get('amount', 0)
        info_text = f"è®¢å•é‡‘é¢: Â¥{amount:.2f}\n"
        info_text += f"æ”¯ä»˜æ–¹å¼: {self.get_payment_method_text()}"
        self.amount_info_label.setText(info_text)
    
    def get_payment_method_text(self) -> str:
        """è·å–æ”¯ä»˜æ–¹å¼æ–‡æœ¬"""
        if self.coupon_only_radio.isChecked():
            return "çº¯åˆ¸æ”¯ä»˜"
        elif self.member_card_radio.isChecked():
            return "ä¼šå‘˜å¡æ”¯ä»˜"
        elif self.mixed_payment_radio.isChecked():
            return "æ··åˆæ”¯ä»˜"
        return "æœªé€‰æ‹©"
    
    def on_payment_method_changed(self):
        """æ”¯ä»˜æ–¹å¼æ”¹å˜äº‹ä»¶"""
        self.update_amount_info()
    
    def get_selected_payment_method(self) -> str:
        """è·å–é€‰æ‹©çš„æ”¯ä»˜æ–¹å¼"""
        if self.coupon_only_radio.isChecked():
            return 'coupon_only'
        elif self.member_card_radio.isChecked():
            return 'member_card'
        elif self.mixed_payment_radio.isChecked():
            return 'mixed'
        return 'coupon_only'
```

---

## ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šé›†æˆåˆ°ä¸»çª—å£

### 3.1 åœ¨ `main_modular.py` ä¸­æ·»åŠ æ”¯ä»˜ç®¡ç†å™¨

```python
# åœ¨ç±»åˆå§‹åŒ–ä¸­æ·»åŠ 
def __init__(self):
    # ... ç°æœ‰ä»£ç  ...
    
    # åˆå§‹åŒ–æ”¯ä»˜æœåŠ¡
    from services.payment_service import PaymentService
    self.payment_service = PaymentService(self.api_client)
    
    # ä¼šå‘˜ä¿¡æ¯
    self.member_info = {'is_member': False}
    
    # ... ç°æœ‰ä»£ç  ...

def refresh_member_info(self):
    """åˆ·æ–°ä¼šå‘˜ä¿¡æ¯"""
    try:
        member_result = self.payment_service.get_member_info()
        self.member_info = member_result
        
        if member_result.get('is_member'):
            balance = member_result.get('balance', 0) / 100
            print(f"[ä¼šå‘˜ä¿¡æ¯] å¡å·: {member_result.get('cardno')}, ä½™é¢: Â¥{balance:.2f}")
        else:
            print(f"[ä¼šå‘˜ä¿¡æ¯] æœªç™»å½•ä¼šå‘˜")
            
    except Exception as e:
        print(f"[ä¼šå‘˜ä¿¡æ¯] è·å–å¤±è´¥: {e}")
        self.member_info = {'is_member': False}

def show_enhanced_payment_dialog(self, order_data: Dict[str, Any]):
    """æ˜¾ç¤ºå¢å¼ºçš„æ”¯ä»˜å¯¹è¯æ¡†"""
    try:
        from ui.dialogs.payment_method_dialog import PaymentMethodDialog
        
        # åˆ·æ–°ä¼šå‘˜ä¿¡æ¯
        self.refresh_member_info()
        
        # åˆ›å»ºæ”¯ä»˜å¯¹è¯æ¡†
        dialog = PaymentMethodDialog(self)
        dialog.set_order_data(order_data)
        dialog.set_member_info(self.member_info)
        
        if dialog.exec_() == QDialog.Accepted:
            payment_method = dialog.get_selected_payment_method()
            self.process_enhanced_payment(order_data, payment_method)
            
    except Exception as e:
        print(f"[æ”¯ä»˜å¯¹è¯æ¡†] é”™è¯¯: {e}")
        # é™çº§åˆ°åŸæœ‰æ”¯ä»˜æ–¹å¼
        self._process_coupon_payment(order_data)

def process_enhanced_payment(self, order_data: Dict[str, Any], payment_method: str):
    """å¤„ç†å¢å¼ºæ”¯ä»˜"""
    try:
        if payment_method == 'coupon_only':
            # ä½¿ç”¨ç°æœ‰çš„çº¯åˆ¸æ”¯ä»˜
            self._process_coupon_payment(order_data)
            
        elif payment_method == 'member_card':
            # ä¼šå‘˜å¡æ”¯ä»˜
            self._process_member_card_payment(order_data)
            
        elif payment_method == 'mixed':
            # æ··åˆæ”¯ä»˜
            self._process_mixed_payment(order_data)
            
    except Exception as e:
        print(f"[å¢å¼ºæ”¯ä»˜] é”™è¯¯: {e}")
        QMessageBox.warning(self, "æ”¯ä»˜é”™è¯¯", f"æ”¯ä»˜å¤„ç†å¤±è´¥: {str(e)}")

def _process_member_card_payment(self, order_data: Dict[str, Any]):
    """å¤„ç†ä¼šå‘˜å¡æ”¯ä»˜"""
    try:
        # 1. æ£€æŸ¥ä¼šå‘˜ä¿¡æ¯
        if not self.member_info.get('is_member'):
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆç™»å½•ä¼šå‘˜è´¦æˆ·")
            return
        
        # 2. æ£€æŸ¥ä½™é¢
        balance = self.member_info.get('balance', 0)
        total_amount = int(order_data.get('amount', 0) * 100)  # è½¬æ¢ä¸ºåˆ†
        
        if balance < total_amount:
            QMessageBox.warning(self, "ä½™é¢ä¸è¶³", 
                              f"ä¼šå‘˜å¡ä½™é¢ä¸è¶³\nä½™é¢: Â¥{balance/100:.2f}\néœ€è¦: Â¥{total_amount/100:.2f}")
            return
        
        # 3. è·å–ä¼šå‘˜å¯†ç 
        password, ok = QInputDialog.getText(self, "ä¼šå‘˜å¯†ç ", "è¯·è¾“å…¥ä¼šå‘˜å¡å¯†ç :", QLineEdit.Password)
        if not ok or not password:
            return
        
        # 4. æ„å»ºæ”¯ä»˜æ•°æ®
        payment_data = {
            'total_price': total_amount,
            'order_no': order_data.get('orderno', ''),
            'original_price': total_amount,
            'discount_price': 0,
            'film_name': order_data.get('movie', ''),
            'feature_no': order_data.get('featureno', ''),
            'ticket_count': len(order_data.get('seats', [])),
            'cinema_name': order_data.get('cinema', '')
        }
        
        # 5. æ‰§è¡Œæ”¯ä»˜
        result = self.payment_service.process_member_card_payment(
            payment_data, self.member_info, password
        )
        
        if result['success']:
            QMessageBox.information(self, "æ”¯ä»˜æˆåŠŸ", "ä¼šå‘˜å¡æ”¯ä»˜æˆåŠŸï¼")
            self._get_ticket_code_after_payment(order_data.get('orderno', ''))
        else:
            QMessageBox.warning(self, "æ”¯ä»˜å¤±è´¥", result.get('error', 'æ”¯ä»˜å¤±è´¥'))
            
    except Exception as e:
        print(f"[ä¼šå‘˜å¡æ”¯ä»˜] é”™è¯¯: {e}")
        QMessageBox.warning(self, "æ”¯ä»˜é”™è¯¯", f"ä¼šå‘˜å¡æ”¯ä»˜å¤±è´¥: {str(e)}")

def _process_mixed_payment(self, order_data: Dict[str, Any]):
    """å¤„ç†æ··åˆæ”¯ä»˜"""
    try:
        # 1. æ£€æŸ¥åˆ¸é€‰æ‹©
        selected_coupons = getattr(self, 'selected_coupons', [])
        if not selected_coupons:
            QMessageBox.warning(self, "æç¤º", "è¯·å…ˆé€‰æ‹©ä¼˜æƒ åˆ¸")
            return
        
        # 2. æ£€æŸ¥ä¼šå‘˜ä¿¡æ¯
        if not self.member_info.get('is_member'):
            QMessageBox.warning(self, "æç¤º", "æ··åˆæ”¯ä»˜éœ€è¦ä¼šå‘˜è´¦æˆ·")
            return
        
        # 3. éªŒè¯åˆ¸é¢„æ”¯ä»˜
        coupon_codes = ','.join([c.get('couponcode', '') for c in selected_coupons])
        prepay_result = self.payment_service.validate_coupon_prepay(
            order_data.get('orderno', ''), coupon_codes
        )
        
        if not prepay_result['success']:
            QMessageBox.warning(self, "åˆ¸éªŒè¯å¤±è´¥", prepay_result.get('error', 'åˆ¸éªŒè¯å¤±è´¥'))
            return
        
        # 4. æ£€æŸ¥ä¼šå‘˜ä½™é¢
        member_payment_amount = prepay_result.get('member_payment_amount', 0)
        member_balance = self.member_info.get('balance', 0)
        
        if member_payment_amount > member_balance:
            QMessageBox.warning(self, "ä½™é¢ä¸è¶³", 
                              f"ä¼šå‘˜å¡ä½™é¢ä¸è¶³æ”¯ä»˜å‰©ä½™é‡‘é¢\nä½™é¢: Â¥{member_balance/100:.2f}\néœ€è¦: Â¥{member_payment_amount/100:.2f}")
            return
        
        # 5. è·å–ä¼šå‘˜å¯†ç 
        password, ok = QInputDialog.getText(self, "ä¼šå‘˜å¯†ç ", "è¯·è¾“å…¥ä¼šå‘˜å¡å¯†ç :", QLineEdit.Password)
        if not ok or not password:
            return
        
        # 6. æ„å»ºæ”¯ä»˜æ•°æ®
        payment_data = {
            'total_price': prepay_result.get('total_member_price', 0),
            'order_no': order_data.get('orderno', ''),
            'original_price': prepay_result.get('total_price', 0),
            'discount_price': prepay_result.get('discount_member_price', 0),
            'film_name': order_data.get('movie', ''),
            'feature_no': order_data.get('featureno', ''),
            'ticket_count': len(order_data.get('seats', [])),
            'cinema_name': order_data.get('cinema', '')
        }
        
        # 7. æ‰§è¡Œæ··åˆæ”¯ä»˜
        result = self.payment_service.process_member_card_payment(
            payment_data, self.member_info, password, coupon_codes
        )
        
        if result['success']:
            QMessageBox.information(self, "æ”¯ä»˜æˆåŠŸ", "æ··åˆæ”¯ä»˜æˆåŠŸï¼")
            self._get_ticket_code_after_payment(order_data.get('orderno', ''))
        else:
            QMessageBox.warning(self, "æ”¯ä»˜å¤±è´¥", result.get('error', 'æ”¯ä»˜å¤±è´¥'))
            
    except Exception as e:
        print(f"[æ··åˆæ”¯ä»˜] é”™è¯¯: {e}")
        QMessageBox.warning(self, "æ”¯ä»˜é”™è¯¯", f"æ··åˆæ”¯ä»˜å¤±è´¥: {str(e)}")
```

### 3.2 ä¿®æ”¹ç°æœ‰çš„æ”¯ä»˜è§¦å‘ç‚¹

```python
# åœ¨æäº¤è®¢å•çš„åœ°æ–¹ï¼Œå°†åŸæ¥çš„æ”¯ä»˜è°ƒç”¨æ›¿æ¢ä¸ºï¼š
def on_submit_order(self, selected_seats):
    """æäº¤è®¢å• - ä¿®æ”¹ä¸ºä½¿ç”¨å¢å¼ºæ”¯ä»˜"""
    try:
        # ... ç°æœ‰çš„è®¢å•åˆ›å»ºé€»è¾‘ ...
        
        # åˆ›å»ºè®¢å•æˆåŠŸåï¼Œä½¿ç”¨å¢å¼ºæ”¯ä»˜å¯¹è¯æ¡†
        order_data = {
            'orderno': order_result.get('orderno'),
            'amount': total_amount,
            'movie': current_movie,
            'cinema': current_cinema,
            'session': current_session,
            'seats': selected_seats,
            'featureno': feature_no
        }
        
        # ä½¿ç”¨å¢å¼ºæ”¯ä»˜å¯¹è¯æ¡†æ›¿ä»£åŸæœ‰æ”¯ä»˜
        self.show_enhanced_payment_dialog(order_data)
        
    except Exception as e:
        print(f"[æäº¤è®¢å•] é”™è¯¯: {e}")
        QMessageBox.warning(self, "æäº¤å¤±è´¥", f"è®¢å•æäº¤å¤±è´¥: {str(e)}")
```

---

## ğŸ§ª ç¬¬å››æ­¥ï¼šæµ‹è¯•éªŒè¯

### 4.1 åˆ›å»ºæµ‹è¯•è„šæœ¬

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ”¯ä»˜æ–¹å¼é›†æˆæµ‹è¯•è„šæœ¬
"""

def test_payment_integration():
    """æµ‹è¯•æ”¯ä»˜æ–¹å¼é›†æˆ"""
    print("ğŸ§ª æµ‹è¯•æ”¯ä»˜æ–¹å¼é›†æˆ")
    
    # æµ‹è¯•ä¼šå‘˜ä¿¡æ¯è·å–
    print("1. æµ‹è¯•ä¼šå‘˜ä¿¡æ¯è·å–...")
    
    # æµ‹è¯•åˆ¸é¢„æ”¯ä»˜éªŒè¯
    print("2. æµ‹è¯•åˆ¸é¢„æ”¯ä»˜éªŒè¯...")
    
    # æµ‹è¯•ä¼šå‘˜å¡æ”¯ä»˜
    print("3. æµ‹è¯•ä¼šå‘˜å¡æ”¯ä»˜...")
    
    # æµ‹è¯•æ··åˆæ”¯ä»˜
    print("4. æµ‹è¯•æ··åˆæ”¯ä»˜...")
    
    print("âœ… æµ‹è¯•å®Œæˆ")

if __name__ == "__main__":
    test_payment_integration()
```

### 4.2 æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] ä¼šå‘˜ä¿¡æ¯æ­£ç¡®è·å–å’Œæ˜¾ç¤º
- [ ] æ”¯ä»˜æ–¹å¼é€‰æ‹©ç•Œé¢æ­£å¸¸æ˜¾ç¤º
- [ ] åˆ¸é¢„æ”¯ä»˜éªŒè¯è®¡ç®—æ­£ç¡®
- [ ] ä¼šå‘˜å¡æ”¯ä»˜æµç¨‹å®Œæ•´
- [ ] æ··åˆæ”¯ä»˜é€»è¾‘æ­£ç¡®
- [ ] æ”¯ä»˜æˆåŠŸåå–ç¥¨ç æ­£å¸¸æ˜¾ç¤º
- [ ] é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤ºå®Œå–„

---

## ğŸš€ ç¬¬äº”æ­¥ï¼šéƒ¨ç½²ä¸Šçº¿

### 5.1 éƒ¨ç½²å‰æ£€æŸ¥

1. **ä»£ç å®¡æŸ¥**ï¼šç¡®ä¿æ‰€æœ‰æ–°å¢ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
2. **åŠŸèƒ½æµ‹è¯•**ï¼šå®Œæ•´æµ‹è¯•æ‰€æœ‰æ”¯ä»˜æµç¨‹
3. **å®‰å…¨æ£€æŸ¥**ï¼šéªŒè¯ä¼šå‘˜å¯†ç å¤„ç†å’Œæ•°æ®ä¼ è¾“å®‰å…¨
4. **æ€§èƒ½æµ‹è¯•**ï¼šç¡®ä¿æ–°åŠŸèƒ½ä¸å½±å“ç³»ç»Ÿæ€§èƒ½

### 5.2 ç°åº¦å‘å¸ƒ

1. **å°èŒƒå›´æµ‹è¯•**ï¼šå…ˆåœ¨å°‘æ•°ç”¨æˆ·ä¸­å¯ç”¨æ–°åŠŸèƒ½
2. **ç›‘æ§æ•°æ®**ï¼šè§‚å¯Ÿæ”¯ä»˜æˆåŠŸç‡å’Œé”™è¯¯ç‡
3. **ç”¨æˆ·åé¦ˆ**ï¼šæ”¶é›†ç”¨æˆ·ä½¿ç”¨ä½“éªŒ
4. **é€æ­¥æ¨å¹¿**ï¼šæ ¹æ®æµ‹è¯•ç»“æœé€æ­¥æ‰©å¤§ä½¿ç”¨èŒƒå›´

### 5.3 ç”¨æˆ·åŸ¹è®­

1. **åŠŸèƒ½è¯´æ˜**ï¼šå‘ç”¨æˆ·ä»‹ç»æ–°çš„æ”¯ä»˜æ–¹å¼
2. **æ“ä½œæŒ‡å—**ï¼šæä¾›è¯¦ç»†çš„ä½¿ç”¨æ­¥éª¤
3. **å¸¸è§é—®é¢˜**ï¼šæ•´ç†FAQå’Œè§£å†³æ–¹æ¡ˆ
4. **æŠ€æœ¯æ”¯æŒ**ï¼šæä¾›åŠæ—¶çš„æŠ€æœ¯æ”¯æŒ

---

## ğŸ“‹ æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬æˆåŠŸä¸ºPyQt5ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿé›†æˆäº†3ç§æ–°çš„æ”¯ä»˜æ–¹å¼ï¼š

1. **ğŸ’³ ä¼šå‘˜å¡æ”¯ä»˜** - æä¾›ä¾¿æ·çš„ä¼šå‘˜å¡ä½™é¢æ”¯ä»˜
2. **ğŸ« æ··åˆæ”¯ä»˜** - å®ç°åˆ¸+ä¼šå‘˜å¡çš„ç»„åˆæ”¯ä»˜
3. **ğŸ” é¢„æ”¯ä»˜éªŒè¯** - ç¡®ä¿æ”¯ä»˜é‡‘é¢è®¡ç®—å‡†ç¡®

è¿™äº›æ–°åŠŸèƒ½å°†æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒï¼Œå¢åŠ æ”¯ä»˜æ–¹å¼çš„çµæ´»æ€§ï¼Œå¹¶ä¸ºç³»ç»Ÿå¸¦æ¥æ›´å¥½çš„å•†ä¸šä»·å€¼ã€‚

**é¢„è®¡å¼€å‘æ—¶é—´**ï¼š2-3å‘¨  
**é¢„è®¡æµ‹è¯•æ—¶é—´**ï¼š1å‘¨  
**é¢„è®¡ä¸Šçº¿æ—¶é—´**ï¼š1ä¸ªæœˆå†…
