# PyQt5电影票务管理系统 - 支付方式集成实施指南

## 🎯 实施概述

基于HAR文件分析，我们为PyQt5电影票务管理系统识别出了3种新的支付方式，本指南提供详细的集成步骤和代码实现。

### 📋 新增支付方式
1. **💳 会员卡支付** - 使用会员卡余额直接支付
2. **🎫 混合支付** - 券抵扣 + 会员卡余额支付剩余金额  
3. **🔍 预支付验证** - 实时计算券抵扣和实付金额

---

## 🛠️ 第一步：扩展API客户端

### 1.1 在 `services/api_base.py` 中添加新的API方法

```python
def get_member_info(self) -> Dict[str, Any]:
    """获取会员信息"""
    params = {
        'cinemaid': self.cinema_id,
        'userid': self.user_id, 
        'openid': self.openid,
        'token': self.token,
        'source': '2'
    }
    return self.get('/MiniTicket/index.php/MiniMember/getMemberInfo', params)

def validate_coupon_prepay(self, order_no: str, coupon_codes: str) -> Dict[str, Any]:
    """验证券预支付"""
    params = {
        'orderno': order_no,
        'couponcode': coupon_codes,
        'cinemaid': self.cinema_id,
        'userid': self.user_id,
        'openid': self.openid, 
        'token': self.token,
        'source': '2'
    }
    return self.get('/MiniTicket/index.php/MiniOrder/ordercouponPrepay', params)

def process_member_card_payment(self, payment_data: Dict[str, Any]) -> Dict[str, Any]:
    """处理会员卡支付"""
    return self.post('/MiniTicket/index.php/MiniPay/memcardPay', payment_data)
```

### 1.2 创建 `services/payment_service.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
支付服务模块
处理多种支付方式的业务逻辑
"""

import json
from typing import Dict, List, Any
from .api_base import APIClient

class PaymentService:
    """支付服务类"""
    
    def __init__(self, api_client: APIClient):
        self.api_client = api_client
    
    def get_member_info(self) -> Dict[str, Any]:
        """获取会员信息"""
        try:
            response = self.api_client.get_member_info()
            if response.get('resultCode') == '0':
                member_data = response.get('resultData', {})
                return {
                    'success': True,
                    'is_member': True,
                    'cardno': member_data.get('cardno', ''),
                    'mobile': member_data.get('mobile', ''),
                    'memberId': member_data.get('memberId', ''),
                    'cardtype': member_data.get('cardtype', '0'),
                    'cardcinemaid': member_data.get('cardcinemaid', ''),
                    'balance': float(member_data.get('balance', 0)) * 100  # 转换为分
                }
            else:
                return {'success': False, 'is_member': False, 'error': response.get('resultDesc', '获取会员信息失败')}
        except Exception as e:
            return {'success': False, 'is_member': False, 'error': str(e)}
    
    def validate_coupon_prepay(self, order_no: str, coupon_codes: str) -> Dict[str, Any]:
        """验证券预支付"""
        try:
            response = self.api_client.validate_coupon_prepay(order_no, coupon_codes)
            if response.get('resultCode') == '0':
                result_data = response.get('resultData', {})
                return {
                    'success': True,
                    'payment_amount': int(result_data.get('paymentAmount', '0')),
                    'member_payment_amount': int(result_data.get('mempaymentAmount', '0')),
                    'discount_price': int(result_data.get('discountprice', '0')),
                    'discount_member_price': int(result_data.get('discountmemprice', '0')),
                    'total_price': int(result_data.get('totalprice', '0')),
                    'total_member_price': int(result_data.get('totalmemprice', '0')),
                    'coupon_codes': result_data.get('couponcodes', ''),
                    'bind_type': result_data.get('bindType', 0),
                    'coupon_count': result_data.get('couponcount', 0)
                }
            else:
                return {'success': False, 'error': response.get('resultDesc', '券验证失败')}
        except Exception as e:
            return {'success': False, 'error': str(e)}
    
    def process_member_card_payment(self, order_data: Dict[str, Any], member_info: Dict[str, Any], 
                                  member_password: str, coupon_codes: str = '') -> Dict[str, Any]:
        """处理会员卡支付"""
        try:
            # 构建会员信息JSON
            member_info_json = json.dumps({
                'cardno': member_info.get('cardno', ''),
                'mobile': member_info.get('mobile', ''),
                'memberId': member_info.get('memberId', ''),
                'cardtype': '0',
                'cardcinemaid': member_info.get('cardcinemaid', ''),
                'balance': member_info.get('balance', 0) / 100  # 转换为元
            })
            
            # 构建支付参数
            payment_params = {
                'totalprice': str(order_data.get('total_price', 0)),
                'memberinfo': member_info_json,
                'mempass': member_password,
                'orderno': order_data.get('order_no', ''),
                'couponcodes': coupon_codes,
                'price': str(order_data.get('original_price', 0)),
                'discountprice': str(order_data.get('discount_price', 0)),
                'filmname': order_data.get('film_name', ''),
                'featureno': order_data.get('feature_no', ''),
                'ticketcount': str(order_data.get('ticket_count', 1)),
                'cinemaname': order_data.get('cinema_name', ''),
                'cinemaid': self.api_client.cinema_id,
                'userid': self.api_client.user_id,
                'openid': self.api_client.openid,
                'token': self.api_client.token,
                'source': '2'
            }
            
            response = self.api_client.process_member_card_payment(payment_params)
            
            if response.get('resultCode') == '0':
                return {'success': True, 'message': '会员卡支付成功'}
            else:
                return {'success': False, 'error': response.get('resultDesc', '支付失败')}
                
        except Exception as e:
            return {'success': False, 'error': str(e)}
```

---

## 🎨 第二步：创建支付方式选择界面

### 2.1 创建 `ui/dialogs/payment_method_dialog.py`

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
支付方式选择对话框
"""

from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QRadioButton, 
                            QButtonGroup, QPushButton, QLabel, QGroupBox,
                            QLineEdit, QMessageBox, QInputDialog)
from PyQt5.QtCore import Qt
from typing import Dict, Any

class PaymentMethodDialog(QDialog):
    """支付方式选择对话框"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.order_data = {}
        self.member_info = {}
        self.selected_payment_method = 'coupon_only'
        self.setup_ui()
        self.setup_connections()
    
    def setup_ui(self):
        """设置UI"""
        self.setWindowTitle("选择支付方式")
        self.setFixedSize(400, 500)
        
        layout = QVBoxLayout()
        
        # 订单信息显示
        self.create_order_info_group(layout)
        
        # 支付方式选择
        self.create_payment_method_group(layout)
        
        # 会员信息显示
        self.create_member_info_group(layout)
        
        # 金额计算显示
        self.create_amount_info_group(layout)
        
        # 按钮区域
        self.create_button_group(layout)
        
        self.setLayout(layout)
    
    def create_order_info_group(self, parent_layout):
        """创建订单信息组"""
        group = QGroupBox("订单信息")
        layout = QVBoxLayout()
        
        self.order_info_label = QLabel()
        layout.addWidget(self.order_info_label)
        
        group.setLayout(layout)
        parent_layout.addWidget(group)
    
    def create_payment_method_group(self, parent_layout):
        """创建支付方式选择组"""
        group = QGroupBox("支付方式")
        layout = QVBoxLayout()
        
        self.payment_group = QButtonGroup()
        
        self.coupon_only_radio = QRadioButton("纯券支付")
        self.member_card_radio = QRadioButton("会员卡支付")
        self.mixed_payment_radio = QRadioButton("混合支付（券+会员卡）")
        
        self.coupon_only_radio.setChecked(True)
        
        self.payment_group.addButton(self.coupon_only_radio, 0)
        self.payment_group.addButton(self.member_card_radio, 1)
        self.payment_group.addButton(self.mixed_payment_radio, 2)
        
        layout.addWidget(self.coupon_only_radio)
        layout.addWidget(self.member_card_radio)
        layout.addWidget(self.mixed_payment_radio)
        
        group.setLayout(layout)
        parent_layout.addWidget(group)
    
    def create_member_info_group(self, parent_layout):
        """创建会员信息组"""
        self.member_group = QGroupBox("会员信息")
        layout = QVBoxLayout()
        
        self.member_info_label = QLabel("未登录会员")
        layout.addWidget(self.member_info_label)
        
        self.member_group.setLayout(layout)
        parent_layout.addWidget(self.member_group)
    
    def create_amount_info_group(self, parent_layout):
        """创建金额信息组"""
        group = QGroupBox("金额信息")
        layout = QVBoxLayout()
        
        self.amount_info_label = QLabel()
        layout.addWidget(self.amount_info_label)
        
        group.setLayout(layout)
        parent_layout.addWidget(group)
    
    def create_button_group(self, parent_layout):
        """创建按钮组"""
        layout = QHBoxLayout()
        
        self.confirm_btn = QPushButton("确认支付")
        self.cancel_btn = QPushButton("取消")
        
        layout.addWidget(self.confirm_btn)
        layout.addWidget(self.cancel_btn)
        
        parent_layout.addLayout(layout)
    
    def setup_connections(self):
        """设置信号连接"""
        self.confirm_btn.clicked.connect(self.accept)
        self.cancel_btn.clicked.connect(self.reject)
        self.payment_group.buttonClicked.connect(self.on_payment_method_changed)
    
    def set_order_data(self, order_data: Dict[str, Any]):
        """设置订单数据"""
        self.order_data = order_data
        self.update_order_info()
        self.update_amount_info()
    
    def set_member_info(self, member_info: Dict[str, Any]):
        """设置会员信息"""
        self.member_info = member_info
        self.update_member_info()
        self.update_payment_options()
    
    def update_order_info(self):
        """更新订单信息显示"""
        if self.order_data:
            info_text = f"影片: {self.order_data.get('movie', 'N/A')}\n"
            info_text += f"影院: {self.order_data.get('cinema', 'N/A')}\n"
            info_text += f"场次: {self.order_data.get('session', 'N/A')}\n"
            info_text += f"座位: {self.order_data.get('seats', 'N/A')}\n"
            info_text += f"票数: {len(self.order_data.get('seats', []))} 张"
            self.order_info_label.setText(info_text)
    
    def update_member_info(self):
        """更新会员信息显示"""
        if self.member_info.get('is_member'):
            balance = self.member_info.get('balance', 0) / 100  # 转换为元
            info_text = f"会员卡号: {self.member_info.get('cardno', 'N/A')}\n"
            info_text += f"手机号: {self.member_info.get('mobile', 'N/A')}\n"
            info_text += f"余额: ¥{balance:.2f}"
            self.member_info_label.setText(info_text)
        else:
            self.member_info_label.setText("未登录会员")
    
    def update_payment_options(self):
        """更新支付选项可用性"""
        is_member = self.member_info.get('is_member', False)
        
        # 会员卡支付和混合支付需要会员登录
        self.member_card_radio.setEnabled(is_member)
        self.mixed_payment_radio.setEnabled(is_member)
        
        if not is_member and (self.member_card_radio.isChecked() or self.mixed_payment_radio.isChecked()):
            self.coupon_only_radio.setChecked(True)
    
    def update_amount_info(self):
        """更新金额信息显示"""
        amount = self.order_data.get('amount', 0)
        info_text = f"订单金额: ¥{amount:.2f}\n"
        info_text += f"支付方式: {self.get_payment_method_text()}"
        self.amount_info_label.setText(info_text)
    
    def get_payment_method_text(self) -> str:
        """获取支付方式文本"""
        if self.coupon_only_radio.isChecked():
            return "纯券支付"
        elif self.member_card_radio.isChecked():
            return "会员卡支付"
        elif self.mixed_payment_radio.isChecked():
            return "混合支付"
        return "未选择"
    
    def on_payment_method_changed(self):
        """支付方式改变事件"""
        self.update_amount_info()
    
    def get_selected_payment_method(self) -> str:
        """获取选择的支付方式"""
        if self.coupon_only_radio.isChecked():
            return 'coupon_only'
        elif self.member_card_radio.isChecked():
            return 'member_card'
        elif self.mixed_payment_radio.isChecked():
            return 'mixed'
        return 'coupon_only'
```

---

## 🔧 第三步：集成到主窗口

### 3.1 在 `main_modular.py` 中添加支付管理器

```python
# 在类初始化中添加
def __init__(self):
    # ... 现有代码 ...
    
    # 初始化支付服务
    from services.payment_service import PaymentService
    self.payment_service = PaymentService(self.api_client)
    
    # 会员信息
    self.member_info = {'is_member': False}
    
    # ... 现有代码 ...

def refresh_member_info(self):
    """刷新会员信息"""
    try:
        member_result = self.payment_service.get_member_info()
        self.member_info = member_result
        
        if member_result.get('is_member'):
            balance = member_result.get('balance', 0) / 100
            print(f"[会员信息] 卡号: {member_result.get('cardno')}, 余额: ¥{balance:.2f}")
        else:
            print(f"[会员信息] 未登录会员")
            
    except Exception as e:
        print(f"[会员信息] 获取失败: {e}")
        self.member_info = {'is_member': False}

def show_enhanced_payment_dialog(self, order_data: Dict[str, Any]):
    """显示增强的支付对话框"""
    try:
        from ui.dialogs.payment_method_dialog import PaymentMethodDialog
        
        # 刷新会员信息
        self.refresh_member_info()
        
        # 创建支付对话框
        dialog = PaymentMethodDialog(self)
        dialog.set_order_data(order_data)
        dialog.set_member_info(self.member_info)
        
        if dialog.exec_() == QDialog.Accepted:
            payment_method = dialog.get_selected_payment_method()
            self.process_enhanced_payment(order_data, payment_method)
            
    except Exception as e:
        print(f"[支付对话框] 错误: {e}")
        # 降级到原有支付方式
        self._process_coupon_payment(order_data)

def process_enhanced_payment(self, order_data: Dict[str, Any], payment_method: str):
    """处理增强支付"""
    try:
        if payment_method == 'coupon_only':
            # 使用现有的纯券支付
            self._process_coupon_payment(order_data)
            
        elif payment_method == 'member_card':
            # 会员卡支付
            self._process_member_card_payment(order_data)
            
        elif payment_method == 'mixed':
            # 混合支付
            self._process_mixed_payment(order_data)
            
    except Exception as e:
        print(f"[增强支付] 错误: {e}")
        QMessageBox.warning(self, "支付错误", f"支付处理失败: {str(e)}")

def _process_member_card_payment(self, order_data: Dict[str, Any]):
    """处理会员卡支付"""
    try:
        # 1. 检查会员信息
        if not self.member_info.get('is_member'):
            QMessageBox.warning(self, "提示", "请先登录会员账户")
            return
        
        # 2. 检查余额
        balance = self.member_info.get('balance', 0)
        total_amount = int(order_data.get('amount', 0) * 100)  # 转换为分
        
        if balance < total_amount:
            QMessageBox.warning(self, "余额不足", 
                              f"会员卡余额不足\n余额: ¥{balance/100:.2f}\n需要: ¥{total_amount/100:.2f}")
            return
        
        # 3. 获取会员密码
        password, ok = QInputDialog.getText(self, "会员密码", "请输入会员卡密码:", QLineEdit.Password)
        if not ok or not password:
            return
        
        # 4. 构建支付数据
        payment_data = {
            'total_price': total_amount,
            'order_no': order_data.get('orderno', ''),
            'original_price': total_amount,
            'discount_price': 0,
            'film_name': order_data.get('movie', ''),
            'feature_no': order_data.get('featureno', ''),
            'ticket_count': len(order_data.get('seats', [])),
            'cinema_name': order_data.get('cinema', '')
        }
        
        # 5. 执行支付
        result = self.payment_service.process_member_card_payment(
            payment_data, self.member_info, password
        )
        
        if result['success']:
            QMessageBox.information(self, "支付成功", "会员卡支付成功！")
            self._get_ticket_code_after_payment(order_data.get('orderno', ''))
        else:
            QMessageBox.warning(self, "支付失败", result.get('error', '支付失败'))
            
    except Exception as e:
        print(f"[会员卡支付] 错误: {e}")
        QMessageBox.warning(self, "支付错误", f"会员卡支付失败: {str(e)}")

def _process_mixed_payment(self, order_data: Dict[str, Any]):
    """处理混合支付"""
    try:
        # 1. 检查券选择
        selected_coupons = getattr(self, 'selected_coupons', [])
        if not selected_coupons:
            QMessageBox.warning(self, "提示", "请先选择优惠券")
            return
        
        # 2. 检查会员信息
        if not self.member_info.get('is_member'):
            QMessageBox.warning(self, "提示", "混合支付需要会员账户")
            return
        
        # 3. 验证券预支付
        coupon_codes = ','.join([c.get('couponcode', '') for c in selected_coupons])
        prepay_result = self.payment_service.validate_coupon_prepay(
            order_data.get('orderno', ''), coupon_codes
        )
        
        if not prepay_result['success']:
            QMessageBox.warning(self, "券验证失败", prepay_result.get('error', '券验证失败'))
            return
        
        # 4. 检查会员余额
        member_payment_amount = prepay_result.get('member_payment_amount', 0)
        member_balance = self.member_info.get('balance', 0)
        
        if member_payment_amount > member_balance:
            QMessageBox.warning(self, "余额不足", 
                              f"会员卡余额不足支付剩余金额\n余额: ¥{member_balance/100:.2f}\n需要: ¥{member_payment_amount/100:.2f}")
            return
        
        # 5. 获取会员密码
        password, ok = QInputDialog.getText(self, "会员密码", "请输入会员卡密码:", QLineEdit.Password)
        if not ok or not password:
            return
        
        # 6. 构建支付数据
        payment_data = {
            'total_price': prepay_result.get('total_member_price', 0),
            'order_no': order_data.get('orderno', ''),
            'original_price': prepay_result.get('total_price', 0),
            'discount_price': prepay_result.get('discount_member_price', 0),
            'film_name': order_data.get('movie', ''),
            'feature_no': order_data.get('featureno', ''),
            'ticket_count': len(order_data.get('seats', [])),
            'cinema_name': order_data.get('cinema', '')
        }
        
        # 7. 执行混合支付
        result = self.payment_service.process_member_card_payment(
            payment_data, self.member_info, password, coupon_codes
        )
        
        if result['success']:
            QMessageBox.information(self, "支付成功", "混合支付成功！")
            self._get_ticket_code_after_payment(order_data.get('orderno', ''))
        else:
            QMessageBox.warning(self, "支付失败", result.get('error', '支付失败'))
            
    except Exception as e:
        print(f"[混合支付] 错误: {e}")
        QMessageBox.warning(self, "支付错误", f"混合支付失败: {str(e)}")
```

### 3.2 修改现有的支付触发点

```python
# 在提交订单的地方，将原来的支付调用替换为：
def on_submit_order(self, selected_seats):
    """提交订单 - 修改为使用增强支付"""
    try:
        # ... 现有的订单创建逻辑 ...
        
        # 创建订单成功后，使用增强支付对话框
        order_data = {
            'orderno': order_result.get('orderno'),
            'amount': total_amount,
            'movie': current_movie,
            'cinema': current_cinema,
            'session': current_session,
            'seats': selected_seats,
            'featureno': feature_no
        }
        
        # 使用增强支付对话框替代原有支付
        self.show_enhanced_payment_dialog(order_data)
        
    except Exception as e:
        print(f"[提交订单] 错误: {e}")
        QMessageBox.warning(self, "提交失败", f"订单提交失败: {str(e)}")
```

---

## 🧪 第四步：测试验证

### 4.1 创建测试脚本

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
支付方式集成测试脚本
"""

def test_payment_integration():
    """测试支付方式集成"""
    print("🧪 测试支付方式集成")
    
    # 测试会员信息获取
    print("1. 测试会员信息获取...")
    
    # 测试券预支付验证
    print("2. 测试券预支付验证...")
    
    # 测试会员卡支付
    print("3. 测试会员卡支付...")
    
    # 测试混合支付
    print("4. 测试混合支付...")
    
    print("✅ 测试完成")

if __name__ == "__main__":
    test_payment_integration()
```

### 4.2 测试检查清单

- [ ] 会员信息正确获取和显示
- [ ] 支付方式选择界面正常显示
- [ ] 券预支付验证计算正确
- [ ] 会员卡支付流程完整
- [ ] 混合支付逻辑正确
- [ ] 支付成功后取票码正常显示
- [ ] 错误处理和用户提示完善

---

## 🚀 第五步：部署上线

### 5.1 部署前检查

1. **代码审查**：确保所有新增代码符合项目规范
2. **功能测试**：完整测试所有支付流程
3. **安全检查**：验证会员密码处理和数据传输安全
4. **性能测试**：确保新功能不影响系统性能

### 5.2 灰度发布

1. **小范围测试**：先在少数用户中启用新功能
2. **监控数据**：观察支付成功率和错误率
3. **用户反馈**：收集用户使用体验
4. **逐步推广**：根据测试结果逐步扩大使用范围

### 5.3 用户培训

1. **功能说明**：向用户介绍新的支付方式
2. **操作指南**：提供详细的使用步骤
3. **常见问题**：整理FAQ和解决方案
4. **技术支持**：提供及时的技术支持

---

## 📋 总结

通过以上步骤，我们成功为PyQt5电影票务管理系统集成了3种新的支付方式：

1. **💳 会员卡支付** - 提供便捷的会员卡余额支付
2. **🎫 混合支付** - 实现券+会员卡的组合支付
3. **🔍 预支付验证** - 确保支付金额计算准确

这些新功能将显著提升用户体验，增加支付方式的灵活性，并为系统带来更好的商业价值。

**预计开发时间**：2-3周  
**预计测试时间**：1周  
**预计上线时间**：1个月内
