# 🔧 乐影系统服务器缓存问题解决方案

## 📋 问题描述
- **现象**: 修改后的 api.py 文件（版本 1.5）上传到服务器，但浏览器访问管理后台仍显示旧版本
- **原因**: 服务器端Python进程缓存、Python字节码缓存、浏览器缓存等多重缓存问题

## ✅ 文件状态确认
经过检查，您的 `api.py` 文件已正确更新到版本 1.5，包含：
- ✅ 强制重启功能 (`/force_restart` 端点)
- ✅ 服务器管理面板（包含重启按钮）
- ✅ 自动缓存清理功能
- ✅ 实时服务器时间显示

## 🛠️ 解决方案（按优先级排序）

### 方案1: 使用批处理脚本（推荐）
```bash
# 双击运行或在命令行执行
restart_simple.bat
```

### 方案2: 手动执行命令
在服务器上依次执行以下命令：

#### Windows系统:
```cmd
# 1. 停止Python进程
taskkill /f /im python.exe
taskkill /f /im pythonw.exe

# 2. 清理缓存
for /d /r . %d in (__pycache__) do @if exist "%d" rd /s /q "%d"
del /s /q *.pyc

# 3. 检查端口
netstat -ano | findstr :5000

# 4. 如果端口被占用，释放端口
for /f "tokens=5" %a in ('netstat -ano ^| findstr :5000') do taskkill /f /pid %a

# 5. 重新启动服务器
python api.py
```

#### Linux系统:
```bash
# 1. 停止Python进程
pkill -f "python.*api.py"

# 2. 清理缓存
find . -name "__pycache__" -type d -exec rm -rf {} +
find . -name "*.pyc" -delete

# 3. 检查端口
netstat -tlnp | grep :5000

# 4. 重新启动服务器
python3 api.py
```

### 方案3: 使用新的强制重启API
如果服务器还在运行，可以通过API强制重启：

1. **浏览器访问**: `http://your-server:5000/force_restart`
2. **或使用curl**: `curl -X POST http://your-server:5000/force_restart`

### 方案4: 浏览器端解决
1. **强制刷新**: 按 `Ctrl + F5` 或 `Ctrl + Shift + R`
2. **清除缓存**: 
   - Chrome: F12 → Network → 勾选 "Disable cache"
   - 或清除浏览器数据（Ctrl+Shift+Delete）
3. **无痕模式**: 使用隐私/无痕浏览模式访问

## 🔍 验证步骤

### 1. 检查服务器状态
访问: `http://your-server:5000/`
应该看到:
```json
{
  "service": "乐影系统API服务器",
  "version": "1.5",
  "features": "强制缓存清理 + 服务器重启检测",
  "server_restart_time": "2025-06-07 XX:XX:XX"
}
```

### 2. 检查管理后台
访问: `http://your-server:5000/admin`
应该看到:
- 页面标题显示 "版本 1.5"
- 新增的 "🔄 服务器管理" 面板
- "强制重启服务器" 按钮
- 实时服务器时间显示

### 3. 测试强制重启功能
在管理后台点击 "强制重启服务器" 按钮，应该：
- 弹出确认对话框
- 显示重启进度信息
- 3-5秒后自动刷新页面

## 🚨 故障排除

### 问题1: Python命令不存在
**解决**: 
- 检查Python是否正确安装
- 尝试使用 `python3` 或 `py` 命令
- 检查PATH环境变量

### 问题2: 端口被占用
**解决**:
```cmd
# Windows
netstat -ano | findstr :5000
taskkill /f /pid [PID号]

# Linux
sudo lsof -i :5000
sudo kill -9 [PID号]
```

### 问题3: 权限问题
**解决**:
- 以管理员身份运行命令
- 检查文件权限
- 确保有写入权限

### 问题4: 依赖包问题
**解决**:
```bash
pip install flask pymongo requests
```

## 📊 成功标志

修复成功后，您应该看到：

1. **服务器启动日志**:
```
🚀 启动乐影系统API服务器 v1.5
🔧 本次更新 (v1.5):
  - 🆕 添加强制重启功能 (/force_restart)
  - 🧹 自动清理Python缓存 (.pyc, __pycache__)
  - 🔄 服务器重启检测机制
```

2. **管理后台新功能**:
- 服务器管理面板（粉色背景）
- 强制重启服务器按钮
- 清理缓存按钮
- 实时时间显示

3. **API端点可用**:
- `GET /force_restart` - 强制重启
- 所有原有功能正常

## 🎯 最终建议

1. **立即执行**: 运行 `restart_simple.bat` 脚本
2. **浏览器刷新**: 按 Ctrl+F5 强制刷新
3. **验证功能**: 检查管理后台是否显示版本1.5
4. **测试重启**: 使用新的强制重启按钮
5. **建立机制**: 以后代码更新时，先使用强制重启功能

## 📞 技术支持

如果问题仍然存在，请提供：
1. 服务器操作系统类型
2. Python版本信息
3. 错误日志信息
4. 浏览器类型和版本
5. 网络环境信息

---
**最后更新**: 2025-06-07 19:30:00  
**版本**: 1.0  
**适用于**: 乐影系统 API 服务器 v1.5
