# æ²ƒç¾åˆ¸ä½¿ç”¨å’Œæ”¯ä»˜æµç¨‹æŠ€æœ¯å®ç°æŒ‡å—

## ğŸ¯ æ ¸å¿ƒç¼ºå¤±æ¥å£å®ç°æ–¹æ¡ˆ

### 1. åˆ¸ä»·æ ¼è®¡ç®—æ¥å£

#### æ¥å£è§„èŒƒ
```
POST /ticket/wmyc/cinema/{cinema_id}/order/voucher/price/
```

#### è¯·æ±‚å‚æ•°
```json
{
    "voucher_code": "GZJY01002948425042",
    "order_id": "250624153810000654"
}
```

#### å“åº”æ ¼å¼
```json
{
    "ret": 0,
    "sub": 0,
    "msg": "successfully",
    "data": {
        "surcharge_price": 0,
        "pay_price": 0,
        "surcharge_msg": ""
    }
}
```

#### å®ç°å»ºè®®
```python
# services/womei_voucher_service.py
def calculate_voucher_price(self, cinema_id: str, token: str, voucher_code: str, order_id: str):
    """è®¡ç®—ä½¿ç”¨åˆ¸åçš„è®¢å•ä»·æ ¼"""
    url = f"{self.base_url}/ticket/wmyc/cinema/{cinema_id}/order/voucher/price/"
    
    data = {
        'voucher_code': voucher_code,
        'order_id': order_id
    }
    
    headers = self._get_headers(token)
    response = requests.post(url, data=data, headers=headers)
    return response.json()
```

### 2. æ”¯ä»˜å¤„ç†æ¥å£

#### æ¥å£è§„èŒƒ
```
POST /ticket/wmyc/cinema/{cinema_id}/order/payment/
```

#### è¯·æ±‚å‚æ•°
```json
{
    "order_id": "250624153810000654",
    "mobile": "15155712316", 
    "pay_type": "WECHAT"
}
```

#### å“åº”æ ¼å¼
```json
{
    "ret": 0,
    "sub": 0,
    "msg": "successfully",
    "data": {
        "order_id": "250624153810000654",
        "pay_type": "WECHAT",
        "total_fee": 0,
        "total_price": 0,
        "wechat_pay_certificate": "..."
    }
}
```

#### å®ç°å»ºè®®
```python
# services/womei_payment_service.py
def process_payment(self, cinema_id: str, token: str, order_id: str, mobile: str, pay_type: str):
    """å¤„ç†è®¢å•æ”¯ä»˜"""
    url = f"{self.base_url}/ticket/wmyc/cinema/{cinema_id}/order/payment/"
    
    data = {
        'order_id': order_id,
        'mobile': mobile,
        'pay_type': pay_type
    }
    
    headers = self._get_headers(token)
    response = requests.post(url, data=data, headers=headers)
    return response.json()
```

### 3. åˆ¸ç±»å‹æŸ¥è¯¢æ¥å£

#### æ¥å£è§„èŒƒ
```
GET /ticket/wmyc/cinema/{cinema_id}/user/vouchers?voucher_type={type}&schedule_id={id}&goods_id={id}
```

#### å‚æ•°è¯´æ˜
- `voucher_type`: VGC_T(ç¥¨åˆ¸) / VGC_P(å•†å“åˆ¸)
- `schedule_id`: åœºæ¬¡ID
- `goods_id`: å•†å“ID

#### å®ç°å»ºè®®
```python
def get_vouchers_by_type(self, cinema_id: str, token: str, voucher_type: str, schedule_id: str = "", goods_id: str = ""):
    """æŒ‰ç±»å‹è·å–åˆ¸åˆ—è¡¨"""
    url = f"{self.base_url}/ticket/wmyc/cinema/{cinema_id}/user/vouchers"
    
    params = {
        'voucher_type': voucher_type,
        'schedule_id': schedule_id,
        'goods_id': goods_id
    }
    
    headers = self._get_headers(token)
    response = requests.get(url, params=params, headers=headers)
    return response.json()
```

## ğŸ”„ å®Œæ•´åˆ¸ä½¿ç”¨æµç¨‹å®ç°

### 1. UIå±‚å®ç° (main_modular.py)

```python
def _handle_voucher_selection(self, voucher_code: str):
    """å¤„ç†åˆ¸é€‰æ‹©"""
    try:
        # 1. è®¡ç®—åˆ¸ä»·æ ¼
        price_result = self._calculate_voucher_price(voucher_code)
        if price_result.get('ret') != 0:
            self._show_error_message(f"åˆ¸ä»·æ ¼è®¡ç®—å¤±è´¥: {price_result.get('msg')}")
            return
        
        # 2. æ˜¾ç¤ºä»·æ ¼ä¿¡æ¯
        pay_price = price_result.get('data', {}).get('pay_price', 0)
        surcharge_price = price_result.get('data', {}).get('surcharge_price', 0)
        
        # 3. ç¡®è®¤ä½¿ç”¨åˆ¸
        if self._confirm_voucher_usage(voucher_code, pay_price, surcharge_price):
            self._bind_voucher_to_order(voucher_code)
    
    except Exception as e:
        self._show_error_message(f"åˆ¸é€‰æ‹©å¤±è´¥: {e}")

def _calculate_voucher_price(self, voucher_code: str):
    """è®¡ç®—åˆ¸ä»·æ ¼"""
    from services.womei_voucher_service import get_womei_voucher_service
    
    service = get_womei_voucher_service()
    return service.calculate_voucher_price(
        self.current_cinema_id,
        self.current_account.get('token'),
        voucher_code,
        self.current_order_id
    )

def _bind_voucher_to_order(self, voucher_code: str):
    """ç»‘å®šåˆ¸åˆ°è®¢å•"""
    # è°ƒç”¨è®¢å•ä¿®æ”¹æ¥å£ï¼Œè®¾ç½®voucher_codeå’Œvoucher_code_type
    pass

def _process_payment(self):
    """å¤„ç†æ”¯ä»˜"""
    from services.womei_payment_service import get_womei_payment_service
    
    service = get_womei_payment_service()
    result = service.process_payment(
        self.current_cinema_id,
        self.current_account.get('token'),
        self.current_order_id,
        self.current_account.get('phone'),
        'WECHAT'
    )
    
    if result.get('ret') == 0:
        # å¼€å§‹è½®è¯¢æ”¯ä»˜çŠ¶æ€
        self._start_payment_polling()
    else:
        self._show_error_message(f"æ”¯ä»˜å¤±è´¥: {result.get('msg')}")

def _start_payment_polling(self):
    """å¼€å§‹æ”¯ä»˜çŠ¶æ€è½®è¯¢"""
    self.payment_timer = QTimer()
    self.payment_timer.timeout.connect(self._check_payment_status)
    self.payment_timer.start(2000)  # æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡

def _check_payment_status(self):
    """æ£€æŸ¥æ”¯ä»˜çŠ¶æ€"""
    from services.womei_order_service import get_womei_order_service
    
    service = get_womei_order_service()
    result = service.query_order_status(
        self.current_cinema_id,
        self.current_account.get('token'),
        self.current_order_id
    )
    
    if result.get('ret') == 0:
        status = result.get('data', {}).get('status')
        if status == 'SUCCESS':
            self.payment_timer.stop()
            self._handle_payment_success()
        elif status == 'FAILED':
            self.payment_timer.stop()
            self._handle_payment_failed()
```

### 2. æœåŠ¡å±‚å®ç°

#### åˆ¸æœåŠ¡æ‰©å±•
```python
# services/womei_voucher_service.py
class WomeiVoucherService:
    def calculate_voucher_price(self, cinema_id: str, token: str, voucher_code: str, order_id: str):
        """è®¡ç®—åˆ¸ä»·æ ¼"""
        # å®ç°åˆ¸ä»·æ ¼è®¡ç®—é€»è¾‘
        pass
    
    def get_vouchers_by_type(self, cinema_id: str, token: str, voucher_type: str, schedule_id: str = ""):
        """æŒ‰ç±»å‹è·å–åˆ¸"""
        # å®ç°åˆ¸ç±»å‹æŸ¥è¯¢é€»è¾‘
        pass
```

#### æ”¯ä»˜æœåŠ¡åˆ›å»º
```python
# services/womei_payment_service.py
class WomeiPaymentService:
    def __init__(self):
        self.base_url = "https://ct.womovie.cn"
    
    def process_payment(self, cinema_id: str, token: str, order_id: str, mobile: str, pay_type: str):
        """å¤„ç†æ”¯ä»˜"""
        # å®ç°æ”¯ä»˜å¤„ç†é€»è¾‘
        pass
    
    def query_payment_status(self, cinema_id: str, token: str, order_id: str):
        """æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€"""
        # å®ç°æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢é€»è¾‘
        pass
```

### 3. APIå±‚å®ç°

```python
# api/payment_api.py
class PaymentAPI:
    def process_order_payment(self, cinema_id: str, token: str, order_id: str, mobile: str, pay_type: str):
        """å¤„ç†è®¢å•æ”¯ä»˜"""
        try:
            from services.womei_payment_service import get_womei_payment_service
            service = get_womei_payment_service()
            
            result = service.process_payment(cinema_id, token, order_id, mobile, pay_type)
            
            return {
                'success': result.get('ret') == 0,
                'code': 200 if result.get('ret') == 0 else 500,
                'message': result.get('msg', ''),
                'data': result.get('data')
            }
        except Exception as e:
            return {
                'success': False,
                'code': 500,
                'message': f'æ”¯ä»˜å¤„ç†å¤±è´¥: {str(e)}',
                'data': None
            }
```

## ğŸ“‹ å®æ–½è®¡åˆ’

### é˜¶æ®µä¸€ï¼šæ ¸å¿ƒæ¥å£å®ç° (1-2å¤©)
1. å®ç°åˆ¸ä»·æ ¼è®¡ç®—æ¥å£
2. å®ç°æ”¯ä»˜å¤„ç†æ¥å£
3. å®Œå–„è®¢å•ä¿®æ”¹æ¥å£çš„åˆ¸ç»‘å®šåŠŸèƒ½

### é˜¶æ®µäºŒï¼šæµç¨‹æ•´åˆ (1å¤©)
1. æ•´åˆåˆ¸é€‰æ‹©åˆ°æ”¯ä»˜çš„å®Œæ•´æµç¨‹
2. æ·»åŠ æ”¯ä»˜çŠ¶æ€è½®è¯¢æœºåˆ¶
3. å®Œå–„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º

### é˜¶æ®µä¸‰ï¼šåŠŸèƒ½å¢å¼º (1-2å¤©)
1. å®ç°åˆ¸ç±»å‹æŸ¥è¯¢æ¥å£
2. æ·»åŠ VCCåˆ¸æ”¯æŒ
3. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•
- åˆ¸ä»·æ ¼è®¡ç®—æ¥å£æµ‹è¯•
- æ”¯ä»˜å¤„ç†æ¥å£æµ‹è¯•
- çŠ¶æ€è½®è¯¢æœºåˆ¶æµ‹è¯•

### 2. é›†æˆæµ‹è¯•
- å®Œæ•´åˆ¸ä½¿ç”¨æµç¨‹æµ‹è¯•
- æ”¯ä»˜æˆåŠŸ/å¤±è´¥åœºæ™¯æµ‹è¯•
- ç½‘ç»œå¼‚å¸¸å¤„ç†æµ‹è¯•

### 3. ç”¨æˆ·ä½“éªŒæµ‹è¯•
- åˆ¸é€‰æ‹©ç•Œé¢æµ‹è¯•
- æ”¯ä»˜è¿›åº¦æç¤ºæµ‹è¯•
- é”™è¯¯ä¿¡æ¯å±•ç¤ºæµ‹è¯•

é€šè¿‡ä»¥ä¸Šå®ç°æ–¹æ¡ˆï¼Œå¯ä»¥å®Œæ•´åœ°è¡¥å……æ²ƒç¾ç”µå½±ç¥¨åŠ¡ç³»ç»Ÿçš„åˆ¸ä½¿ç”¨å’Œæ”¯ä»˜åŠŸèƒ½ã€‚
