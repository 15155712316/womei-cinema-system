# 沃美券使用和支付流程技术实现指南

## 🎯 核心缺失接口实现方案

### 1. 券价格计算接口

#### 接口规范
```
POST /ticket/wmyc/cinema/{cinema_id}/order/voucher/price/
```

#### 请求参数
```json
{
    "voucher_code": "GZJY01002948425042",
    "order_id": "250624153810000654"
}
```

#### 响应格式
```json
{
    "ret": 0,
    "sub": 0,
    "msg": "successfully",
    "data": {
        "surcharge_price": 0,
        "pay_price": 0,
        "surcharge_msg": ""
    }
}
```

#### 实现建议
```python
# services/womei_voucher_service.py
def calculate_voucher_price(self, cinema_id: str, token: str, voucher_code: str, order_id: str):
    """计算使用券后的订单价格"""
    url = f"{self.base_url}/ticket/wmyc/cinema/{cinema_id}/order/voucher/price/"
    
    data = {
        'voucher_code': voucher_code,
        'order_id': order_id
    }
    
    headers = self._get_headers(token)
    response = requests.post(url, data=data, headers=headers)
    return response.json()
```

### 2. 支付处理接口

#### 接口规范
```
POST /ticket/wmyc/cinema/{cinema_id}/order/payment/
```

#### 请求参数
```json
{
    "order_id": "250624153810000654",
    "mobile": "15155712316", 
    "pay_type": "WECHAT"
}
```

#### 响应格式
```json
{
    "ret": 0,
    "sub": 0,
    "msg": "successfully",
    "data": {
        "order_id": "250624153810000654",
        "pay_type": "WECHAT",
        "total_fee": 0,
        "total_price": 0,
        "wechat_pay_certificate": "..."
    }
}
```

#### 实现建议
```python
# services/womei_payment_service.py
def process_payment(self, cinema_id: str, token: str, order_id: str, mobile: str, pay_type: str):
    """处理订单支付"""
    url = f"{self.base_url}/ticket/wmyc/cinema/{cinema_id}/order/payment/"
    
    data = {
        'order_id': order_id,
        'mobile': mobile,
        'pay_type': pay_type
    }
    
    headers = self._get_headers(token)
    response = requests.post(url, data=data, headers=headers)
    return response.json()
```

### 3. 券类型查询接口

#### 接口规范
```
GET /ticket/wmyc/cinema/{cinema_id}/user/vouchers?voucher_type={type}&schedule_id={id}&goods_id={id}
```

#### 参数说明
- `voucher_type`: VGC_T(票券) / VGC_P(商品券)
- `schedule_id`: 场次ID
- `goods_id`: 商品ID

#### 实现建议
```python
def get_vouchers_by_type(self, cinema_id: str, token: str, voucher_type: str, schedule_id: str = "", goods_id: str = ""):
    """按类型获取券列表"""
    url = f"{self.base_url}/ticket/wmyc/cinema/{cinema_id}/user/vouchers"
    
    params = {
        'voucher_type': voucher_type,
        'schedule_id': schedule_id,
        'goods_id': goods_id
    }
    
    headers = self._get_headers(token)
    response = requests.get(url, params=params, headers=headers)
    return response.json()
```

## 🔄 完整券使用流程实现

### 1. UI层实现 (main_modular.py)

```python
def _handle_voucher_selection(self, voucher_code: str):
    """处理券选择"""
    try:
        # 1. 计算券价格
        price_result = self._calculate_voucher_price(voucher_code)
        if price_result.get('ret') != 0:
            self._show_error_message(f"券价格计算失败: {price_result.get('msg')}")
            return
        
        # 2. 显示价格信息
        pay_price = price_result.get('data', {}).get('pay_price', 0)
        surcharge_price = price_result.get('data', {}).get('surcharge_price', 0)
        
        # 3. 确认使用券
        if self._confirm_voucher_usage(voucher_code, pay_price, surcharge_price):
            self._bind_voucher_to_order(voucher_code)
    
    except Exception as e:
        self._show_error_message(f"券选择失败: {e}")

def _calculate_voucher_price(self, voucher_code: str):
    """计算券价格"""
    from services.womei_voucher_service import get_womei_voucher_service
    
    service = get_womei_voucher_service()
    return service.calculate_voucher_price(
        self.current_cinema_id,
        self.current_account.get('token'),
        voucher_code,
        self.current_order_id
    )

def _bind_voucher_to_order(self, voucher_code: str):
    """绑定券到订单"""
    # 调用订单修改接口，设置voucher_code和voucher_code_type
    pass

def _process_payment(self):
    """处理支付"""
    from services.womei_payment_service import get_womei_payment_service
    
    service = get_womei_payment_service()
    result = service.process_payment(
        self.current_cinema_id,
        self.current_account.get('token'),
        self.current_order_id,
        self.current_account.get('phone'),
        'WECHAT'
    )
    
    if result.get('ret') == 0:
        # 开始轮询支付状态
        self._start_payment_polling()
    else:
        self._show_error_message(f"支付失败: {result.get('msg')}")

def _start_payment_polling(self):
    """开始支付状态轮询"""
    self.payment_timer = QTimer()
    self.payment_timer.timeout.connect(self._check_payment_status)
    self.payment_timer.start(2000)  # 每2秒检查一次

def _check_payment_status(self):
    """检查支付状态"""
    from services.womei_order_service import get_womei_order_service
    
    service = get_womei_order_service()
    result = service.query_order_status(
        self.current_cinema_id,
        self.current_account.get('token'),
        self.current_order_id
    )
    
    if result.get('ret') == 0:
        status = result.get('data', {}).get('status')
        if status == 'SUCCESS':
            self.payment_timer.stop()
            self._handle_payment_success()
        elif status == 'FAILED':
            self.payment_timer.stop()
            self._handle_payment_failed()
```

### 2. 服务层实现

#### 券服务扩展
```python
# services/womei_voucher_service.py
class WomeiVoucherService:
    def calculate_voucher_price(self, cinema_id: str, token: str, voucher_code: str, order_id: str):
        """计算券价格"""
        # 实现券价格计算逻辑
        pass
    
    def get_vouchers_by_type(self, cinema_id: str, token: str, voucher_type: str, schedule_id: str = ""):
        """按类型获取券"""
        # 实现券类型查询逻辑
        pass
```

#### 支付服务创建
```python
# services/womei_payment_service.py
class WomeiPaymentService:
    def __init__(self):
        self.base_url = "https://ct.womovie.cn"
    
    def process_payment(self, cinema_id: str, token: str, order_id: str, mobile: str, pay_type: str):
        """处理支付"""
        # 实现支付处理逻辑
        pass
    
    def query_payment_status(self, cinema_id: str, token: str, order_id: str):
        """查询支付状态"""
        # 实现支付状态查询逻辑
        pass
```

### 3. API层实现

```python
# api/payment_api.py
class PaymentAPI:
    def process_order_payment(self, cinema_id: str, token: str, order_id: str, mobile: str, pay_type: str):
        """处理订单支付"""
        try:
            from services.womei_payment_service import get_womei_payment_service
            service = get_womei_payment_service()
            
            result = service.process_payment(cinema_id, token, order_id, mobile, pay_type)
            
            return {
                'success': result.get('ret') == 0,
                'code': 200 if result.get('ret') == 0 else 500,
                'message': result.get('msg', ''),
                'data': result.get('data')
            }
        except Exception as e:
            return {
                'success': False,
                'code': 500,
                'message': f'支付处理失败: {str(e)}',
                'data': None
            }
```

## 📋 实施计划

### 阶段一：核心接口实现 (1-2天)
1. 实现券价格计算接口
2. 实现支付处理接口
3. 完善订单修改接口的券绑定功能

### 阶段二：流程整合 (1天)
1. 整合券选择到支付的完整流程
2. 添加支付状态轮询机制
3. 完善错误处理和用户提示

### 阶段三：功能增强 (1-2天)
1. 实现券类型查询接口
2. 添加VCC券支持
3. 优化用户体验

## 🧪 测试建议

### 1. 单元测试
- 券价格计算接口测试
- 支付处理接口测试
- 状态轮询机制测试

### 2. 集成测试
- 完整券使用流程测试
- 支付成功/失败场景测试
- 网络异常处理测试

### 3. 用户体验测试
- 券选择界面测试
- 支付进度提示测试
- 错误信息展示测试

通过以上实现方案，可以完整地补充沃美电影票务系统的券使用和支付功能。
