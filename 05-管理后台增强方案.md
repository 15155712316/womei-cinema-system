# PyQt5电影票务管理系统 - 管理后台增强方案

## 📋 **方案概览**

**基于现有api.py的Web管理界面优化**  
**目标**：支持50-100用户的完整管理功能  
**核心功能**：用户管理、设备管理、积分管理、数据统计、权限控制

---

## 🎨 **5. Web管理后台增强**

### **5.1 现有管理后台分析**

#### **当前功能评估**
```python
# 现有api.py管理后台功能 (349-697行)
当前功能：
✅ 基础用户列表显示
✅ 添加/删除用户
✅ 用户状态切换
✅ 积分管理
✅ 机器码显示

存在问题：
❌ 界面功能单一
❌ 缺乏数据统计
❌ 无设备管理功能
❌ 缺乏操作日志
❌ 无权限控制
❌ 性能问题（全量加载）
```

### **5.2 增强的Web管理界面**

#### **新版管理后台架构**
```python
# admin_enhanced.py - 增强的管理后台
from flask import Flask, render_template, request, jsonify, session
from datetime import datetime, timedelta
import math

class EnhancedAdminPanel:
    """增强的管理后台"""
    
    def __init__(self, db):
        self.users = db["users"]
        self.login_logs = db["loginLogs"]
        self.admin_logs = db["adminLogs"]
        self.page_size = 20  # 分页大小
    
    def get_dashboard_data(self):
        """获取仪表板数据"""
        try:
            # 基础统计
            total_users = self.users.count_documents({})
            active_users = self.users.count_documents({"account.status.code": 1})
            online_users = self.users.count_documents({"device.isOnline": True})
            
            # 今日登录统计
            today = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)
            today_logins = self.login_logs.count_documents({
                "loginTime": {"$gte": today},
                "loginResult": "success"
            })
            
            # 设备绑定统计
            bound_devices = self.users.count_documents({"device.machineCode": {"$exists": True, "$ne": None}})
            
            # 积分统计
            pipeline = [
                {"$group": {
                    "_id": None,
                    "totalPoints": {"$sum": "$account.points"},
                    "avgPoints": {"$avg": "$account.points"}
                }}
            ]
            points_stats = list(self.users.aggregate(pipeline))
            total_points = points_stats[0]["totalPoints"] if points_stats else 0
            avg_points = points_stats[0]["avgPoints"] if points_stats else 0
            
            # 最近7天登录趋势
            login_trend = self._get_login_trend(7)
            
            return {
                "summary": {
                    "totalUsers": total_users,
                    "activeUsers": active_users,
                    "onlineUsers": online_users,
                    "todayLogins": today_logins,
                    "boundDevices": bound_devices,
                    "totalPoints": int(total_points),
                    "avgPoints": round(avg_points, 1)
                },
                "trends": {
                    "loginTrend": login_trend
                }
            }
            
        except Exception as e:
            print(f"获取仪表板数据失败: {e}")
            return {"summary": {}, "trends": {}}
    
    def get_users_paginated(self, page=1, search="", status_filter="all", sort_by="created", sort_order="desc"):
        """分页获取用户列表"""
        try:
            # 构建查询条件
            query = {}
            
            # 搜索条件
            if search:
                query["$or"] = [
                    {"phone": {"$regex": search, "$options": "i"}},
                    {"profile.displayName": {"$regex": search, "$options": "i"}}
                ]
            
            # 状态筛选
            if status_filter != "all":
                if status_filter == "active":
                    query["account.status.code"] = 1
                elif status_filter == "disabled":
                    query["account.status.code"] = 0
                elif status_filter == "online":
                    query["device.isOnline"] = True
                elif status_filter == "unbound":
                    query["device.machineCode"] = {"$exists": False}
            
            # 排序
            sort_field = {
                "created": "metadata.createdAt",
                "login": "device.lastLoginTime",
                "points": "account.points",
                "phone": "phone"
            }.get(sort_by, "metadata.createdAt")
            
            sort_direction = -1 if sort_order == "desc" else 1
            
            # 分页计算
            skip = (page - 1) * self.page_size
            
            # 查询数据
            total = self.users.count_documents(query)
            users = list(self.users.find(query)
                        .sort(sort_field, sort_direction)
                        .skip(skip)
                        .limit(self.page_size))
            
            # 格式化用户数据
            formatted_users = []
            for user in users:
                formatted_users.append({
                    "userId": str(user["_id"]),
                    "phone": user["phone"],
                    "displayName": user.get("profile", {}).get("displayName", f"用户{user['phone']}"),
                    "points": user.get("account", {}).get("points", 0),
                    "status": user.get("account", {}).get("status", {"code": 1, "text": "正常"}),
                    "machineCode": user.get("device", {}).get("machineCode"),
                    "deviceInfo": user.get("device", {}).get("deviceInfo", {}),
                    "lastLoginTime": user.get("device", {}).get("lastLoginTime"),
                    "loginCount": user.get("device", {}).get("loginCount", 0),
                    "isOnline": user.get("device", {}).get("isOnline", False),
                    "createdAt": user.get("metadata", {}).get("createdAt")
                })
            
            # 分页信息
            total_pages = math.ceil(total / self.page_size)
            
            return {
                "users": formatted_users,
                "pagination": {
                    "currentPage": page,
                    "totalPages": total_pages,
                    "totalUsers": total,
                    "pageSize": self.page_size,
                    "hasNext": page < total_pages,
                    "hasPrev": page > 1
                }
            }
            
        except Exception as e:
            print(f"获取用户列表失败: {e}")
            return {"users": [], "pagination": {}}
    
    def get_user_detail(self, phone):
        """获取用户详细信息"""
        try:
            user = self.users.find_one({"phone": phone})
            if not user:
                return {"success": False, "message": "用户不存在"}
            
            # 获取用户登录历史
            login_history = list(self.login_logs.find({"phone": phone})
                               .sort("loginTime", -1)
                               .limit(10))
            
            return {
                "success": True,
                "user": {
                    "userId": str(user["_id"]),
                    "phone": user["phone"],
                    "profile": user.get("profile", {}),
                    "account": user.get("account", {}),
                    "device": user.get("device", {}),
                    "security": user.get("security", {}),
                    "metadata": user.get("metadata", {})
                },
                "loginHistory": login_history
            }
            
        except Exception as e:
            print(f"获取用户详情失败: {e}")
            return {"success": False, "message": f"获取失败: {str(e)}"}
    
    def _get_login_trend(self, days):
        """获取登录趋势数据"""
        try:
            end_date = datetime.now().replace(hour=23, minute=59, second=59, microsecond=999999)
            start_date = end_date - timedelta(days=days-1)
            start_date = start_date.replace(hour=0, minute=0, second=0, microsecond=0)
            
            pipeline = [
                {
                    "$match": {
                        "loginTime": {"$gte": start_date, "$lte": end_date},
                        "loginResult": "success"
                    }
                },
                {
                    "$group": {
                        "_id": {
                            "$dateToString": {
                                "format": "%Y-%m-%d",
                                "date": "$loginTime"
                            }
                        },
                        "count": {"$sum": 1},
                        "uniqueUsers": {"$addToSet": "$phone"}
                    }
                },
                {
                    "$project": {
                        "date": "$_id",
                        "logins": "$count",
                        "uniqueUsers": {"$size": "$uniqueUsers"}
                    }
                },
                {"$sort": {"date": 1}}
            ]
            
            results = list(self.login_logs.aggregate(pipeline))
            
            # 填充缺失的日期
            trend_data = []
            current_date = start_date
            
            for i in range(days):
                date_str = current_date.strftime("%Y-%m-%d")
                found = next((r for r in results if r["date"] == date_str), None)
                
                trend_data.append({
                    "date": date_str,
                    "logins": found["logins"] if found else 0,
                    "uniqueUsers": found["uniqueUsers"] if found else 0
                })
                
                current_date += timedelta(days=1)
            
            return trend_data
            
        except Exception as e:
            print(f"获取登录趋势失败: {e}")
            return []

# Flask路由集成
admin_panel = EnhancedAdminPanel(auth_api.db)

@app.route("/admin/v2")
def admin_dashboard_v2():
    """新版管理后台首页"""
    dashboard_data = admin_panel.get_dashboard_data()
    return render_template("admin_dashboard_v2.html", data=dashboard_data)

@app.route("/admin/v2/users")
def admin_users_v2():
    """用户管理页面"""
    page = int(request.args.get("page", 1))
    search = request.args.get("search", "")
    status_filter = request.args.get("status", "all")
    sort_by = request.args.get("sort", "created")
    sort_order = request.args.get("order", "desc")
    
    users_data = admin_panel.get_users_paginated(page, search, status_filter, sort_by, sort_order)
    return render_template("admin_users_v2.html", **users_data)

@app.route("/admin/v2/api/user/<phone>")
def admin_user_detail_api(phone):
    """用户详情API"""
    return jsonify(admin_panel.get_user_detail(phone))
```

### **5.3 设备管理功能**

#### **设备管理API**
```python
class DeviceManagementPanel:
    """设备管理面板"""
    
    def __init__(self, db):
        self.users = db["users"]
        self.admin_logs = db["adminLogs"]
    
    def get_device_list(self, page=1, search=""):
        """获取设备列表"""
        try:
            query = {"device.machineCode": {"$exists": True, "$ne": None}}
            
            if search:
                query["$or"] = [
                    {"phone": {"$regex": search, "$options": "i"}},
                    {"device.machineCode": {"$regex": search, "$options": "i"}},
                    {"device.deviceInfo.hostname": {"$regex": search, "$options": "i"}}
                ]
            
            skip = (page - 1) * 20
            total = self.users.count_documents(query)
            devices = list(self.users.find(query)
                          .sort("device.lastLoginTime", -1)
                          .skip(skip)
                          .limit(20))
            
            formatted_devices = []
            for device in devices:
                device_info = device.get("device", {})
                formatted_devices.append({
                    "phone": device["phone"],
                    "displayName": device.get("profile", {}).get("displayName", f"用户{device['phone']}"),
                    "machineCode": device_info.get("machineCode"),
                    "deviceInfo": device_info.get("deviceInfo", {}),
                    "bindTime": device_info.get("bindTime"),
                    "lastLoginTime": device_info.get("lastLoginTime"),
                    "loginCount": device_info.get("loginCount", 0),
                    "isOnline": device_info.get("isOnline", False),
                    "status": device.get("account", {}).get("status", {"code": 1, "text": "正常"})
                })
            
            return {
                "devices": formatted_devices,
                "pagination": {
                    "currentPage": page,
                    "totalPages": math.ceil(total / 20),
                    "totalDevices": total
                }
            }
            
        except Exception as e:
            print(f"获取设备列表失败: {e}")
            return {"devices": [], "pagination": {}}
    
    def unbind_device(self, phone, admin_user, reason="管理员操作"):
        """解绑设备"""
        try:
            result = self.users.update_one(
                {"phone": phone},
                {
                    "$unset": {"device.machineCode": ""},
                    "$set": {
                        "device.unbindTime": datetime.now(),
                        "device.unbindReason": reason,
                        "device.unbindBy": admin_user,
                        "device.isOnline": False,
                        "metadata.updatedAt": datetime.now()
                    }
                }
            )
            
            if result.modified_count > 0:
                # 记录管理员操作日志
                self._log_admin_action(admin_user, "unbind_device", phone, reason)
                return {"success": True, "message": "设备解绑成功"}
            else:
                return {"success": False, "message": "用户不存在或设备未绑定"}
                
        except Exception as e:
            return {"success": False, "message": f"解绑失败: {str(e)}"}
    
    def force_offline(self, phone, admin_user, reason="管理员强制下线"):
        """强制用户下线"""
        try:
            result = self.users.update_one(
                {"phone": phone},
                {
                    "$set": {
                        "device.isOnline": False,
                        "device.forceOfflineTime": datetime.now(),
                        "device.forceOfflineReason": reason,
                        "device.forceOfflineBy": admin_user,
                        "metadata.updatedAt": datetime.now()
                    }
                }
            )
            
            if result.modified_count > 0:
                self._log_admin_action(admin_user, "force_offline", phone, reason)
                return {"success": True, "message": "用户已强制下线"}
            else:
                return {"success": False, "message": "用户不存在"}
                
        except Exception as e:
            return {"success": False, "message": f"强制下线失败: {str(e)}"}
    
    def _log_admin_action(self, admin_user, action, target, reason):
        """记录管理员操作日志"""
        try:
            log_entry = {
                "adminUser": admin_user,
                "action": action,
                "target": target,
                "reason": reason,
                "timestamp": datetime.now(),
                "ip": request.environ.get('REMOTE_ADDR', 'Unknown')
            }
            self.admin_logs.insert_one(log_entry)
        except Exception as e:
            print(f"记录管理员日志失败: {e}")

# Flask路由
device_panel = DeviceManagementPanel(auth_api.db)

@app.route("/admin/v2/devices")
def admin_devices():
    """设备管理页面"""
    page = int(request.args.get("page", 1))
    search = request.args.get("search", "")
    devices_data = device_panel.get_device_list(page, search)
    return render_template("admin_devices.html", **devices_data)

@app.route("/admin/v2/api/device/unbind", methods=["POST"])
def admin_unbind_device():
    """解绑设备API"""
    data = request.json
    phone = data.get("phone")
    reason = data.get("reason", "管理员操作")
    admin_user = session.get("admin_user", "unknown")
    
    return jsonify(device_panel.unbind_device(phone, admin_user, reason))
```
