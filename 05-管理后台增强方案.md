# PyQt5ç”µå½±ç¥¨åŠ¡ç®¡ç†ç³»ç»Ÿ - ç®¡ç†åå°å¢å¼ºæ–¹æ¡ˆ

## ğŸ“‹ **æ–¹æ¡ˆæ¦‚è§ˆ**

**åŸºäºç°æœ‰api.pyçš„Webç®¡ç†ç•Œé¢ä¼˜åŒ–**  
**ç›®æ ‡**ï¼šæ”¯æŒ50-100ç”¨æˆ·çš„å®Œæ•´ç®¡ç†åŠŸèƒ½  
**æ ¸å¿ƒåŠŸèƒ½**ï¼šç”¨æˆ·ç®¡ç†ã€è®¾å¤‡ç®¡ç†ã€ç§¯åˆ†ç®¡ç†ã€æ•°æ®ç»Ÿè®¡ã€æƒé™æ§åˆ¶

---

## ğŸ¨ **5. Webç®¡ç†åå°å¢å¼º**

### **5.1 ç°æœ‰ç®¡ç†åå°åˆ†æ**

#### **å½“å‰åŠŸèƒ½è¯„ä¼°**
```python
# ç°æœ‰api.pyç®¡ç†åå°åŠŸèƒ½ (349-697è¡Œ)
å½“å‰åŠŸèƒ½ï¼š
âœ… åŸºç¡€ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤º
âœ… æ·»åŠ /åˆ é™¤ç”¨æˆ·
âœ… ç”¨æˆ·çŠ¶æ€åˆ‡æ¢
âœ… ç§¯åˆ†ç®¡ç†
âœ… æœºå™¨ç æ˜¾ç¤º

å­˜åœ¨é—®é¢˜ï¼š
âŒ ç•Œé¢åŠŸèƒ½å•ä¸€
âŒ ç¼ºä¹æ•°æ®ç»Ÿè®¡
âŒ æ— è®¾å¤‡ç®¡ç†åŠŸèƒ½
âŒ ç¼ºä¹æ“ä½œæ—¥å¿—
âŒ æ— æƒé™æ§åˆ¶
âŒ æ€§èƒ½é—®é¢˜ï¼ˆå…¨é‡åŠ è½½ï¼‰
```

### **5.2 å¢å¼ºçš„Webç®¡ç†ç•Œé¢**

#### **æ–°ç‰ˆç®¡ç†åå°æ¶æ„**
```python
# admin_enhanced.py - å¢å¼ºçš„ç®¡ç†åå°
from flask import Flask, render_template, request, jsonify, session
from datetime import datetime, timedelta
import math

class EnhancedAdminPanel:
    """å¢å¼ºçš„ç®¡ç†åå°"""
    
    def __init__(self, db):
        self.users = db["users"]
        self.login_logs = db["loginLogs"]
        self.admin_logs = db["adminLogs"]
        self.page_size = 20  # åˆ†é¡µå¤§å°
    
    def get_dashboard_data(self):
        """è·å–ä»ªè¡¨æ¿æ•°æ®"""
        try:
            # åŸºç¡€ç»Ÿè®¡
            total_users = self.users.count_documents({})
            active_users = self.users.count_documents({"account.status.code": 1})
            online_users = self.users.count_documents({"device.isOnline": True})
            
            # ä»Šæ—¥ç™»å½•ç»Ÿè®¡
            today = datetime.now().replace(hour=0, minute=0, second=0, microsecond=0)
            today_logins = self.login_logs.count_documents({
                "loginTime": {"$gte": today},
                "loginResult": "success"
            })
            
            # è®¾å¤‡ç»‘å®šç»Ÿè®¡
            bound_devices = self.users.count_documents({"device.machineCode": {"$exists": True, "$ne": None}})
            
            # ç§¯åˆ†ç»Ÿè®¡
            pipeline = [
                {"$group": {
                    "_id": None,
                    "totalPoints": {"$sum": "$account.points"},
                    "avgPoints": {"$avg": "$account.points"}
                }}
            ]
            points_stats = list(self.users.aggregate(pipeline))
            total_points = points_stats[0]["totalPoints"] if points_stats else 0
            avg_points = points_stats[0]["avgPoints"] if points_stats else 0
            
            # æœ€è¿‘7å¤©ç™»å½•è¶‹åŠ¿
            login_trend = self._get_login_trend(7)
            
            return {
                "summary": {
                    "totalUsers": total_users,
                    "activeUsers": active_users,
                    "onlineUsers": online_users,
                    "todayLogins": today_logins,
                    "boundDevices": bound_devices,
                    "totalPoints": int(total_points),
                    "avgPoints": round(avg_points, 1)
                },
                "trends": {
                    "loginTrend": login_trend
                }
            }
            
        except Exception as e:
            print(f"è·å–ä»ªè¡¨æ¿æ•°æ®å¤±è´¥: {e}")
            return {"summary": {}, "trends": {}}
    
    def get_users_paginated(self, page=1, search="", status_filter="all", sort_by="created", sort_order="desc"):
        """åˆ†é¡µè·å–ç”¨æˆ·åˆ—è¡¨"""
        try:
            # æ„å»ºæŸ¥è¯¢æ¡ä»¶
            query = {}
            
            # æœç´¢æ¡ä»¶
            if search:
                query["$or"] = [
                    {"phone": {"$regex": search, "$options": "i"}},
                    {"profile.displayName": {"$regex": search, "$options": "i"}}
                ]
            
            # çŠ¶æ€ç­›é€‰
            if status_filter != "all":
                if status_filter == "active":
                    query["account.status.code"] = 1
                elif status_filter == "disabled":
                    query["account.status.code"] = 0
                elif status_filter == "online":
                    query["device.isOnline"] = True
                elif status_filter == "unbound":
                    query["device.machineCode"] = {"$exists": False}
            
            # æ’åº
            sort_field = {
                "created": "metadata.createdAt",
                "login": "device.lastLoginTime",
                "points": "account.points",
                "phone": "phone"
            }.get(sort_by, "metadata.createdAt")
            
            sort_direction = -1 if sort_order == "desc" else 1
            
            # åˆ†é¡µè®¡ç®—
            skip = (page - 1) * self.page_size
            
            # æŸ¥è¯¢æ•°æ®
            total = self.users.count_documents(query)
            users = list(self.users.find(query)
                        .sort(sort_field, sort_direction)
                        .skip(skip)
                        .limit(self.page_size))
            
            # æ ¼å¼åŒ–ç”¨æˆ·æ•°æ®
            formatted_users = []
            for user in users:
                formatted_users.append({
                    "userId": str(user["_id"]),
                    "phone": user["phone"],
                    "displayName": user.get("profile", {}).get("displayName", f"ç”¨æˆ·{user['phone']}"),
                    "points": user.get("account", {}).get("points", 0),
                    "status": user.get("account", {}).get("status", {"code": 1, "text": "æ­£å¸¸"}),
                    "machineCode": user.get("device", {}).get("machineCode"),
                    "deviceInfo": user.get("device", {}).get("deviceInfo", {}),
                    "lastLoginTime": user.get("device", {}).get("lastLoginTime"),
                    "loginCount": user.get("device", {}).get("loginCount", 0),
                    "isOnline": user.get("device", {}).get("isOnline", False),
                    "createdAt": user.get("metadata", {}).get("createdAt")
                })
            
            # åˆ†é¡µä¿¡æ¯
            total_pages = math.ceil(total / self.page_size)
            
            return {
                "users": formatted_users,
                "pagination": {
                    "currentPage": page,
                    "totalPages": total_pages,
                    "totalUsers": total,
                    "pageSize": self.page_size,
                    "hasNext": page < total_pages,
                    "hasPrev": page > 1
                }
            }
            
        except Exception as e:
            print(f"è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥: {e}")
            return {"users": [], "pagination": {}}
    
    def get_user_detail(self, phone):
        """è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯"""
        try:
            user = self.users.find_one({"phone": phone})
            if not user:
                return {"success": False, "message": "ç”¨æˆ·ä¸å­˜åœ¨"}
            
            # è·å–ç”¨æˆ·ç™»å½•å†å²
            login_history = list(self.login_logs.find({"phone": phone})
                               .sort("loginTime", -1)
                               .limit(10))
            
            return {
                "success": True,
                "user": {
                    "userId": str(user["_id"]),
                    "phone": user["phone"],
                    "profile": user.get("profile", {}),
                    "account": user.get("account", {}),
                    "device": user.get("device", {}),
                    "security": user.get("security", {}),
                    "metadata": user.get("metadata", {})
                },
                "loginHistory": login_history
            }
            
        except Exception as e:
            print(f"è·å–ç”¨æˆ·è¯¦æƒ…å¤±è´¥: {e}")
            return {"success": False, "message": f"è·å–å¤±è´¥: {str(e)}"}
    
    def _get_login_trend(self, days):
        """è·å–ç™»å½•è¶‹åŠ¿æ•°æ®"""
        try:
            end_date = datetime.now().replace(hour=23, minute=59, second=59, microsecond=999999)
            start_date = end_date - timedelta(days=days-1)
            start_date = start_date.replace(hour=0, minute=0, second=0, microsecond=0)
            
            pipeline = [
                {
                    "$match": {
                        "loginTime": {"$gte": start_date, "$lte": end_date},
                        "loginResult": "success"
                    }
                },
                {
                    "$group": {
                        "_id": {
                            "$dateToString": {
                                "format": "%Y-%m-%d",
                                "date": "$loginTime"
                            }
                        },
                        "count": {"$sum": 1},
                        "uniqueUsers": {"$addToSet": "$phone"}
                    }
                },
                {
                    "$project": {
                        "date": "$_id",
                        "logins": "$count",
                        "uniqueUsers": {"$size": "$uniqueUsers"}
                    }
                },
                {"$sort": {"date": 1}}
            ]
            
            results = list(self.login_logs.aggregate(pipeline))
            
            # å¡«å……ç¼ºå¤±çš„æ—¥æœŸ
            trend_data = []
            current_date = start_date
            
            for i in range(days):
                date_str = current_date.strftime("%Y-%m-%d")
                found = next((r for r in results if r["date"] == date_str), None)
                
                trend_data.append({
                    "date": date_str,
                    "logins": found["logins"] if found else 0,
                    "uniqueUsers": found["uniqueUsers"] if found else 0
                })
                
                current_date += timedelta(days=1)
            
            return trend_data
            
        except Exception as e:
            print(f"è·å–ç™»å½•è¶‹åŠ¿å¤±è´¥: {e}")
            return []

# Flaskè·¯ç”±é›†æˆ
admin_panel = EnhancedAdminPanel(auth_api.db)

@app.route("/admin/v2")
def admin_dashboard_v2():
    """æ–°ç‰ˆç®¡ç†åå°é¦–é¡µ"""
    dashboard_data = admin_panel.get_dashboard_data()
    return render_template("admin_dashboard_v2.html", data=dashboard_data)

@app.route("/admin/v2/users")
def admin_users_v2():
    """ç”¨æˆ·ç®¡ç†é¡µé¢"""
    page = int(request.args.get("page", 1))
    search = request.args.get("search", "")
    status_filter = request.args.get("status", "all")
    sort_by = request.args.get("sort", "created")
    sort_order = request.args.get("order", "desc")
    
    users_data = admin_panel.get_users_paginated(page, search, status_filter, sort_by, sort_order)
    return render_template("admin_users_v2.html", **users_data)

@app.route("/admin/v2/api/user/<phone>")
def admin_user_detail_api(phone):
    """ç”¨æˆ·è¯¦æƒ…API"""
    return jsonify(admin_panel.get_user_detail(phone))
```

### **5.3 è®¾å¤‡ç®¡ç†åŠŸèƒ½**

#### **è®¾å¤‡ç®¡ç†API**
```python
class DeviceManagementPanel:
    """è®¾å¤‡ç®¡ç†é¢æ¿"""
    
    def __init__(self, db):
        self.users = db["users"]
        self.admin_logs = db["adminLogs"]
    
    def get_device_list(self, page=1, search=""):
        """è·å–è®¾å¤‡åˆ—è¡¨"""
        try:
            query = {"device.machineCode": {"$exists": True, "$ne": None}}
            
            if search:
                query["$or"] = [
                    {"phone": {"$regex": search, "$options": "i"}},
                    {"device.machineCode": {"$regex": search, "$options": "i"}},
                    {"device.deviceInfo.hostname": {"$regex": search, "$options": "i"}}
                ]
            
            skip = (page - 1) * 20
            total = self.users.count_documents(query)
            devices = list(self.users.find(query)
                          .sort("device.lastLoginTime", -1)
                          .skip(skip)
                          .limit(20))
            
            formatted_devices = []
            for device in devices:
                device_info = device.get("device", {})
                formatted_devices.append({
                    "phone": device["phone"],
                    "displayName": device.get("profile", {}).get("displayName", f"ç”¨æˆ·{device['phone']}"),
                    "machineCode": device_info.get("machineCode"),
                    "deviceInfo": device_info.get("deviceInfo", {}),
                    "bindTime": device_info.get("bindTime"),
                    "lastLoginTime": device_info.get("lastLoginTime"),
                    "loginCount": device_info.get("loginCount", 0),
                    "isOnline": device_info.get("isOnline", False),
                    "status": device.get("account", {}).get("status", {"code": 1, "text": "æ­£å¸¸"})
                })
            
            return {
                "devices": formatted_devices,
                "pagination": {
                    "currentPage": page,
                    "totalPages": math.ceil(total / 20),
                    "totalDevices": total
                }
            }
            
        except Exception as e:
            print(f"è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥: {e}")
            return {"devices": [], "pagination": {}}
    
    def unbind_device(self, phone, admin_user, reason="ç®¡ç†å‘˜æ“ä½œ"):
        """è§£ç»‘è®¾å¤‡"""
        try:
            result = self.users.update_one(
                {"phone": phone},
                {
                    "$unset": {"device.machineCode": ""},
                    "$set": {
                        "device.unbindTime": datetime.now(),
                        "device.unbindReason": reason,
                        "device.unbindBy": admin_user,
                        "device.isOnline": False,
                        "metadata.updatedAt": datetime.now()
                    }
                }
            )
            
            if result.modified_count > 0:
                # è®°å½•ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
                self._log_admin_action(admin_user, "unbind_device", phone, reason)
                return {"success": True, "message": "è®¾å¤‡è§£ç»‘æˆåŠŸ"}
            else:
                return {"success": False, "message": "ç”¨æˆ·ä¸å­˜åœ¨æˆ–è®¾å¤‡æœªç»‘å®š"}
                
        except Exception as e:
            return {"success": False, "message": f"è§£ç»‘å¤±è´¥: {str(e)}"}
    
    def force_offline(self, phone, admin_user, reason="ç®¡ç†å‘˜å¼ºåˆ¶ä¸‹çº¿"):
        """å¼ºåˆ¶ç”¨æˆ·ä¸‹çº¿"""
        try:
            result = self.users.update_one(
                {"phone": phone},
                {
                    "$set": {
                        "device.isOnline": False,
                        "device.forceOfflineTime": datetime.now(),
                        "device.forceOfflineReason": reason,
                        "device.forceOfflineBy": admin_user,
                        "metadata.updatedAt": datetime.now()
                    }
                }
            )
            
            if result.modified_count > 0:
                self._log_admin_action(admin_user, "force_offline", phone, reason)
                return {"success": True, "message": "ç”¨æˆ·å·²å¼ºåˆ¶ä¸‹çº¿"}
            else:
                return {"success": False, "message": "ç”¨æˆ·ä¸å­˜åœ¨"}
                
        except Exception as e:
            return {"success": False, "message": f"å¼ºåˆ¶ä¸‹çº¿å¤±è´¥: {str(e)}"}
    
    def _log_admin_action(self, admin_user, action, target, reason):
        """è®°å½•ç®¡ç†å‘˜æ“ä½œæ—¥å¿—"""
        try:
            log_entry = {
                "adminUser": admin_user,
                "action": action,
                "target": target,
                "reason": reason,
                "timestamp": datetime.now(),
                "ip": request.environ.get('REMOTE_ADDR', 'Unknown')
            }
            self.admin_logs.insert_one(log_entry)
        except Exception as e:
            print(f"è®°å½•ç®¡ç†å‘˜æ—¥å¿—å¤±è´¥: {e}")

# Flaskè·¯ç”±
device_panel = DeviceManagementPanel(auth_api.db)

@app.route("/admin/v2/devices")
def admin_devices():
    """è®¾å¤‡ç®¡ç†é¡µé¢"""
    page = int(request.args.get("page", 1))
    search = request.args.get("search", "")
    devices_data = device_panel.get_device_list(page, search)
    return render_template("admin_devices.html", **devices_data)

@app.route("/admin/v2/api/device/unbind", methods=["POST"])
def admin_unbind_device():
    """è§£ç»‘è®¾å¤‡API"""
    data = request.json
    phone = data.get("phone")
    reason = data.get("reason", "ç®¡ç†å‘˜æ“ä½œ")
    admin_user = session.get("admin_user", "unknown")
    
    return jsonify(device_panel.unbind_device(phone, admin_user, reason))
```
