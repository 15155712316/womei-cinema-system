# PyQt5电影票务管理系统 - 打包部署指南

## 📋 目录
1. [打包准备](#打包准备)
2. [环境要求](#环境要求)
3. [打包步骤](#打包步骤)
4. [测试验证](#测试验证)
5. [部署分发](#部署分发)
6. [故障排除](#故障排除)

---

## 🛠️ 打包准备

### 1. 开发环境要求

**操作系统**：Windows 10/11 64位
**Python版本**：Python 3.8+ (推荐3.10)
**开发工具**：任意Python IDE或命令行

### 2. 检查项目完整性

在开始打包前，确保项目包含以下文件：

```
项目根目录/
├── main_modular.py          # 主程序入口
├── requirements.txt         # 依赖列表
├── data/                    # 数据目录
│   ├── config.json         # 配置文件
│   ├── cinema_info.json    # 影院信息
│   └── accounts.json       # 账号信息
├── ui/                     # 界面模块
├── services/               # 服务模块
├── utils/                  # 工具模块
├── controllers/            # 控制器模块
├── views/                  # 视图模块
└── widgets/                # 组件模块
```

---

## 💻 环境要求

### 打包环境

- **Windows 10/11 64位**
- **Python 3.8+**
- **足够的磁盘空间**（至少2GB）
- **稳定的网络连接**（下载依赖）

### 目标环境

- **Windows 10/11 64位**
- **4GB+ RAM**
- **500MB+ 可用磁盘空间**
- **网络连接**（访问API服务器）

---

## 🚀 打包步骤

### 第一步：安装打包依赖

```bash
# 运行依赖安装脚本
python install_dependencies.py
```

或手动安装：
```bash
pip install PyInstaller==5.13.2
pip install PyQt5==5.15.9
pip install requests==2.31.0
pip install Pillow==10.0.1
pip install pywin32==306
pip install qrcode==7.4.2
```

### 第二步：环境检查

```bash
# 运行环境检查脚本
python pre_build_check.py
```

确保所有检查项都通过：
- ✅ Python版本
- ✅ 必需包
- ✅ 项目结构
- ✅ 数据文件
- ✅ 模块导入
- ✅ 机器码一致性
- ✅ 构建信息

### 第三步：执行打包

```bash
# 运行打包脚本
python build_exe.py
```

打包过程包括：
1. 检查依赖
2. 清理构建目录
3. 创建PyInstaller配置
4. 构建可执行文件
5. 复制额外文件
6. 创建安装脚本

### 第四步：验证打包结果

```bash
# 运行测试脚本
python test_packaged_app.py
```

检查项目：
- ✅ 可执行文件存在
- ✅ 数据文件完整
- ✅ 程序能正常启动
- ✅ 网络连接正常
- ✅ 文件权限正确

---

## 🧪 测试验证

### 本地测试

1. **基本功能测试**
   ```bash
   cd dist
   CinemaTicketSystem.exe
   ```

2. **登录功能测试**
   - 启动程序
   - 查看机器码显示
   - 测试登录界面

3. **网络连接测试**
   - 确认能连接到服务器
   - 测试API接口调用

### 干净环境测试

1. **准备测试环境**
   - 使用没有Python的Windows电脑
   - 或使用虚拟机

2. **复制程序文件**
   ```
   将整个dist目录复制到测试电脑
   ```

3. **运行测试**
   ```bash
   # 直接运行
   CinemaTicketSystem.exe
   
   # 或使用安装脚本
   install.bat
   ```

4. **功能验证**
   - 程序启动正常
   - 界面显示完整
   - 登录功能正常
   - 网络连接正常

---

## 📦 部署分发

### 文件结构

打包完成后的文件结构：
```
dist/
├── CinemaTicketSystem.exe    # 主程序
├── install.bat               # 安装脚本
├── data/                     # 数据目录
│   ├── config.json
│   ├── cinema_info.json
│   └── accounts.json
├── README.md                 # 说明文档
├── requirements.txt          # 依赖列表
└── 使用说明.md              # 使用手册
```

### 分发方式

#### 方式一：压缩包分发

1. **创建压缩包**
   ```
   将dist目录压缩为zip文件
   命名：CinemaTicketSystem_v1.0.0.zip
   ```

2. **分发说明**
   - 解压到任意目录
   - 运行install.bat安装
   - 或直接运行CinemaTicketSystem.exe

#### 方式二：安装包制作

使用NSIS或Inno Setup制作专业安装包：

1. **下载NSIS**：https://nsis.sourceforge.io/
2. **创建安装脚本**
3. **生成安装包**

#### 方式三：便携版

1. **创建便携版目录**
   ```
   CinemaTicketSystem_Portable/
   ├── CinemaTicketSystem.exe
   ├── data/
   └── 使用说明.md
   ```

2. **使用说明**
   - 无需安装
   - 直接运行exe文件
   - 数据保存在同目录

---

## 🔧 故障排除

### 打包失败

**问题**：PyInstaller打包失败

**解决方案**：
1. 检查Python版本兼容性
2. 确认所有依赖已安装
3. 清理缓存重新打包：
   ```bash
   rmdir /s build dist
   del *.spec
   python build_exe.py
   ```

### 程序无法启动

**问题**：打包后程序无法启动

**解决方案**：
1. 检查目标系统兼容性
2. 确认所有DLL文件已包含
3. 以管理员身份运行
4. 检查杀毒软件是否误杀

### 缺少依赖

**问题**：提示缺少模块或DLL

**解决方案**：
1. 修改build_exe.py中的hiddenimports
2. 手动复制缺少的文件到dist目录
3. 使用--collect-all参数重新打包

### 文件过大

**问题**：生成的exe文件过大

**解决方案**：
1. 使用--exclude-module排除不需要的模块
2. 启用UPX压缩
3. 分离数据文件

### 运行时错误

**问题**：程序运行时报错

**解决方案**：
1. 检查相对路径问题
2. 确认数据文件路径正确
3. 添加异常处理
4. 查看错误日志

---

## 📊 性能优化

### 启动速度优化

1. **减少导入模块**
   - 延迟导入非必需模块
   - 使用条件导入

2. **优化资源加载**
   - 压缩图片资源
   - 延迟加载大文件

### 文件大小优化

1. **排除不需要的模块**
   ```python
   excludes=[
       'matplotlib', 'numpy', 'pandas',
       'jupyter', 'pytest', 'unittest'
   ]
   ```

2. **启用压缩**
   ```python
   upx=True
   ```

### 内存使用优化

1. **及时释放资源**
2. **避免内存泄漏**
3. **优化数据结构**

---

## 📝 版本管理

### 版本号规则

使用语义化版本号：`主版本.次版本.修订版本`

- **主版本**：不兼容的API修改
- **次版本**：向下兼容的功能性新增
- **修订版本**：向下兼容的问题修正

### 发布流程

1. **代码测试**：确保所有功能正常
2. **版本标记**：更新版本号
3. **打包构建**：生成发布版本
4. **测试验证**：在目标环境测试
5. **发布分发**：提供下载链接

### 更新机制

1. **检查更新**：程序启动时检查新版本
2. **下载更新**：提供更新下载链接
3. **安装更新**：覆盖安装或增量更新

---

## 📞 技术支持

### 打包问题咨询

**邮箱**：build-support@cinema-system.com
**QQ群**：123456789
**工作时间**：周一至周五 9:00-18:00

### 常见问题

1. **Q**: 打包后程序很大怎么办？
   **A**: 使用排除模块和UPX压缩

2. **Q**: 在某些电脑上无法运行？
   **A**: 检查系统兼容性和依赖库

3. **Q**: 如何制作自动更新？
   **A**: 实现版本检查和文件下载功能

---

*本指南最后更新时间：2024年12月*
